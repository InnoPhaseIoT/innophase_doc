<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watchdog Timer &mdash; InnoPhase 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="../../_static/js/custom.js" defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            InnoPhase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Watchdog Timer</a></li>
<li><a class="reference internal" href="#sample-code-walkthrough">Sample Code Walkthrough</a><ul>
<li><a class="reference internal" href="#running-the-application">Running the Application</a></li>
<li><a class="reference internal" href="#expected-output">Expected Output</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">InnoPhase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Watchdog Timer</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/6. Applications/2. Examples/Example_using_Watchdog_Timer.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>This application note describes managing the Talaria TWO watchdog timer
using the functions provided by the watchdog driver.</p>
<section id="watchdog-timer">
<h1>Watchdog Timer<a class="headerlink" href="#watchdog-timer" title="Link to this heading"></a></h1>
<p>The watchdog driver provides functions for managing the Talaria TWO
watchdog timer.</p>
<p>It is a down-counting timer that generates a system reset (or an
interrupt) when the counter reaches zero. The timer is started with an
application specific timeout via the watchdog_init() and
watchdog_start() functions. The client application uses the
watchdog_kick() function to periodically reload the counter to its
initial value to avoid it counting to zero.</p>
<p>Depending on what the application wants to supervise using this
watchdog, the watchdog_kick() may be performed from contexts. If the
goal is to make sure that a certain real-time response time is required
on a particular thread priority level, a dedicated thread on this
priority level should kick the watchdog. Failure to meet the real-time
response will then lead to a system reset. Another use case is to
supervise on interrupt level. In this case, the watchdog should be
kicked from an interrupt service handler on a timer interrupt that is
scheduled at an interval slightly lower than the watchdog timeout.</p>
</section>
<section id="sample-code-walkthrough">
<h1>Sample Code Walkthrough<a class="headerlink" href="#sample-code-walkthrough" title="Link to this heading"></a></h1>
<p>The sample application provides functions for managing the Talaria TWO
watchdog timer.</p>
<p><strong>wdreset.c</strong></p>
<p>The callout_init()function initiates the callout object. wakeup callout
is used to schedule a wakeup from suspend state.
xSemaphoreCreateCounting(1, 0) initiates the semaphore with a default
value of 0. watchdog_init initializes the watchdog with the specified
timeout in microseconds and the watchdog expire_cb is passed as NULL,
resulting in a system reset at timer expiration. The watchdog_start()
function starts the watchdog counter.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>callout_init(&amp;wakeup, wakeup_callback);</p>
<p>wakeup_event = xSemaphoreCreateCounting(1, 0);</p>
<p>watchdog_init(WATCHDOG_TIMEOUT, NULL);</p>
<p>watchdog_start();</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>callout_init_soft()initializes callout object with a soft deadline.
kicker callout is used to kick the watchdog to reload the counter to its
initial value to avoid the counter value reaching zero. A soft callout
timeout accepts the timeout to be invoked later than requested if this
could lead to savings in power consumption. The
callout_schedule()schedules the callback function to be invoked after
the specified number of microseconds. Application needs to kick the
watchdog before it expires, hence the timeout is given as
WATCHDOG_TIMEOUT * 9 / 10.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>callout_init_soft(&amp;kicker, kick_the_dog);</p>
<p>callout_schedule(&amp;kicker, WATCHDOG_TIMEOUT * 9 / 10);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Talaria TWO is put to suspend mode to demonstrate that the watchdog
works fine both in suspend mode and awake mode. After enabling the
suspend mode, wakeup callout is scheduled after two seconds. Then the
thread suspends on a wakeup_event semaphore. Since there is no other
activity scheduled at this point, the system enters suspend mode.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>os_suspend_enable();</p>
<p>callout_schedule(&amp;wakeup, SYSTIME_SEC(2));</p>
<p>os_printf(“Sleeping\n”);</p>
<p>if (xSemaphoreTake(wakeup_event, portMAX_DELAY) == pdFAIL) {</p>
<p>os_printf(“Unable to wait on semaphore…!!\n”);</p>
<p>return -1;</p>
<p>}</p>
<p>os_printf(“Awake\n”);</p>
<p>os_suspend_disable();</p>
<p>vTaskDelay(4000);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>This callback function of wakeup callout wakes the system up from
suspend state and posts the semaphore for which the main thread was
waiting before going to suspend mode.</p>
<p><strong>Note</strong>: wakeup_callback is executed from ISR context, hence the
SemaphoreGiveFromISR() is used.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void</p>
<p>wakeup_callback(struct callout *c)</p>
<p>{ xSemaphoreGiveFromISR(wakeup_event, NULL); }</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>This callback function of kicker callout kicks the watchdog.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void</p>
<p>kick_the_dog(struct callout *c)</p>
<p>{</p>
<p>static uint32_t num_kicks;</p>
<p>os_printf(“Kick\n”);</p>
<p>watchdog_kick();</p>
<p>if (++num_kicks &lt; 30)</p>
<p>callout_schedule(c, WATCHDOG_TIMEOUT * 9 / 10);</p>
<p>else</p>
<p>os_printf(“Last kick\n”);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Here, kick_the_dog()function calls watchdog_kick()before the watchdog
timer expires.</p>
<p>Every time watchdog_kick() is called, it resets the watchdog timer which
is set using watchdog_init(). After the 30th call of watchdog_kick(),
this callback is not scheduled and thus the watchdog timer expires,
resulting in system reset.</p>
<p>System reset occurs because the watchdog_init() was called with
expire_cb passed as NULL.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>watchdog_init(WATCHDOG_TIMEOUT, NULL);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<section id="running-the-application">
<h2>Running the Application<a class="headerlink" href="#running-the-application" title="Link to this heading"></a></h2>
<p>Program wdreset.elf (<em>freertos_sdk_x.y\examples\watchdog_timer\bin</em>)
using the Download tool:</p>
<ol class="arabic simple">
<li><p>Launch the Download tool provided with InnoPhase Talaria TWO SDK.</p></li>
<li><p>In the GUI window:</p>
<ol class="loweralpha simple">
<li><p>Boot Target: Select the appropriate EVK from the drop-down.</p></li>
<li><p>ELF Input: Load the wdreset.elf by clicking on Select ELF File.</p></li>
<li><p>Programming: Prog RAM or Prog Flash as per requirement.</p></li>
</ol>
</li>
</ol>
<p><strong>Note</strong>: Post 30<sup>th</sup> call of the watchdog_kick()function, the
watchdog timer expires</p>
<ol class="loweralpha simple">
<li><p>Prog RAM: After reset, wdreset.elf halts</p></li>
<li><p>Prog Flash: After reset, wdreset.elf runs in a loop</p></li>
</ol>
</section>
<section id="expected-output">
<h2>Expected Output<a class="headerlink" href="#expected-output" title="Link to this heading"></a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Build $Id: git-df9b9ef $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0051-002a-ffffffffffff</p>
<p>$App:git-6818774</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>Watchdog Reset Demo App</p>
<p>Starting watchdog</p>
<p>Sleeping</p>
<p>Kick</p>
<p>Kick</p>
<p>Awake</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Sleeping</p>
<p>Kick</p>
<p>Awake</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Sleeping</p>
<p>Kick</p>
<p>Awake</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Sleeping</p>
<p>Kick</p>
<p>Awake</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Sleeping</p>
<p>Kick</p>
<p>Awake</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Sleeping</p>
<p>Kick</p>
<p>Awake</p>
<p>Kick</p>
<p>Kick</p>
<p>Kick</p>
<p>Last kick</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 InnoPhase IoT, Inc. | All Rights Reserved | Proprietary &amp; Confidential.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>