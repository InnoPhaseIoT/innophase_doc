<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Second Stage Boot Loader &mdash; InnoPhase 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Firmware Over The Air" href="5.%20Firmware_Over-The-Air-Upgrade.html" />
    <link rel="prev" title="IoT AWS" href="3.%20IoT_AWS.html" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="../../_static/js/custom.js" defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            InnoPhase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Getting%20Started/Getting%20Started%20-%20Landing%20Page.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware%20Reference/Hardware-Reference.html">Hardware-Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Porting%20Guide/Porting-Guide.html">Porting-Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Disclaimers/Disclaimers.html">Disclaimer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Appendix/Appendix-Landing_Page.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Support/Support.html">Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Software%20Reference/Software_Reference_Landing_Page.html">Software Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Development%20Environments/Development%20Environments%20-%20Landing%20Page.html">Development Environments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Tools/Tools-landing%20page.html">Tools</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html">Applications</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#apps">Apps</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1.%20Alexa_Ready_Application_with_AWS_IoT_Embedded_C_Device_SDK.html">Alexa_Ready_Application_with_AWS_IoT_Embedded_C_Device_SDK</a></li>
<li class="toctree-l3"><a class="reference internal" href="2.%20Alarm.html">Alarm</a></li>
<li class="toctree-l3"><a class="reference internal" href="3.%20IoT_AWS.html">IoT AWS</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Second Stage Boot Loader</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#description-of-operation">Description of Operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#memory-layout">Memory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flash-layout">Flash Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssbl-operation-flow">SSBL Operation Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-secure-ssbl">Non-Secure SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secureboot-ssbl">Secureboot SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssbl-configuration">SSBL Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ssbl-boot-arguments">SSBL Boot Arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-components">Building Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-file-system-root-img-file">Creating File System (root.img) file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-secure-ssbl-1">Non-secure SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secureboot-ssbl-1">Secureboot SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-ssbl">Building SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-secure-ssbl-2">Non-secure SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secureboot-ssbl-2">Secureboot SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flashing-components">Flashing Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-secure-ssbl-3">Non-secure SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flashing">Flashing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expected-output">Expected Output</a></li>
<li class="toctree-l4"><a class="reference internal" href="#changing-root-img-to-run-the-other-application">Changing root.img to Run the Other Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secure-ssbl">Secure SSBL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flashing-1">Flashing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expected-output-1">Expected Output</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="5.%20Firmware_Over-The-Air-Upgrade.html">Firmware Over The Air</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#examples">Examples</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Regulatory%20Notices/Regulatory%20Notices.html">FCC/ISED Regulatory Notices</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Security/Security%20-%20Landing%20Page.html">Security</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">InnoPhase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Applications%20-%20Landing%20Page.html">Applications</a></li>
      <li class="breadcrumb-item active">Second Stage Boot Loader</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Applications/1. Apps/4. SSBL.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="second-stage-boot-loader">
<h1>Second Stage Boot Loader<a class="headerlink" href="#second-stage-boot-loader" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>The Second Stage Boot Loader (SSBL) is a part of firmware that can be
installed in Talaria TWO to enhance the flexibility of booting the
applications on the device. SSBL enables the following features on
Talaria TWO:</p>
<ol class="arabic simple">
<li><p>Selective boot of one of the applications loaded into flash.</p></li>
<li><p>Over the Air (OTA) update of applications (requires additional OTA
application).</p></li>
</ol>
<p>SSBL can be built with secureboot which provides a secure way of loading
encrypted and signed applications. This prevents loading of unauthorized
applications and performing a flash readout of application contents.</p>
<section id="description-of-operation">
<h2>Description of Operation<a class="headerlink" href="#description-of-operation" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The Second Stage Boot Loader (SSBL) is a special application written
onto Talaria TWO‚Äôs flash. On boot-up, the primary bootloader loads &amp;
starts SSBL. SSBL reads the image index from the boot.json file, parses
the part.json file and picks the image information from the array index
read from boot.json file. SSBL then loads the image from the sector
mentioned in part.json onto RAM. Applications supported by SSBL are
stripped ELF files written to flash memory.</p>
<p>In case of secureboot mode, the configuration files are encrypted.</p>
<p>The memory layout mentioned in section 5.1 is for the RAM, where the
SSBL and the application triggered by SSBL are loaded onto the memory
for execution. Section 5.2 explains the flash layout where SSBL and
multiple applications can be stored in flash.</p>
</section>
<section id="memory-layout">
<h2>Memory Layout<a class="headerlink" href="#memory-layout" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Figure 1 shows the memory layout when using SSBL.</p>
<p>Figure 1: Memory layout on loading the SSBL application</p>
<ol class="arabic simple">
<li><p>There is a total of 512KB RAM in Talaria TWO</p>
<ol class="loweralpha simple">
<li><p>The RAM starts at 0x40000 and ends at 0xc0000.</p></li>
</ol>
</li>
<li><p>User Application area</p>
<ol class="loweralpha simple">
<li><p>Starts at 0x42000 to 0x90000.</p></li>
<li><p>Contains application .text, .data and.bss sections.</p></li>
</ol>
</li>
<li><p>Bootargs</p>
<ol class="loweralpha simple">
<li><p>The memory location for bootargs is at 0xbfffc and it grows
backwards.</p></li>
</ol>
</li>
<li><p>SSBL area</p>
<ol class="loweralpha simple">
<li><p>Starts at 0x90000.</p></li>
</ol>
</li>
</ol>
<p>Figure 2: Memory layout after loading the application</p>
<p>Figure 3 shows the signed and encrypted ELF memory layout when using
SSBL in secureboot mode.</p>
<p><a class="reference internal" href="../../_images/image17.png"><img alt="A picture containing diagram Description automatically generated" src="../../_images/image17.png" style="width: 6.29921in; height: 1.27297in;" /></a></p>
<p>Figure : Signed and encrypted ELF memory layout</p>
<ol class="arabic simple">
<li><p>In this case, only the .text and .data sections of the application
ELF are encrypted.</p></li>
<li><p>The .virt segment cannot be encrypted. Ensure no sensitive code is
placed in this section of the memory layout.</p></li>
<li><p>Code sections can be forced into .text by either specifying in the
linker script or by adding __ramcode in the function declaration.</p></li>
</ol>
<table class="docutils align-default" id="id8">
<caption><span class="caption-text">Table 1: SSBL Configuration Files</span><a class="headerlink" href="#id8" title="Permalink to this table">ÔÉÅ</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>int __ramcode</p>
<p>main(void)</p>
<p>{</p>
<p>‚Ä¶</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="flash-layout">
<h2>Flash Layout<a class="headerlink" href="#flash-layout" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Figure 4 shows the layout of flash memory when using the SSBL. To use
the SSBL, flash must contain at minimum the SSBL, the filesystem, and
one application.</p>
<p><a class="reference internal" href="../../_images/image22.png"><img alt="image1" src="../../_images/image22.png" style="width: 6.69291in; height: 0.71515in;" /></a></p>
<p>Figure 4: Flash layout when using the SSBL</p>
<p>Figure 5 shows the layout of flash memory when using secure SSBL.</p>
<p><a class="reference internal" href="../../_images/image32.png"><img alt="Text Description automatically generated with medium confidence" src="../../_images/image32.png" style="width: 6.69291in; height: 0.89239in;" /></a></p>
<p>Figure : Flash layout for SSBL with secureboot</p>
</section>
<section id="ssbl-operation-flow">
<h2>SSBL Operation Flow<a class="headerlink" href="#ssbl-operation-flow" title="Permalink to this heading">ÔÉÅ</a></h2>
</section>
<section id="non-secure-ssbl">
<h2>Non-Secure SSBL<a class="headerlink" href="#non-secure-ssbl" title="Permalink to this heading">ÔÉÅ</a></h2>
</section>
<section id="secureboot-ssbl">
<h2>Secureboot SSBL<a class="headerlink" href="#secureboot-ssbl" title="Permalink to this heading">ÔÉÅ</a></h2>
<p><a class="reference internal" href="../../_images/image42.png"><img alt="image2" src="../../_images/image42.png" style="width: 6.44792in; height: 4.05681in;" /></a></p>
<p>Figure : Secureboot SSBL Flow Diagram</p>
</section>
<section id="ssbl-configuration">
<h2>SSBL Configuration<a class="headerlink" href="#ssbl-configuration" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>SSBL is configured with JSON files present in the flash-based
filesystem. Table 1 provides a description of the relevant files and
their purpose. The contents of these files can be updated during
installation or by a running application to modify the behavior of SSBL.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>File</strong></p></th>
<th class="head"><p><strong>Purpose</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>part.json</p></td>
<td><ol class="arabic simple">
<li><p>Image table is a json array of applications‚Äô image
information. Each element in the image array gives
information like image name starting sector of the
elf, boot arguments and so on.</p></li>
<li><p>Application boot arguments</p></li>
<li><p>Additional SSBL options</p></li>
</ol>
</td>
</tr>
<tr class="row-odd"><td><p>boot.json</p></td>
<td><p>Json file stored in root/user FS. It contains the
image index. This is the index in the image
information array present in part.json file. SSBL
gets the index of the image to be loaded from this
file.</p></td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: For SSBL in secureboot mode, the configuration files are
encrypted.</p>
<p><strong>part.json</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><blockquote>
<div><p>{</p>
<p>‚Äúimage‚Äù : [</p>
<p>{</p>
<p>‚Äúname‚Äù : ‚Äúiperf_vm‚Äù,</p>
<p>‚Äúversion‚Äù : ‚Äú1.0‚Äù,</p>
<p>‚Äústart_sector‚Äù : 32,</p>
<p>‚Äúbootargs_start‚Äù: 1,</p>
<p>‚Äússid‚Äù : ‚Äúinnotest‚Äù,</p>
<p>‚Äúpassphrase‚Äù : ‚Äú123467890‚Äù,</p>
<p>‚Äúbootargs_end‚Äù : 1</p>
<p>},</p>
<p>{</p>
<p>‚Äúname‚Äù : ‚Äúhello_world‚Äù,</p>
<p>‚Äúversion‚Äù : ‚Äú1.0‚Äù,</p>
<p>‚Äústart_sector‚Äù : 232,</p>
<p>‚Äúbootargs_start‚Äù: 1,</p>
<p>‚Äússid‚Äù : ‚Äúinnotest‚Äù,</p>
<p>‚Äúpassphrase‚Äù : ‚Äú123467890‚Äù,</p>
<p>‚Äúbootargs_end‚Äù : 1</p>
<p>}</p>
<p>],</p>
<p>‚Äúbaudrate‚Äù : 2560000,</p>
<p>‚Äútimeout‚Äù : 0,</p>
<p>‚Äúverbose‚Äù : 1</p>
</div></blockquote>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple">
<li><p>General parameters:</p>
<ol class="loweralpha simple">
<li><p>baud ‚Äì baud rate used by SSBL when using hio</p></li>
<li><p>timeout ‚Äì timeout used by SSBL when using hio</p></li>
<li><p>verbose ‚Äì verbosity mode</p></li>
<li><p>image []: image information</p></li>
</ol>
</li>
<li><p>Image information:</p>
<ol class="loweralpha simple">
<li><p>name: name of application</p></li>
<li><p>version: version number of applications</p></li>
<li><p>sector: start sector of image in flash</p></li>
<li><p>bootargs_start: The following objects will be boot params</p></li>
<li><p>bootargs_end: end of boot arguments</p></li>
</ol>
</li>
</ol>
<p><strong>boot.json</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>boot.json</p>
<p>{ image : 0 }</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>where,</p>
<p>image ‚Äì The image to boot from part.json</p>
</section>
<section id="ssbl-boot-arguments">
<h2>SSBL Boot Arguments<a class="headerlink" href="#ssbl-boot-arguments" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>SSBL can pass boot arguments (bootargs) to an application by utilizing
the filesystem. SSBL reads the bootargs from the part.json file and
stores the bootargs at memory location 0xbfffc where it grows backwards.
The size occupied by the bootargs is dependent on the length and count
of the bootargs read from the filesystem. Figure 8 shows how they are
stored in memory.</p>
<p><a class="reference internal" href="../../_images/image52.png"><img alt="image3" src="../../_images/image52.png" style="width: 6.69291in; height: 1.06485in;" /></a></p>
<p>Figure 8: SSBL Bootargs stored in memory</p>
</section>
<section id="building-components">
<h2>Building Components<a class="headerlink" href="#building-components" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>This section describes building the required components for SSBL.</p>
</section>
<section id="creating-file-system-root-img-file">
<h2>Creating File System (root.img) file<a class="headerlink" href="#creating-file-system-root-img-file" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The root folder at &lt;freertos_sdk&gt;/root_fs contains the files which will
be put into the filesystem image to be flashed onto Talaria TWO. Before
building the filesystem image for the first time, the configuration
files need to be updated based on the applications to be loaded and the
users requirement for using SSBL (refer section 5.3.2).</p>
<p>Once the SSBL configuration files are updated, run the following
commands to build the filesystem image.</p>
</section>
<section id="non-secure-ssbl-1">
<span id="id1"></span><h2>Non-secure SSBL<a class="headerlink" href="#non-secure-ssbl-1" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>For non-secure SSBL, filesystem files come from &lt;freertos_sdk&gt;/root_fs
and the application‚Äôs &lt;app&gt;/fs directory. The path to the application
directory is provided in the following command, and the filesystem image
is generated as root.img.</p>
<p>For the purpose of this application note, the root.img is created at:
<em>freertos_sdk_x.y/apps/ssbl</em>.</p>
<p><strong>Note</strong>: x and y refer to the SDK release version.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>python3 ./script/build_rootfs_generic.py ‚Äìfolder_path apps/ssbl</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong></p>
<p>If there is no fs directory present in the application, then the files
from &lt;freertos_sdk&gt;/root_fs are taken into the filesystem image by
default.</p>
<p>If there are files with the same name present in application‚Äôs fs
directory and &lt;freertos_sdk&gt;/root_fs, then the files from application‚Äôs
fs are taken into the filesystem image.</p>
</section>
<section id="secureboot-ssbl-1">
<span id="id2"></span><h2>Secureboot SSBL<a class="headerlink" href="#secureboot-ssbl-1" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>For secureboot SSBL, filesystem files come from &lt;freertos_sdk&gt;/root_fs
and the application‚Äôs &lt;app&gt;/fs_secure directory. The path to the
application directory is provided in the following command, and the
filesystem image is generated as root_secure.img.</p>
<p>For the purpose of this application note, the secureboot SSBL is
demonstrated for the application example/secure_files.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;sdk&gt;</p>
<p>python3 ./script/build_rootfs_generic.py ‚Äìfolder_path
examples/secure_files/ ‚Äìsecure True ‚Äìkeyfile
./apps/ssbl/enroll.json</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong></p>
<p>If there is no fs_secure directory present in the application, then the
files from &lt;freertos_sdk&gt;/root_fs are taken into the filesystem image by
default.</p>
<p>If there are files with the same name present in application‚Äôs fs_secure
directory and &lt;freertos_sdk&gt;/root_fs, then the files from application‚Äôs
fs_secure are taken into the filesystem image.</p>
</section>
<section id="building-ssbl">
<h2>Building SSBL<a class="headerlink" href="#building-ssbl" title="Permalink to this heading">ÔÉÅ</a></h2>
</section>
<section id="non-secure-ssbl-2">
<span id="id3"></span><h2>Non-secure SSBL<a class="headerlink" href="#non-secure-ssbl-2" title="Permalink to this heading">ÔÉÅ</a></h2>
<blockquote>
<div><p>Create SSBL binary for non-secure usecase as: <em>apps/fast_ssbl.img</em>.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;/apps/ssbl/</p>
<p>make clean</p>
<p>make</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="secureboot-ssbl-2">
<span id="id4"></span><h2>Secureboot SSBL<a class="headerlink" href="#secureboot-ssbl-2" title="Permalink to this heading">ÔÉÅ</a></h2>
<ol class="arabic simple">
<li><p>For emulating/testing SecureSSBL in development, generate combined
‚ÄúFirst‚Äù application and SSBL.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;/apps/ssbl/</p>
<p>make clean</p>
<p>make KEY=enroll.json SECUREBOOT=1 DEBUGSECURE=1</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>This creates the SSBL binary for secureboot emulation usecase as -
<em>apps/ssbl/out/both.img</em></p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>For production:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;/apps/ssbl/</p>
<p>make clean</p>
<p>make KEY=enroll.json SECUREBOOT=1</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>This creates SSBL binary for secureboot production usecase as -
<em>apps/ssbl/out/ssbl_secure.img</em></p>
</div></blockquote>
</section>
<section id="flashing-components">
<h2>Flashing Components<a class="headerlink" href="#flashing-components" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>After the SSBL, filesystem, and applications have been built, follow the
instructions in this section to flash the components onto Talaria TWO.</p>
<p><strong>Note</strong>: If Talaria TWO has been flashed before, connect GPIO17 to
ground on the peripheral header of the EVK, then press and release reset
before following the instructions here. This will inhibit flash boot and
allow the flash helper to be loaded, provided the fuses have not already
been blown.</p>
</section>
<section id="non-secure-ssbl-3">
<span id="id5"></span><h2>Non-secure SSBL<a class="headerlink" href="#non-secure-ssbl-3" title="Permalink to this heading">ÔÉÅ</a></h2>
</section>
<section id="flashing">
<h2>Flashing<a class="headerlink" href="#flashing" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Before flashing Talaria TWO, ensure that an appropriate SSBL is
generated after executing a make clean, as instructed in section 6.2.</p>
<p>The following commands will write the SSBL and other components to
flash. Run the commands from the &lt;freertos_sdk&gt; directory:</p>
<p><strong>Load flash helper</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/boot.py ‚Äìdevice /dev/ttyUSB2 ‚Äìreset=evk42_bl
./apps/gordon.elf</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Invalidate the boot Image</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>dd if=/dev/zero of=./empty.img bs=1K count=1</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x1000 ./empty.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Write partition</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 from_json
./tools/partition_files/ssbl_part_table.json</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Flash SSBL</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x1000
./apps/ssbl/fast_ssbl.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Flash filesystem</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x180000
./apps/ssbl/root.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Flash apps</strong></p>
<p>For the purpose of this application note, the non-secure SSBL is
demonstrated for the applications <em>apps/hello-world</em> and <em>bins/iperf3</em>.
Applications supported by the SSBL are stripped ELF files written to
flash memory.</p>
<p>Use following commands to strip the application ELFs</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>arm-none-eabi-strip ‚Äìstrip-all ./bins/iperf3.elf -o
./bins/iperf3.elf.strip</p>
<p>arm-none-eabi-strip ‚Äìstrip-all
./apps/hello_world/bin/hello_world.elf -o
./apps/hello_world/bin/hello_world.elf.strip</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>iPerf3 should be flashed to 0x2000 (which is start_sector 32 as
mentioned in part.json), while hello_world.elf should be flashed to
0xE8000 (which is start_sector sector 232).</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x20000
./bins/iperf3.elf.strip</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0xE8000
./apps/hello_world/bin/hello_world.elf.strip</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Open miniterm at baud rate of 2457600 and reset the EVB.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference external" href="mailto:osboxes&#37;&#52;&#48;osboxes">osboxes<span>&#64;</span>osboxes</a>:~$ miniterm.py /dev/ttyUSB3 2457600</p>
<p>‚Äî Miniterm on /dev/ttyUSB3 2457600,8,N,1 ‚Äî</p>
<p>‚Äî Quit: Ctrl+] | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H
‚Äî</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Reset the board either by executing the following command or by pressing
the reset button on the EVB to run the iPerf3 application.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/boot.py ‚Äìdevice /dev/ttyUSB2 ‚Äìreset=evk42</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="expected-output">
<h2>Expected Output<a class="headerlink" href="#expected-output" title="Permalink to this heading">ÔÉÅ</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PWAEWWWWAE Build $Id: git-a74c874 $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0051-002a-ffffffffffff</p>
<p>Build $Id: git-a74c874 $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0051-002a-ffffffffffff</p>
<p>Bootargs: vm.flash_location=0x00034c00 sys.reset_reason=1
passphrase=1234567890 ssid=innotest</p>
<p>[0.024,055] rfdrv: unknown module type (0)</p>
<p>addr f8:e9:43:d2:00:e7</p>
<p>network profile created for ssid: innotest</p>
<p>[1.535,586] CONNECT:60:32:b1:33:b5:7b Channel:11 rssi:-37 dBm</p>
<p>[4.370,448] MYIP 192.168.0.107</p>
<p>[4.370,495] IPv6 [fe80::fae9:43ff:fed2:e7]-link</p>
<p>IPerf3 server &#64; 192.168.0.107</p>
<p>Iperf3 TCP/UDP server listening on 5201</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Run iPerf3 client for this application.</p>
<p><a class="reference internal" href="../../_images/image61.png"><img alt="image4" src="../../_images/image61.png" style="width: 6.49606in; height: 3.36403in;" /></a></p>
<p>Figure 9: iPerf3 Client</p>
</section>
<section id="changing-root-img-to-run-the-other-application">
<h2>Changing root.img to Run the Other Application<a class="headerlink" href="#changing-root-img-to-run-the-other-application" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>To run the hello_world application, make changes in
<em>&lt;sdk&gt;/root_fs/root/boot.json</em> to boot the image at index 1.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>boot.json</p>
<p>{ image : 1 }</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Execute the following command to regenerate the root.img at:
<em>&lt;sdk&gt;/apps/ssbl</em></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;sdk&gt;</p>
<p>python3 ./script/build_rootfs_generic.py ‚Äìfolder_path apps/ssbl</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Flash the newly generated root.img</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x180000
./apps/ssbl/root.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>On reboot, the hello_world application will be loaded.</p>
</section>
<section id="secure-ssbl">
<h2>Secure SSBL<a class="headerlink" href="#secure-ssbl" title="Permalink to this heading">ÔÉÅ</a></h2>
</section>
<section id="flashing-1">
<span id="id6"></span><h2>Flashing<a class="headerlink" href="#flashing-1" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Before flashing Talaria TWO, ensure that an appropriate SSBL is
generated after executing make clean, as instructed in section 6.2.</p>
<p>The following commands will write the SSBL and other components to
flash. Run the commands from the &lt;freertos_sdk&gt; directory:</p>
<ol class="arabic simple">
<li><p>Load flash helper</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/boot.py ‚Äìdevice /dev/ttyUSB2 ‚Äìreset=evk42_bl
./apps/gordon.elf</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="2">
<li><p>Invalidate boot image</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>dd if=/dev/zero of=./empty.img bs=1K count=1</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x1000 ./empty.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="3">
<li><p>Enroll keys</p>
<ol class="loweralpha simple">
<li><p>For emulating/testing SecureSSBL in development, without burning
the fuse</p></li>
</ol>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;/apps/ssbl/</p>
<p>../../script/flash.py enroll ‚Äìkeyfile=enroll.json ‚Äìsecureboot puf
‚Äìfuse-location emulated</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="loweralpha simple" start="2">
<li><p>For production SecureSSBL and burning the fuse</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;/apps/ssbl/</p>
<p>../../script/flash.py enroll ‚Äìkeyfile=enroll.json ‚Äìsecureboot puf
‚Äìfuse-location one-time-programmable-fuses</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="4">
<li><p>Flash SSBL partition table</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py from_json
tools/partition_files/ssbl_part_table.json</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="5">
<li><p>Flash SSBL image at 0x1000</p>
<ol class="loweralpha simple">
<li><p>For emulating/testing SecureSSBL in development</p></li>
</ol>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x1000
./apps/ssbl/out/both.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="loweralpha simple" start="2">
<li><p>For production SecureSSBL</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x1000
./apps/ssbl/out/ssbl_secure.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="6">
<li><p>Build application and filesystem</p></li>
</ol>
<blockquote>
<div><p>For the purpose of this application note, secureboot SSBL is
demonstrated for the application <em>example/secure_files.</em></p>
</div></blockquote>
<ol class="loweralpha simple">
<li><p>Build the example/secure_files application</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;/examples/secure_files/</p>
<p>make clean</p>
<p>make KEY=../../apps/ssbl/enroll.json</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>This creates a signed and encrypted application binary
examples/secure_files/out/secure_files.elf.enc</p>
</div></blockquote>
<ol class="loweralpha simple" start="2">
<li><p>Filesystem image for this application is created using following
command.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>python ./script/build_rootfs_generic.py ‚Äìfolder_path
examples/secure_files/ ‚Äìsecure True ‚Äìkeyfile
./apps/ssbl/enroll.json</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>This creates a root image binary
examples/secure_files/root_secure.img</p>
</div></blockquote>
<ol class="arabic simple" start="7">
<li><p>Flash application at 0x20000</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x20000
./examples/secure_files/out/secure_files.elf.enc</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="8">
<li><p>Flash filesystem at 0x180000</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/flash.py ‚Äìdevice /dev/ttyUSB2 write 0x180000
./examples/secure_files/root_secure.img</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="9">
<li><p>Reset the board</p></li>
</ol>
<blockquote>
<div><p>Reset the board either by executing the following command or by
pressing the reset button on the EVB to run ‚Äòsecure_files‚Äô
application.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd &lt;freertos_sdk&gt;</p>
<p>./script/boot.py ‚Äìdevice /dev/ttyUSB2 ‚Äìreset=evk42</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="expected-output-1">
<span id="id7"></span><h2>Expected Output<a class="headerlink" href="#expected-output-1" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>When DEBUGSECURE=1</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWAE</p>
<p>FIRST:SWWWWAHE</p>
<p>Si</p>
<p>Build $Id: git-a74c874 $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0051-002a-ffffffffffff</p>
<p>***Warning! Make sure to remove this code section once in
production***</p>
<p>secureboot_secret:</p>
<p>8b5
678a045ba66b7ea956d3292aae8dc29ded8de9010efd40980a091734b786b11000000</p>
<p>***Warning! Make sure to remove this code section once in
production***</p>
<p>cipher key:
4e3b0b9792183c53ecc78a38c64a45c071b97bc40b0baba308ed76db8a46cef1</p>
<p>public key:
20b003d2f297be2c5e2c83a7e9f9a5b9eff49111acf4fddbcc0301480e3
59de6dc809c49652aeb6d63329abf5a52155c766345c28fed3024741c8ed01589d28b</p>
<p>Build $Id: git- a74c874 $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0051-002a-ffffffffffff</p>
<p>Bootargs: vm.flash_location=0x0002d900
passphrase=12346789ssid=innotest</p>
<p>sys.reset_reason=1</p>
<p>Application Information:</p>
<p>Name¬†¬†¬†¬†¬†¬† : Secure files demo application</p>
<p>Version¬†¬†¬† : 1.0</p>
<p>Build Date : Aug 26 2023</p>
<p>Build Time : 18:50:21</p>
<p>Heap Available: 402 KB (411896 Bytes)</p>
<p>Original message: Hello! This is a plain text file.</p>
<p>Writing message to encrypted file</p>
<p>Reading file as ciphertext</p>
<p>Cipher text message: 1~‚êíM}rQoÏï∫{A√õ‚êí*_/rY0</p>
<p>Reading and decrypting file</p>
<p>Plain text message: Hello! This is a plain text file.</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="3.%20IoT_AWS.html" class="btn btn-neutral float-left" title="IoT AWS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="5.%20Firmware_Over-The-Air-Upgrade.html" class="btn btn-neutral float-right" title="Firmware Over The Air" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 InnoPhase IoT, Inc. | All Rights Reserved | Proprietary &amp; Confidential.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>