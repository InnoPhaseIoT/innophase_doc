<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BLE WiFi Bridge &mdash; InnoPhase 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Crash Handling" href="Example_for_Crash_handling.html" />
    <link rel="prev" title="Audio Over I2S" href="Example_for_Audio_over_I2S.html" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="../../_static/js/custom.js" defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            InnoPhase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Getting%20Started/Getting%20Started%20-%20Landing%20Page.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware%20Reference/Hardware-Reference.html">Hardware-Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Software%20Reference/Software_Reference_Landing_Page.html">Software Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Development%20Environments/Development%20Environments%20-%20Landing%20Page.html">Development Environments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Tools/Tools-landing%20page.html">Tool</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#apps">Apps</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#examples">Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Example_for_Analog_to_Digital_Converter.html">Analog to Digital Converter (ADC)</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Audio_over_I2S.html">Audio Over I2S</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">BLE WiFi Bridge</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mq-telemetry-transport-protocol">MQ Telemetry Transport Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#relevant-apis">Relevant APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ble-apis">BLE APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gap-init">bt_gap_init()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gatt-create-service-16">bt_gatt_create_service_16()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gatt-add-char-16">bt_gatt_add_char_16()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gatt-add-service">bt_gatt_add_service()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gap-cfg-adv">bt_gap_cfg_adv()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gap-connectable-mode">bt_gap_connectable_mode()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gap-server-link-add">bt_gap_server_link_add()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gap-server-link-remove">bt_gap_server_link_remove()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gatt-add-desc-16">bt_gatt_add_desc_16()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-gap-server-link-remove-1">bt_gap_server_link_remove()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqtt-apis">MQTT APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkinit">MQTTNetworkInit()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkconnect">MQTTNetworkConnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkdisconnect">MQTTNetworkDisconnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttclientinit">MQTTClientInit()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttconnect">MQTTConnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttdisconnect">MQTTDisconnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttpublish">MQTTPublish()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttsubscribe">MQTTSubscribe()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttunsubscribe">MQTTUnsubscribe()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttyield">MQTTYield()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-flow">Application Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-walkthrough">Code Walkthrough</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-the-boot-argument">Reading the Boot Argument</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connecting-to-a-wi-fi-network">Connecting to a Wi-Fi Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initializing-mqtt-client">Initializing MQTT Client</a></li>
<li class="toctree-l4"><a class="reference internal" href="#publishing-data-to-the-mqtt-instance">Publishing Data to the MQTT Instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#subscribing-to-mqtt-topic">Subscribing to MQTT Topic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-ble-gatt-server">Running BLE GATT Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connection-disconnection-callbacks">Connection/Disconnection Callbacks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#characteristic-access-callback">Characteristic Access Callback</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-application-using-mosquitto-projects-test-server">Running the Application using Mosquitto Project’s Test Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-and-running-the-mosquitto-mqtt-tool">Installing and Running the Mosquitto MQTT Tool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#programming-the-talaria-two-module">Programming the Talaria TWO Module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#publishing-a-topic-and-sending-data-from-ble-to-wi-fi">Publishing a Topic and Sending Data from BLE to Wi-Fi</a></li>
<li class="toctree-l4"><a class="reference internal" href="#subscribing-to-a-topic-and-sending-data-from-wi-fi-to-ble">Subscribing to a Topic and Sending Data from Wi-Fi to BLE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Crash_handling.html">Crash Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_I2C.html">I2C</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_LPScan.html">LPS Scan</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_MQTT.html">MQTT</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Pulse_Width_Modulation.html">Pulse Width Modulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Radio_and_Module_Parameters.html">Radio and Module Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Secure_Files.html">Secure Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Socket_Wakeup.html">Socket Wakeup</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Software_SPI_Master.html">Software SPI Master</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_Chip_Monitor.html">Chip Monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_Filesystem.html">Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_GPIO.html">GPIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_SNTP.html">SNTP</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_WiFi.html">WIFI</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_WiFi_Power_Management.html">WiFi Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_BLE_5_0.html">BLE 5.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_BLE_Beacons.html">BLE Beacon</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Custom_ATCMDLIB.html">Custom ATCMDLIB</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_HTTP_Client.html">HTTP Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_IFTTT.html">IFTTT</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Low_Power_UART.html">Low Power UART</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_mDNS.html">mDNS</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html">Provisioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#scan-data">Scan Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#configuration-data-format">Configuration Data Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#service">Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#characteristics">Characteristics</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#application-flow">Application Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#sample-code-walkthrough">Sample Code Walkthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#write-the-provisioning-file-into-talaria-two-filesystem">Write the Provisioning File into Talaria TWO Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#programming-talaria-two-board-with-elf">Programming Talaria TWO board with ELF</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#running-the-application-using-android-or-ios-app">Running the Application using Android or iOS App</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Unassociated_Mode.html">Unassociated Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Watchdog_Timer.html">Watchlog Timer</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_WCM_Multi_AP.html">WCM Multi AP</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Websock_Client.html">Websock Client</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Regulatory%20Notices/Regulatory%20Notices.html">Regulatory Notices</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Security/Security%20-%20Landing%20Page.html">Security</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Porting%20Guide/Porting-Guide.html">Porting-Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Support/Support.html">Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Disclaimers/Disclaimers.html">Disclaimer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Appendix/Appendix-Landing_Page.html">Appendix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">InnoPhase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Applications%20-%20Landing%20Page.html">Applications</a></li>
      <li class="breadcrumb-item active">BLE WiFi Bridge</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Applications/2. Examples/Example_for_BLE_WiFi_Bridge.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ble-wifi-bridge">
<h1>BLE WiFi Bridge<a class="headerlink" href="#ble-wifi-bridge" title="Permalink to this heading"></a></h1>
<p>This application note describes the accompanying example code in which
Talaria TWO receives a text message from a connected BLE client and
publishes that text message to a MQTT Broker.</p>
<section id="mq-telemetry-transport-protocol">
<h2>MQ Telemetry Transport Protocol<a class="headerlink" href="#mq-telemetry-transport-protocol" title="Permalink to this heading"></a></h2>
<p>MQTT is a messaging protocol based on publish-subscribe pattern. It
works on top of the TCP/IP protocol and is used in internet of things.</p>
<p>Publish-subscribe paradigm is event-driven, and messages are pushed to
the clients. It requires an additional central point, called MQTT
Broker, which takes care of dispatching all the messages between the
senders and the rightful receivers.</p>
<p>When the clients publish messages to the broker, they include a topic
into the message. For the broker, the topic acts as the routing
information. Each client that wants to receive messages subscribes to a
certain topic and the broker takes care of delivering all messages with
the matching topic to the relevant client.</p>
<p>There is no requirement for the clients to know each other directly and
the communication happens only over the topic. This pattern removes the
dependencies of direct connectivity between the data producers and the
data consumers and thus enables scalable solutions.</p>
<p>Apart from this, the protocol has the property of client side requiring
small code footprint and less bandwidth, while the MQTT Broker can do
heavy lifting of receiving messages from thousands of clients
concurrently, filtering and routing each message to the right client who
have subscribed to the topic.</p>
<p>This makes MQTT protocol ideal for resource constrained IoT devices
which needs to be bandwidth-efficient and use little battery power.</p>
</section>
<section id="relevant-apis">
<h2>Relevant APIs<a class="headerlink" href="#relevant-apis" title="Permalink to this heading"></a></h2>
</section>
<section id="ble-apis">
<h2>BLE APIs<a class="headerlink" href="#ble-apis" title="Permalink to this heading"></a></h2>
</section>
<section id="bt-gap-init">
<h2>bt_gap_init()<a class="headerlink" href="#bt-gap-init" title="Permalink to this heading"></a></h2>
<p>Creates and initializes all the resources needed to run GAP Service and
must be called before using any of the other functions in the Bluetooth
GAP interface.</p>
</section>
<section id="bt-gatt-create-service-16">
<h2>bt_gatt_create_service_16()<a class="headerlink" href="#bt-gatt-create-service-16" title="Permalink to this heading"></a></h2>
<p>Creates a service declaration from a 16-bit UUID given as parameter and
returns the pointer to the GATT service.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct gatt_service * bt_gatt_create_service_16(uint16_t uuid16)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="bt-gatt-add-char-16">
<h2>bt_gatt_add_char_16()<a class="headerlink" href="#bt-gatt-add-char-16" title="Permalink to this heading"></a></h2>
<p>Adds a characteristic with a 16-bit UUID to a created service. It takes
permission, properties and an access callback function as input which is
called by stack when this characteristic is accessed.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct gatt_char * bt_gatt_add_char_16(struct gatt_service *s,
uint16_t uuid16, bt_srv_fcn_t fcn, uint8_t permission, uint8_t
property)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="bt-gatt-add-service">
<h2>bt_gatt_add_service()<a class="headerlink" href="#bt-gatt-add-service" title="Permalink to this heading"></a></h2>
<p>Adds a created service to the local server list. All includes,
characteristics and descriptors should have been added to the created
service before the service is added to the server.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void bt_gatt_add_service(struct gatt_service *s)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="bt-gap-cfg-adv">
<h2>bt_gap_cfg_adv()<a class="headerlink" href="#bt-gap-cfg-adv" title="Permalink to this heading"></a></h2>
<p>Configures the advertisement parameters for the GAP peripheral, through
which the frequency of advertisement transmission in fast and slow mode
can be adjusted. It also configures the Tx power for advertisement and
the channel map used.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bt_gap_error_t bt_gap_cfg_adv(const uint16_t adv_fast_period, const
uint16_t adv_slow_period, const uint16_t adv_fast_int, const uint16_t
adv_slow_int, const int8_t adv_tx_power , const uint8_t adv_ch_map)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The API takes the following parameters as input:</p>
<ol class="arabic simple">
<li><p>adv_fast_period (ms): for this period, fast advertising is attempted
every adv_fast_int interval. Once this period is over, slow
advertising is attempted every adv_slow_int interval. Default value
of this parameter is 0, representing period infinity, which means
fast advertising will be attempted forever once started.</p></li>
<li><p>adv_slow_period (ms): for this period, slow advertising is attempted
every adv_slow_int interval. Once this period is completed,
advertising is disabled. Default value of this parameter is 0,
representing period infinity, which means slow advertising will be
attempted forever once started.</p></li>
<li><p>adv_fast_int In 625µs units: This sets the interval between two fast
advertisements. Range: 0x0020 to 0x4000 (default: 200).</p></li>
</ol>
<blockquote>
<div><p>This implies, when this interval is represented in decimal, the range
is between 20,000µs (20ms) to 10,240,000µs (10,240ms) configurable in
the steps of 625µs. Default in decimal is 125,000‬µs, which is, every
125ms, 8 times per second.</p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>adv_slow_int In 625µs units: This sets the interval between two slow
advertisements. Range: 0x0020 to 0x4000 (default: 1600).</p></li>
</ol>
<blockquote>
<div><p>This implies that when this interval is represented in decimal, the
range is between 20,000µs (20ms) to 10,240,000µs (10,240ms)
configurable in the steps of 625µs. Default in decimal is
1,000,000µs, which is, every 1000ms, once per second.</p>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><p>adv_tx_power In dBm, range: -127 to 10, and 127 (127=no preference)
(default: 127)</p></li>
<li><p>adv_ch_map Channel map used: bit0=ch37, bit1=ch38, bit2=ch39
(default: 0x7)</p></li>
</ol>
<p>The API returns error code from bt_gap_error_t.</p>
</section>
<section id="bt-gap-connectable-mode">
<h2>bt_gap_connectable_mode()<a class="headerlink" href="#bt-gap-connectable-mode" title="Permalink to this heading"></a></h2>
<p>Sets the device in desired connectable mode.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bt_gap_error_t bt_gap_connectable_mode(const gap_connectable_mode_t
mode, const bt_hci_addr_type_t</p>
<p>own_type, const bt_hci_addr_type_t peer_type, const bt_address_t
peer_address, const gap_ops_t *ops)</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Connection mode can be any one from the following list:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>typedef enum {</p>
<p>/** Disable connectable mode */</p>
<p>GAP_CONNECTABLE_MODE_DISABLE = 0,</p>
<p>/** Do not allow a connection to be established */</p>
<p>GAP_CONNECTABLE_MODE_NON = 1,</p>
<p>/** Accept a connection request from a known peer device */</p>
<p>GAP_CONNECTABLE_MODE_DIRECT = 2,</p>
<p>/** Accept a connection request from a any device */</p>
<p>GAP_CONNECTABLE_MODE_UNDIRECT = 3,</p>
<p>} gap_connectable_mode_t;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Other inputs parameters to the API are as follows:</p>
<ol class="arabic simple">
<li><p>own_type: Own address type: 0=public, 1=random, 2=resolvable (or
public if no local IRK), 3=resolvable (or random if no local IRK)</p></li>
<li><p>peer_type: Peer address type: 0=public (device or identity), 1=random
(device or identity)</p></li>
<li><p>peer_address: Peer address</p></li>
<li><p>ops: GAP callback functions Ex: connection and disconnection
callback.</p></li>
</ol>
</section>
<section id="bt-gap-server-link-add">
<h2>bt_gap_server_link_add()<a class="headerlink" href="#bt-gap-server-link-add" title="Permalink to this heading"></a></h2>
<p>Used to add a GATT server to the gap connection.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct gatt_srv_link * bt_gap_server_link_add(const uint8_t handle)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>It takes connection handle as input and returns pointer to
gatt_srv_link.</p>
</section>
<section id="bt-gap-server-link-remove">
<h2>bt_gap_server_link_remove()<a class="headerlink" href="#bt-gap-server-link-remove" title="Permalink to this heading"></a></h2>
<p>Used to remove GATT server from the gap connection.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void bt_gap_server_link_remove(const struct gatt_srv_link *link)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>It takes pointer to gatt_srv_link to be removed as input.</p>
</section>
<section id="bt-gatt-add-desc-16">
<h2>bt_gatt_add_desc_16()<a class="headerlink" href="#bt-gatt-add-desc-16" title="Permalink to this heading"></a></h2>
<blockquote>
<div><p>Add a 16-bit UUID descriptor to a characteristic.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct gatt_desc * bt_gatt_add_desc_16(struct gatt_char *c,
uint16_t uuid16, bt_srv_fcn_t fcn, uint8_t permission, uint8_t
property)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="bt-gap-server-link-remove-1">
<span id="id1"></span><h2>bt_gap_server_link_remove()<a class="headerlink" href="#bt-gap-server-link-remove-1" title="Permalink to this heading"></a></h2>
<p>Add a 16-bit UUID descriptor to a characteristic.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct gatt_desc * bt_gatt_add_desc_16(struct gatt_char *c,
uint16_t uuid16, bt_srv_fcn_t fcn, uint8_t</p>
<p>permission, uint8_t property)</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqtt-apis">
<h2>MQTT APIs<a class="headerlink" href="#mqtt-apis" title="Permalink to this heading"></a></h2>
</section>
<section id="mqttnetworkinit">
<h2>MQTTNetworkInit()<a class="headerlink" href="#mqttnetworkinit" title="Permalink to this heading"></a></h2>
<p>Initializes MQTT network object with socket read, write, and disconnect
functions.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTNetworkInit(MQTTNetwork* n)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkconnect">
<h2>MQTTNetworkConnect()<a class="headerlink" href="#mqttnetworkconnect" title="Permalink to this heading"></a></h2>
<p>Opens a socket and tries to connect the MQTT network object to the
network endpoint.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTNetworkConnect(MQTTNetwork* n, char* addr, int port)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkdisconnect">
<h2>MQTTNetworkDisconnect()<a class="headerlink" href="#mqttnetworkdisconnect" title="Permalink to this heading"></a></h2>
<p>Closes the socket and tries to connect the MQTT network object to the
network endpoint.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTNetworkDisconnect(MQTTNetwork *n)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttclientinit">
<h2>MQTTClientInit()<a class="headerlink" href="#mqttclientinit" title="Permalink to this heading"></a></h2>
<p>Creates an MQTT client object.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTClientInit(MQTTClient* client, MQTTNetwork* network,
unsigned int command_timeout_ms,unsigned char* sendbuf, size_t
sendbuf_size, unsigned char* readbuf, size_t readbuf_size);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttconnect">
<h2>MQTTConnect()<a class="headerlink" href="#mqttconnect" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT connect packet down the network and wait for a Connack.
The network object must be connected to the network endpoint before
calling this.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTConnect(MQTTClient* client, MQTTPacket_connectData*
options);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttdisconnect">
<h2>MQTTDisconnect()<a class="headerlink" href="#mqttdisconnect" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT disconnect packet and closes the connection.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTDisconnect(MQTTClient* client);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttpublish">
<h2>MQTTPublish()<a class="headerlink" href="#mqttpublish" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT publish packet and waits for all acks to complete.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTPublish(MQTTClient* client, const char *topic, MQTTMessage
*message);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttsubscribe">
<h2>MQTTSubscribe()<a class="headerlink" href="#mqttsubscribe" title="Permalink to this heading"></a></h2>
<p>Send an MQTT subscribe packet and wait for suback before returning.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTSubscribe(MQTTClient* client, const char* topicFilter, enum
QoS qos, MQTTMessageHandler messageHandler);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttunsubscribe">
<h2>MQTTUnsubscribe()<a class="headerlink" href="#mqttunsubscribe" title="Permalink to this heading"></a></h2>
<p>Send an MQTT unsubscribe packet and wait for unsuback before returning.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTUnsubscribe(MQTTClient* client, const char* topicFilter);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttyield">
<h2>MQTTYield()<a class="headerlink" href="#mqttyield" title="Permalink to this heading"></a></h2>
<p>MQTT goes to background for the time (ms) to yield for.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTYield(MQTTClient* client, int time);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="application-flow">
<h2>Application Flow<a class="headerlink" href="#application-flow" title="Permalink to this heading"></a></h2>
<p>In this application, Talaria TWO is programmed to become a GATT server
with a characteristic which can be read and written by a connected BLE
client. The written text message is published to the MQTT Broker running
as MQTT instance. A custom BLE service is also created to send the
indications from Talaria TWO to the connected BLE client.</p>
<p>Following are the steps to achieve this:</p>
<ol class="arabic simple">
<li><p>Connect the device to a Wi-Fi network, whose SSID and passphrase are
given as boot arguments while flashing the binary image.</p></li>
<li><p>Connect to the MQTT instance using URL, port, username, and password
of the cloud which are also given as boot arguments.</p></li>
<li><p>Initialize GAP profile and create GATT services for reading the name
of BLE device and writing some text to the BLE peripheral device.</p></li>
<li><p>Create a BLE custom service to send the indications to BLE client.</p></li>
<li><p>On receiving any texts onto the BLE device, publish it to the MQTT
client.</p></li>
<li><p>The published messages can be seen on subscriber’s console window.</p></li>
<li><p>Upon receiving any messages for the topics subscribed, Talaria TWO
will send the messages as indications to the connected BLE Client.</p></li>
</ol>
</section>
<section id="code-walkthrough">
<h2>Code Walkthrough<a class="headerlink" href="#code-walkthrough" title="Permalink to this heading"></a></h2>
</section>
<section id="reading-the-boot-argument">
<h2>Reading the Boot Argument<a class="headerlink" href="#reading-the-boot-argument" title="Permalink to this heading"></a></h2>
<p>While programming the elf to Talaria TWO using boot.py, we use bootargs
to pass below necessary parameters to the program.</p>
<ol class="arabic simple">
<li><p>SSID and Passphrase of Wi-Fi Network</p></li>
<li><p>URL, Port, Username and Password of the MQTT server</p></li>
</ol>
<p>In main(), first these parameters are retrieved as shown below.</p>
<p>main.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int main()</p>
<p>{</p>
<p>print_ver(“Ble Wifi Bridge Demo App”, 1, 3);</p>
<p>struct network_profile *profile;</p>
<p>int rval;</p>
<p>int ret;</p>
<p>const char *ssid = os_get_boot_arg_str(“ssid”);</p>
<p>const char *passphrase = os_get_boot_arg_str(“passphrase”)?:NULL;</p>
<p>const char *np_conf_path = os_get_boot_arg_str(“np_conf_path”)?:
NULL;</p>
<p>cloud_url = os_get_boot_arg_str(“cloud_url”) ;</p>
<p>cloud_port = os_get_boot_arg_int(“cloud_port”, 1883) ;</p>
<p>cloud_usr_name = os_get_boot_arg_str(“cloud_usr_name”) ;</p>
<p>cloud_usr_psw = os_get_boot_arg_str(“cloud_usr_psw”) ?: “”;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="connecting-to-a-wi-fi-network">
<h2>Connecting to a Wi-Fi Network<a class="headerlink" href="#connecting-to-a-wi-fi-network" title="Permalink to this heading"></a></h2>
<p>To connect to a Wi-Fi network, wcm_create()API from the Wi-Fi Connection
Manager are used.</p>
<p>main.c</p>
<blockquote>
<div><p>Initially, the Wi-Fi network interface is created using wcm_create().</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>h = wcm_create(NULL);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>wifi_connect_to_network()API, from components library, connects to
the Wi-Fi network using the AP credentials provided.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>rval = wifi_connect_to_network(&amp;h, WCM_CONN_WAIT_INFINITE,
&amp;wcm_connect_success);</p>
<p>if(rval &lt; 0) {</p>
<p>os_printf(”\nError: Unable to connect to network\n”);</p>
<p>return 0;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Once the Wi-Fi connection is successful, the application begins the
BLE Wi-Fi bridge services.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>start_ble_wifi_bridge_services();</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The on_new_message_via_ble() function publishes the message received
from the BLE device.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int on_new_message_via_ble(char *message, int len)</p>
<p>{</p>
<p>vTaskDelay(100); /* added wait for 100 m sec before publishing*/</p>
<p>return (bmw_publish_message(message, len));</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>my_app_init() function creates a thread for BLE, subscribe and publish
operations.</p>
</section>
<section id="initializing-mqtt-client">
<h2>Initializing MQTT Client<a class="headerlink" href="#initializing-mqtt-client" title="Permalink to this heading"></a></h2>
<p>Once connection to a Wi-Fi network is established, connection to the
MQTT broker can be initiated</p>
<p>In main.c, start_mqtt() is called and the login parameters of the MQTT
broker are passed.</p>
<p>In start_mqtt(), the handle to MQTT network is created by allocating an
MQTT network object mqtt_network of type MQTTNetwork.</p>
<p>Then this network object is initialized using MQTTNetworkInit()and a
connection is established to network endpoint by passing the initialized
handle mqtt_network, cloud_url and cloud_port to MQTTNetworkConnect().</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void start_ble_wifi_bridge_services(void)</p>
<p>{</p>
<p>if(start_mqtt((char *)cloud_url, cloud_port, (char
*)cloud_usr_name, (char *)cloud_usr_psw) == 0 ){</p>
<p>os_printf(“starting subscriber_publisher_thread\n”);</p>
<p>start_ble();</p>
<p>bmw_subscribe_message();</p>
<p>}else{</p>
<p>if(restart_mqtt_connection() == 0){</p>
<p>start_ble();</p>
<p>bmw_subscribe_message();</p>
<p>}else{</p>
<p>os_printf(“Check if the MQTT broker is active\r\n”);</p>
<p>}</p>
<p>}</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>MQTT Client is initialized in the same code.</p>
<p>Object of type MQTTClient is allocated first and held by handle
mqtt_client.</p>
<p>Then MQTTClientInit() is called with the MQTT network object
mqtt_network, pointers to read and send buffers and the MQTTClient
handle mqtt_client.</p>
<p>mqtt.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static MQTTNetwork *mqtt_network;</p>
<p>static MQTTClient *mqtt_client;</p>
<p>…</p>
<p>…</p>
<p>int start_mqtt(char *cloud_url, int cloud_port, char
*cloud_usr_name, char *cloud_usr_psw)</p>
<p>{</p>
<p>int rc;</p>
<p>/*initializing MQTT*/</p>
<p>mqtt_network= osal_zalloc(sizeof(MQTTNetwork));</p>
<p>MQTTNetworkInit(mqtt_network);</p>
<p>…</p>
<p>…</p>
<p>rc = MQTTNetworkConnect(mqtt_network, cloud_url, cloud_port);</p>
<p>if(rc != 0)</p>
<p>{</p>
<p>os_printf(“\nMQTTNetworkConnect failed ret:%d (%s)\n”, rc,
strerror(rc));</p>
<p>return (void*)-1;</p>
<p>}</p>
<p>…</p>
<p>…</p>
<p>return rc;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Then, a connect request packet is made using client_data.client_id as
T2_&lt;mac_id&gt;, cloud_usr_name and cloud_usr_psw.</p>
<p>And finally, a connection request to MQTT broker is made with the packet
made in above step, using MQTTConnect(). As shown in the following
section:</p>
<p>mqtt.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int start_mqtt(char *cloud_url, int cloud_port, char
*cloud_usr_name, char *cloud_usr_psw)</p>
<p>{</p>
<p>int rc;</p>
<p>…</p>
<p>…</p>
<p>mqtt_client = osal_zalloc(sizeof(MQTTClient));</p>
<p>/* Opens a socket and tries to connect the MQTT network</p>
<p>object to the network endpoint. */</p>
<p>rc = MQTTNetworkConnect(mqtt_network, cloud_url, cloud_port);</p>
<p>…</p>
<p>…</p>
<p>generate_mqtt_topics(&amp;client_data);</p>
<p>/* Creates an MQTT client object. */</p>
<p>MQTTClientInit(mqtt_client, mqtt_network, TIMEOUT_MS,</p>
<p>sendbuf, sizeof(sendbuf), readbuf, sizeof(readbuf));</p>
<p>MQTTPacket_connectData data = MQTTPacket_connectData_initializer;</p>
<p>data.willFlag = 0;</p>
<p>data.MQTTVersion = 3;</p>
<p>data.username.cstring = cloud_usr_name;</p>
<p>data.password.cstring = cloud_usr_psw;</p>
<p>data.clientID.cstring = client_data.client_id;</p>
<p>os_printf(”***MQTT Client id is %s\r\n”,data.clientID.cstring);</p>
<p>data.keepAliveInterval = MQTT_KEEP_ALIVE_INTERVAL; //default was 100</p>
<p>data.cleansession = 0;</p>
<p>os_printf(“Connecting to %s:%d\n”, cloud_url, cloud_port);</p>
<p>/* Sends an MQTT connect packet down the network and wait for a
Connect.</p>
<p>The network object must be connected to the network endpoint</p>
<p>before calling this. */</p>
<p>mqtt_client-&gt;ping_outstanding = 0;</p>
<p>rc = MQTTConnect(mqtt_client, &amp;data);</p>
<p>os_printf(“Connected to %s:%d ret:%d\n”, cloud_url, cloud_port, rc);</p>
<p>return rc;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>fetch_t2_macid()function fetches the mac ID of the Talaria TWO device
and stores it in mac_id[index] buffer.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>const <em>uint8_t</em> *mac_addr = wcm_get_hwaddr(h);</p>
<p>os_printf(”<em>mac</em> id:”);</p>
<p>for(int index =0;index&lt;6;index++){</p>
<p>mac_id[index] = *(mac_addr+index);</p>
<p>os_printf(“%x”,mac_id[index]);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>generate_mqtt_topics() function generates the MQTT publish and subscribe
topics by using the mac ID of Talaria TWO and prints these topics onto
the console. The other MQTT client (PC in this example) can
subscribe/publish to these topics.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>uint8_t t2_mac_id[LEN_OF_MAC_ID];</p>
<p>uint8_t len_mqtt_sub_topic,len_mqtt_pub_topic;</p>
<p>char temp_buf[10];</p>
<p>int index = 0;</p>
<p>fetch_t2_macid(t2_mac_id);</p>
<p>for (int i=0; i &lt; LEN_OF_MAC_ID; i++){</p>
<p>index += snprintf(&amp;temp_buf[index], 128-index, “%x”, t2_mac_id[i]);</p>
<p>}</p>
<p>sprintf(mqtt_client_data-&gt;client_id,”T2_%s”,temp_buf);</p>
<p>len_mqtt_sub_topic =
strlen(mqtt_client_data-&gt;client_id)+strlen(topic_subscribe)+1;</p>
<p>snprintf(mqtt_client_data-&gt;subscribe_topic,
len_mqtt_sub_topic,”%s%s”,mqtt_client_data-&gt;client_id,topic_publish);</p>
<p>len_mqtt_pub_topic =
strlen(mqtt_client_data-&gt;client_id)+strlen(topic_publish)+1;</p>
<p>snprintf(mqtt_client_data-&gt;publish_topic,le
n_mqtt_pub_topic,”%s%s”,mqtt_client_data-&gt;client_id,topic_subscribe);</p>
<p>os_printf(”
\r\n——————————————————\r\n”);</p>
<p>os_printf(“MQTT Client id : %s\r\n”,mqtt_client_data-&gt;client_id);</p>
<p>os_printf(“MQTT publish topic: %s\r\n”,
mqtt_client_data-&gt;publish_topic);</p>
<p>os_printf(“MQTT subscribe topic: %s\r\n”,
mqtt_client_data-&gt;subscribe_topic);</p>
<p>os_prin
tf(”——————————————————–\r\n”);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="publishing-data-to-the-mqtt-instance">
<h2>Publishing Data to the MQTT Instance<a class="headerlink" href="#publishing-data-to-the-mqtt-instance" title="Permalink to this heading"></a></h2>
<p>Function bmw_publish_message()takes pointer and length of a message as
input and publishes it to the remote MQTT Broker running as MQTT
instance.</p>
<p>Message is published using the MQTTPublish() function under the topic
T2_&lt;mac id of T2&gt;/subscribe.</p>
<p>mqtt.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int bmw_publish_message(char *pmessage, int len)</p>
<p>{</p>
<p>int rc = 0;</p>
<p>MQTTMessage *publish = osal_zalloc(sizeof(MQTTMessage));</p>
<p>publish-&gt;payload = pmessage;</p>
<p>publish-&gt;payloadlen =len;</p>
<p>memcpy(device_data_recieved, pmessage, len);</p>
<p>device_data_recieved[len]=’\0’;</p>
<p>os_printf(”\n\n%u:from BLE Client, Message
Recieved[%s]”,os_systime(), device_data_recieved);</p>
<p>if(mqtt_connection_status_check() == 1){</p>
<p>os_printf(”\nMQTT connection is Active”);</p>
<p>restarting_session = false;</p>
<p>}</p>
<p>else{</p>
<p>restart_mqtt_connection();</p>
<p>}</p>
<p>rc = MQTTPublish(mqtt_client, client_data.publish_topic, publish);
if(rc != 0)</p>
<p>{</p>
<p>os_printf(”\nMQTTPublish failed. Ret= %d”, rc);</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p>os_printf(”\n%u:Message published successfully [%s]”,os_systime(),
pmessage);</p>
<p>}</p>
<p>osal_free(publish);</p>
<p>return 0;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="subscribing-to-mqtt-topic">
<h2>Subscribing to MQTT Topic<a class="headerlink" href="#subscribing-to-mqtt-topic" title="Permalink to this heading"></a></h2>
<p>Function bmw_subscribe_message()subscribes to a topic and registers the
call back function MQTTSubscribeCallback (MessageData* Msg). The call
back gets invoked when there is a message published by a client to the
same topic.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTSubscribeCallback(MessageData* Msg)</p>
<p>{</p>
<p>os_printf(”\nMQTTSubscribe Call back:%s
\n”,(char*)Msg-&gt;message-&gt;payload);</p>
<p>send_ble_in
dications((uint8_t*)Msg-&gt;message-&gt;payload,Msg-&gt;message-&gt;payloadlen);</p>
<p>memset((char*)Msg-&gt;message-&gt;payload,0,Msg-&gt;message-&gt;payloadlen);</p>
<p>}</p>
<p>int bmw_subscribe_message(void)</p>
<p>{</p>
<p>MQTTYield(mqtt_client, 1000);</p>
<p>MQTTMessageHandler messageHandler = &amp;MQTTSubscribeCallback;</p>
<p>MQTTSubscribe(mqtt_client, client_data.subscribe_topic, QOS1,
messageHandler);</p>
<p>return 0;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>bmw_unsubscribe_message()function unsubscribes to the topic which is
already subscribed to.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int bmw_unsubscribe_message(void)</p>
<p>{</p>
<p>MQTTUnsubscribe(mqtt_client, client_data.subscribe_topic);</p>
<p>return 0;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>bmw_Yield()function yields to check if any messages are to be
published/subscribed.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void bmw_Yield(void)</p>
<p>{</p>
<p>MQTTYield(mqtt_client, 500);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="running-ble-gatt-server">
<h2>Running BLE GATT Server<a class="headerlink" href="#running-ble-gatt-server" title="Permalink to this heading"></a></h2>
<p>Once connection with the MQTT network is established, BLE GAP is
initialized and a GATT service with a write only characteristic is
started.</p>
<p>The message written by any connected BLE client to this characteristic
is published to MQTT broker. A smartphone application is used in this
example to write a message to this characteristic.</p>
<p>Initially, the Bluetooth GAP service is initialized using bt_gap_init()
and then a custom Bluetooth GATT service is created.</p>
<p>The bt_gatt_create_service_16() function creates a custom GATT service
with a 16-bit UUID.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bt_gap_error_t custom_ind_server_create(void)</p>
<p>{</p>
<p>srv16 = bt_gatt_create_service_16(CUSTOM_IND_SERVICE_UUID);</p>
<p>chr_i = bt_gatt_add_char_16(srv16,
CUSTOM_IND_SERVICE_CHARACTERISTIC_UUID, NULL, 0, GATT_CHAR_PROP_I);</p>
<p>bt_gatt_add_desc_16(chr_i, UUID_GATT_CD_CLIENT_CONFIGURATION,
indication_cccd, GATT_PERM_RW, GATT_CHAR_PROP_RW);</p>
<p>bt_gatt_add_service(srv16);</p>
<p>return GAP_ERROR_SUCCESS;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>bt_gatt_add_char_16() is used to add a characteristic with a 16-bit UUID
to that service. Callback function pointer is provided as parameter to
this function which will be called when the characteristic is accessed.
Properties and permissions for the characteristic are also specified.</p>
<p>Following are two such characteristics that are added:</p>
<ol class="arabic simple">
<li><p>UUID_GATT_CT_DEVICE_NAME and the callback associated when accessing
this characteristic is ‘device_name_read()’.</p></li>
<li><p>The other one is write only and the callback associated when
accessing this characteristic is ‘data_receive()’. In example
UUID_GATT_CT_DEVICE_NAME+1 is used which is UUID_GATT_CT_APPEARANCE.</p></li>
</ol>
<p>Finally, bt_gatt_add_service() adds the service to the server.</p>
<p>ble.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>// Initialize GAP and GATT</p>
<p>int start_ble()</p>
<p>{</p>
<p>bt_gap_init();</p>
<p>create_my_bt_service();</p>
<p>return 0;</p>
<p>}</p>
<p>// Create GATT service</p>
<p>bt_gap_error_t create_my_bt_service()</p>
<p>{</p>
<p>bt_gap_cfg_adv_t bt_adv_handle;</p>
<p>if (mqtts)</p>
<p>return GAP_ERROR_SUCCESS;</p>
<p>mqtts = osal_zalloc(sizeof(mqtts_t));</p>
<p>mqtts-&gt;srv = bt_gatt_create_service_16(UUID_GATT_S_GENERIC_ACCESS);</p>
<p>bt_gatt_add_char_16(mqtts-&gt;srv, UUID_GATT_CT_DEVICE_NAME,
device_name_read,</p>
<p>GATT_PERM_READ, GATT_CHAR_PROP_R); /* _REA*/</p>
<p>bt_gatt_add_char_16(mqtts-&gt;srv, UUID_GATT_CT_DEVICE_NAME+1,
data_receive,</p>
<p>GATT_PERM_WRITE, GATT_CHAR_PROP_W);</p>
<p>…</p>
<p>…</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Here bt_gap_cfg_adv() sets parameters for advertisement. The parameters
passed for configuring the advertisement are as follows:</p>
<ol class="arabic simple">
<li><p>adv_fast_period is set to 10,240ms which is nearest multiple of 10
seconds in 625µs units.</p></li>
</ol>
<blockquote>
<div><p>This means the fast advertising will be attempted for nearly 10
seconds (10.24s) when advertisement is enabled. After this 10.24s
period, the slow advertisement will be attempted.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>adv_slow_period is set to 0, this means slow advertisement will be
attempted indefinitely and there is no time bound programmed after
which advertisement should stop automatically.</p></li>
<li><p>adv_fast_int is set to 160, which means (160*625µs) = 100,000µs =
every 100ms is the interval at which fast advertisement will be
attempted.</p></li>
<li><p>adv_slow_int is set to 480, which means (480*625µs) = 300,000‬µs=
every 300ms will be the interval of slow advertising.</p></li>
<li><p>bt_gap_cfg_smp() is used to set security parameters. Here it is
passed as 0, so no security parameter is configured.</p></li>
<li><p>bt_gap_connectable_mode() makes the device connectable and will
enable advertisement.</p></li>
</ol>
<p>Note that a pointer to a gap_ops_t instance is provided to this function
call which supplies the GAP callback functions connected_cb and
disconnected_cb to be used when a connection or disconnection event
occurs.</p>
<p>ble.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>// Create GATT service</p>
<p>bt_gap_error_t create_my_bt_service()</p>
<p>{</p>
<p>…</p>
<p>custom_ind_server_create();</p>
<p>bt_gatt_add_service(mqtts-&gt;srv);</p>
<p>bt_adv_handle.fast_period = 10240;</p>
<p>bt_adv_handle.slow_period = 0;</p>
<p>bt_adv_handle.fast_interval = 160;</p>
<p>bt_adv_handle.slow_interval = 480;</p>
<p>bt_adv_handle.tx_power = 0;</p>
<p>bt_adv_handle.channel_map = BT_HCI_ADV_CHANNEL_ALL;</p>
<p>bt_gap_cfg_adv_set(&amp;bt_adv_handle);</p>
<p>/*return gap connectable mode*/</p>
<p>return bt_gap_connectable_mode(GAP_CONNECTABLE_MODE_UNDIRECT,</p>
<p>bt_hci_addr_type_random, 0, address_zero, &amp;gap_ops);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="connection-disconnection-callbacks">
<h2>Connection/Disconnection Callbacks<a class="headerlink" href="#connection-disconnection-callbacks" title="Permalink to this heading"></a></h2>
<p>At this point in the execution of the server, it is advertising and
ready to receive a connection from the client. When the client connects,
the callback function connected_cb will be called. In the callback, the
GATT server needs to be linked to this GAP connection using
bt_gap_server_link_add()with the following function call:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mqtts-&gt;gatt = bt_gap_server_link_add(param-&gt;handle);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The code sample shows how to obtain the argument required for this
function call from the argument provided to the callback by casting
hci_event with bt_hci_evt_le_conn_cmpl_t and fetching its handle.</p>
<p>Similarly, the link is removed using bt_gap_server_link_remove() when
the client disconnects,</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bt_gap_server_link_remove(mqtts-&gt;gatt);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="characteristic-access-callback">
<h2>Characteristic Access Callback<a class="headerlink" href="#characteristic-access-callback" title="Permalink to this heading"></a></h2>
<p>While the client is connected to the server, it can read or write the
custom characteristic based on the characteristic’s properties. This
results in the callback function associated with the characteristic
being called; in this case, device_name_read() and data_receive().</p>
<p>When the read only characteristic UUID_GATT_CT_DEVICE_NAME is accessed,
the callback associated when accessing this characteristic
device_name_read() is called.</p>
<p>It passes inno_mqtt as device name to the client reading this
characteristic.</p>
<p>ble.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static bt_att_error_t device_name_read(uint8_t bearer, bt_uuid_t
*uuid, bt_gatt_fcn_t rw, uint8_t *length, uint16_t offset, uint8_t
*data)</p>
<p>{</p>
<p>char device_index_str[15];</p>
<p>snprintf(device_index_str,sizeof(device_index_str),”inno_mqtt”);</p>
<p>uint8_t len = strlen(device_index_str) - offset;</p>
<p>if (offset &gt;= len)</p>
<p>return BT_ATT_ERROR_INVALID_OFFSET;</p>
<p>if (*length &gt; len)</p>
<p>*length = len;</p>
<p>memcpy(data, device_index_str, *length);</p>
<p>os_printf (”\n BLE Device Name Read callback – [%s]\n”,
device_index_str);</p>
<p>return BT_ATT_ERROR_SUCCESS;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>When the write only characteristic UUID_GATT_CT_DEVICE_APPEARANCE is
accessed, the callback associated when accessing this characteristic
data_receive() is called. BLE GATT server receives the text messages
from BLE Client.</p>
<p>ble.c</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static bt_att_error_t</p>
<p>data_receive(uint8_t bearer, bt_uuid_t *uuid, bt_gatt_fcn_t rw,
uint8_t *length, uint16_t offset, uint8_t *data)</p>
<p>{</p>
<p>on_new_message_via_ble((char *)data, *length);</p>
<p>return BT_ATT_ERROR_SUCCESS;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Function on_new_message_via_ble()calls bmw_publish_message() in main.c,
described in section 7.4, and the message written is published to broker
under the topic innophase_&lt;T2 mac id&gt;/publisher.</p>
</section>
<section id="running-the-application-using-mosquitto-projects-test-server">
<h2>Running the Application using Mosquitto Project’s Test Server<a class="headerlink" href="#running-the-application-using-mosquitto-projects-test-server" title="Permalink to this heading"></a></h2>
<p>Eclipse Mosquitto is an open source (EPL/EDL licensed) message broker
that implements the MQTT protocol versions 5.0, 3.1.1 and 3.1.</p>
<p>The Mosquitto project allows to test the MQTT based applications to test
using its test server. Users can use a custom server or any of the
following tested public MQTT brokers:</p>
<ol class="arabic simple">
<li><p>mqtt.eclipseprojects.io</p>
<ol class="loweralpha simple">
<li><p>1883 : MQTT over unencrypted TCP</p></li>
<li><p>8883 : MQTT over encrypted TCP</p></li>
<li><p>80 : MQTT over unencrypted Websocket (note: URL must be <em>/mqtt</em> )</p></li>
<li><p>443: MQTT over encrypted WebSockets (note: URL must be <em>/mqtt</em> )</p></li>
</ol>
</li>
<li><p>mqtt-dashboard.com** **</p>
<ol class="loweralpha simple">
<li><p>TCP Port: 1883</p></li>
<li><p>TLS TCP Port: 8883</p></li>
<li><p>Websocket Port: 8000</p></li>
<li><p>TLS Websocket Port: 8884</p></li>
</ol>
</li>
<li><p>test.mosquitto.org</p>
<ol class="loweralpha simple">
<li><p>1883: MQTT, unencrypted, unauthenticated</p></li>
<li><p>1884: MQTT, unencrypted, authenticated</p></li>
<li><p>8883: MQTT, encrypted, unauthenticated</p></li>
<li><p>8884: MQTT, encrypted, client certificate required</p></li>
<li><p>8080: MQTT over WebSockets, unencrypted, unauthenticated</p></li>
<li><p>8081: MQTT over WebSockets, encrypted, unauthenticated</p></li>
<li><p>8091: MQTT over WebSockets, unencrypted, authenticated</p></li>
</ol>
</li>
</ol>
<p><strong>Note</strong>: test.mosquitto.org is used in this document for illustration
purposes only.</p>
<p>The following steps describes the procedure to test the ble_wifi_bridge
application using Mosquitto project’s test server.</p>
</section>
<section id="installing-and-running-the-mosquitto-mqtt-tool">
<h2>Installing and Running the Mosquitto MQTT Tool<a class="headerlink" href="#installing-and-running-the-mosquitto-mqtt-tool" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Download
<a class="reference external" href="file:///C:C:Users91963Downloadsmosquitto-2.0.11-install-windows-x64.exe">mosquitto-2.0.11-install-windows-x64.exe</a>
from <a class="reference external" href="https://mosquitto.org/download/">https://mosquitto.org/download/</a> and install the same</p></li>
<li><p>Open a command prompt window on the PC and subscribe to a topic by
issuing the following command:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_sub.exe -h test.mosquitto.org -p 1883 -u &lt;user name&gt; -P
&lt;Password&gt; -t T2_&lt;mac_id&gt;/publisher</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Ensure that the note in section 7.4 is followed and the binary is
generated.</p>
<p>In the example, username and password used is innophase. The pub/sub
topics are computed by the application for Talaria TWO module. For
this example they are: T2_e0693a015b2/publisher and
T2_e0693a015b2/subscribe. Ensure to check the console logs on the
Download Tool for the publish/subscribe topics based on the unique
MQTT client id generated for the Talaria TWO device.</p>
<p>Figure 1 shows the command prompt window:</p>
<p><a class="reference internal" href="../../_images/image110.png"><img alt="image1" src="../../_images/image110.png" style="width: 6.51736in; height: 0.24236in;" /></a></p>
</div></blockquote>
<p>Figure 1: Command prompt window</p>
</section>
<section id="programming-the-talaria-two-module">
<h2>Programming the Talaria TWO Module<a class="headerlink" href="#programming-the-talaria-two-module" title="Permalink to this heading"></a></h2>
<p>Program
wifi_ble_mqtt.elf<em>(freertos_sdk_x.y\examples\ble_wifi_bridge\bin)</em>
using the Download tool:</p>
<ol class="arabic simple">
<li><p>Launch the Download tool provided with InnoPhase Talaria TWO SDK.</p></li>
<li><p>In the GUI window:</p>
<ol class="loweralpha simple">
<li><p>Boot Target: Select the appropriate EVK from the drop-down</p></li>
<li><p>ELF Input: Load the ELF by clicking on Select ELF File.</p></li>
<li><p>AP Options: Provide the SSID and Passphrase under AP Options to
connect to an Access Point.</p></li>
<li><p>Boot arguments: Pass the following boot arguments:</p></li>
</ol>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.org,cloud_port=1883,cloud_usr_name=&lt;user
name &gt;,cloud_usr_psw=&lt;password&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="loweralpha simple" start="5">
<li><p>Programming: Prog RAM or Prog Flash as per requirement.</p></li>
</ol>
<p>The console should display a return value of 0 indicating that the
Talaria TWO is able to connect to test.mosquitto.org server.</p>
<p>Console output:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PWWWWWWWAE</p>
<p>Build $Id: git-e52d93e $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0080-0055-ffffffffffff</p>
<p>Bootargs: ssid=Rczz_2.4G <a class="reference external" href="mailto:passphrase=rc&#37;&#52;&#48;9980044013">passphrase=rc<span>&#64;</span>9980044013</a>
cloud_usr_name=innophase cloud_usr_psw=innophase
cloud_url=mqtt.eclipseprojects.io</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>Ble Wifi Bridge Demo App</p>
<p>addr e0:69:3a:00:08:38</p>
<p>network profile created for ssid: Rczz_2.4G</p>
<p>Connecting to added network : Rczz_2.4G</p>
<p>[0.920,765] CONNECT:70:4f:57:4a:fc:85 Channel:11 rssi:-57 dBm</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_LINK_UP</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_ADDRESS</p>
<p>[1.648,724] MYIP 192.168.0.116</p>
<p>[1.648,888] IPv6 [fe80::e269:3aff:fe00:838]-link</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_CONNECTED</p>
<p>Connected to added network : Rczz_2.4G</p>
<p>/home/osboxes/Work/Freertos/dev/freertos_embed
ded_apps/components/mqtt/platform/mqtt_nw_tcp.c:MQTTNetworkConnectmac
id:e0693a0838</p>
<p>MQTT Client id : T2_e0693a0838</p>
<p>MQTT publish topic: T2_e0693a0838/subscribe</p>
<p>MQTT subscribe topic: T2_e0693a0838/publisher</p>
<p>***MQTT Client id is T2_e0693a0838</p>
<p>Connecting to mqtt.eclipseprojects.io:1883</p>
<p>_mqtt_cycle : packet_type = 2Connected to
mqtt.eclipseprojects.io:1883 ret:0</p>
<p>starting subscriber_publisher_thread</p>
<p>BLE Device Name Read callback – [inno_mqtt]</p>
<p>_mqtt_cycle : packet_type = 9[37.233,796] BT connect[0]:
ia:72:1e:ff:02:d9:73 aa:00:00:00:00:00:00 phy2:0/0 phyC:00</p>
<p>connected!</p>
<p>BLE Device Name Read callback – [inno_mqtt]</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="publishing-a-topic-and-sending-data-from-ble-to-wi-fi">
<h2>Publishing a Topic and Sending Data from BLE to Wi-Fi<a class="headerlink" href="#publishing-a-topic-and-sending-data-from-ble-to-wi-fi" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Open the BLE application on the mobile phone and click on the Scan
button at the top right corner. Look for the device inno_mqtt.</p></li>
</ol>
<blockquote>
<div><p><strong>Note</strong>: In the example, a mobile application called nRF Connect for
Mobile, developed by Nordic Semiconductor ASA is used.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Click on the CONNECT button adjacent to the device name inno_mqtt to
connect to the device. This will show the GATT services and custom
service (shown as unknown service in nRF Connect app) in a new
window.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image2.jpeg"><img alt="image2" src="../../_images/image2.jpeg" style="width: 3.14931in; height: 5.42014in;" /></a></p>
</div></blockquote>
<p>Figure 2: Publishing a topic - Connecting to inno_mqtt</p>
<ol class="arabic simple" start="3">
<li><p>Click on GENRIC ACCESS-&gt;WRITE as shown in Figure 3.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image3.jpeg"><img alt="image3" src="../../_images/image3.jpeg" style="width: 3.14931in; height: 5.6in;" /></a></p>
</div></blockquote>
<p>Figure 3: Publishing a topic - Generic Access - W</p>
<ol class="arabic simple" start="4">
<li><p>Sending a message using the nRF Connect app: Select the message type
from the drop-down, write a message and click SEND.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image4.jpeg"><img alt="image4" src="../../_images/image4.jpeg" style="width: 1.57431in; height: 2.72431in;" /></a><a class="reference internal" href="../../_images/image5.jpeg"><img alt="image5" src="../../_images/image5.jpeg" style="width: 1.575in; height: 2.72431in;" /></a></p>
</div></blockquote>
<p>Figure 4: Selecting message type</p>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image62.jpeg"><img alt="image6" src="../../_images/image62.jpeg" style="width: 2.75556in; height: 4.23542in;" /></a></p>
</div></blockquote>
<p>Figure 5: Sending a message</p>
<ol class="arabic simple" start="5">
<li><dl class="simple">
<dt>If message size is more than 30bytes, it is required to change the</dt><dd><p>MTU size in nRF Connect Mobile application.</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image72.png"><img alt="image7" src="../../_images/image72.png" style="width: 2.75591in; height: 2.78108in;" /></a><a class="reference internal" href="../../_images/image82.png"><img alt="image8" src="../../_images/image82.png" style="width: 2.75591in; height: 2.74355in;" /></a></p>
</div></blockquote>
<p>Figure 6: Changing MTU size</p>
<ol class="arabic simple" start="6">
<li><dl class="simple">
<dt>The message will be published by Talaria TWO and the same is observed</dt><dd><p>on the Download Tool’s console window as well indicating that the
message was successfully published.</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image92.png"><img alt="image9" src="../../_images/image92.png" style="width: 6.29921in; height: 0.67756in;" /></a></p>
</div></blockquote>
<p>Figure 7: Publishing a topic - Output</p>
<ol class="arabic simple" start="7">
<li><dl class="simple">
<dt>The published message by Talaria TWO can be seen on the subscriber’s</dt><dd><p>command prompt window opened during step 2 of section 8.1.</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image102.png"><img alt="image10" src="../../_images/image102.png" style="width: 6.29921in; height: 0.24723in;" /></a></p>
</div></blockquote>
<p>Figure 8: Publishing a topic - Command prompt output</p>
</section>
<section id="subscribing-to-a-topic-and-sending-data-from-wi-fi-to-ble">
<h2>Subscribing to a Topic and Sending Data from Wi-Fi to BLE<a class="headerlink" href="#subscribing-to-a-topic-and-sending-data-from-wi-fi-to-ble" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Open the BLE application on the mobile phone and click on the Scan
button at the top right corner and look for the device inno_mqtt.</p></li>
</ol>
<blockquote>
<div><p><strong>Note</strong>: In the example, a mobile application called nRF Connect for
Mobile, developed by Nordic Semiconductor ASA is used.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Click on the CONNECT button adjacent to the device name inno_mqtt to
connect to the device. This will show the GATT services and custom
service (shown as unknown service in nRF connect app) in a new
window.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image2.jpeg"><img alt="image11" src="../../_images/image2.jpeg" style="width: 3.14931in; height: 5.42431in;" /></a></p>
</div></blockquote>
<p>Figure 9: Subscribing to a topic - Connecting to inno_mqtt</p>
<ol class="arabic simple" start="3">
<li><p>Click on Unknown Service (Download symbol) as shown in Figure 10.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image112.png"><img alt="image12" src="../../_images/image112.png" style="width: 3.14931in; height: 2.89792in;" /></a></p>
</div></blockquote>
<p>Figure 10: Subscribing to a topic - Generic Access - I</p>
<ol class="arabic simple" start="4">
<li><p>Publish a message from any MQTT client to the topic
T2_&lt;mac_id&gt;/publisher. The publish topic computed by the application
for Talaria TWO module used in this application is
T2_e0693a015b2/publisher.</p></li>
</ol>
<blockquote>
<div><p>Ensure to check the console logs on the Download Tool for the publish
topic based on the unique MQTT client id generated for the Talaria
TWO device.</p>
<p><a class="reference internal" href="../../_images/image122.png"><img alt="image13" src="../../_images/image122.png" style="width: 6.29921in; height: 0.48836in;" /></a></p>
</div></blockquote>
<p>Figure 11: Publishing a message from MQTT client</p>
<ol class="arabic simple" start="5">
<li><p>Since Talaria TWO device has subscribed to the topic
T2_e0693a015b2/subscribe, the subscribe topic computed by the
application for one of the Talaria TWO module is
T2_e0693a015b2/subscribe. Ensure to check the console logs on the
Download Tool for the subscribe topic based on the unique MQTT client
ID generated for the Talaria TWO device. The same can be observed on
Talaria TWO’s console:</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image131.png"><img alt="image14" src="../../_images/image131.png" style="width: 6.29921in; height: 0.42036in;" /></a></p>
</div></blockquote>
<p>Figure 12: Subscribing to a topic - output</p>
<ol class="arabic simple" start="6">
<li><p>Talaria TWO sends the received message over BLE to the BLE client.
This message will be displayed on the nRF connect app.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image142.png"><img alt="image15" src="../../_images/image142.png" style="width: 3.14931in; height: 2.92431in;" /></a></p>
</div></blockquote>
<p>Figure 13: Message sent to BLE Client over BLE</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Example_for_Audio_over_I2S.html" class="btn btn-neutral float-left" title="Audio Over I2S" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Example_for_Crash_handling.html" class="btn btn-neutral float-right" title="Crash Handling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 InnoPhase IoT, Inc. | All Rights Reserved | Proprietary &amp; Confidential.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>