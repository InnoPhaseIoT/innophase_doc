<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MQTT &mdash; InnoPhase 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Pulse Width Modulation" href="Example_for_Pulse_Width_Modulation.html" />
    <link rel="prev" title="LPS Scan" href="Example_for_LPScan.html" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="../../_static/js/custom.js" defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            InnoPhase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Getting%20Started/Getting%20Started%20-%20Landing%20Page.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware%20Reference/Hardware-Reference.html">Hardware-Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Porting%20Guide/Porting-Guide.html">Porting-Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Disclaimers/Disclaimers.html">Disclaimer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Appendix/Appendix-Landing_Page.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Support/Support.html">Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Software%20Reference/Software_Reference_Landing_Page.html">Software Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Development%20Environments/Development%20Environments%20-%20Landing%20Page.html">Development Environments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Tools/Tools-landing%20page.html">Tools</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#apps">Apps</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#examples">Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Example_for_Analog_to_Digital_Converter.html">Analog to Digital Converter (ADC)</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Audio_over_I2S.html">Audio Over I2S</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_BLE_WiFi_Bridge.html">BLE WiFi Bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Crash_handling.html">Crash Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_I2C.html">I2C</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_LPScan.html">LPS Scan</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">MQTT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mq-telemetry-transport-protocol">MQ Telemetry Transport Protocol</a></li>
<li class="toctree-l4"><a class="reference internal" href="#relevant-apis">Relevant APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqtt-apis">MQTT APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkinit">MQTTNetworkInit()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkinit-tls">MQTTNetworkInit_Tls()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkconnect">MQTTNetworkConnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkconnect-tls">MQTTNetworkConnect_Tls()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkdisconnect">MQTTNetworkDisconnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkdisconnect-tls">MQTTNetworkDisconnect_Tls()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttclientinit">MQTTClientInit()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttconnect">MQTTConnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttdisconnect">MQTTDisconnect()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttpublish">MQTTPublish()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttsubscribe">MQTTSubscribe()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttunsubscribe">MQTTUnsubscribe()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttyield">MQTTYield()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnopollinit">MQTTNoPollInit()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkinit-ws">MQTTNetworkInit_Ws ()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mqttnetworkconnect-ws">MQTTNetworkConnect_Ws ()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-flow">Application Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-walkthrough">Code Walkthrough</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mounting-the-filesystem">Mounting the Filesystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reading-the-boot-argument">Reading the Boot Argument</a></li>
<li class="toctree-l4"><a class="reference internal" href="#selecting-the-transport-mode">Selecting the Transport Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connecting-to-a-wi-fi-network">Connecting to a Wi-Fi Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initializing-mqtt-client">Initializing MQTT Client</a></li>
<li class="toctree-l4"><a class="reference internal" href="#publishing-data-to-the-mqtt-instance">Publishing Data to the MQTT Instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#subscribing-to-mqtt-topic">Subscribing to MQTT Topic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#last-will-testament">Last Will &amp; Testament</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-application-using-mosquitto-projects-test-server">Running the Application using Mosquitto Project’s Test Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-and-running-the-mosquitto-mqtt-tool">Installing and Running the Mosquitto MQTT Tool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#programming-the-talaria-two-module">Programming the Talaria TWO module</a></li>
<li class="toctree-l4"><a class="reference internal" href="#publishing-the-message">Publishing the Message</a></li>
<li class="toctree-l4"><a class="reference internal" href="#subscribing-to-a-topic">Subscribing to a Topic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#evaluating-lwt-feature">Evaluating LWT Feature</a></li>
<li class="toctree-l4"><a class="reference internal" href="#evaluating-websocket-feature">Evaluating Websocket Feature</a></li>
<li class="toctree-l4"><a class="reference internal" href="#evaluating-the-application-using-mosquitto-local-server">Evaluating the Application using Mosquitto Local Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-secured">Non-secured</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secured">Secured</a></li>
<li class="toctree-l4"><a class="reference internal" href="#key-and-certificate-generation-for-secured-local-server">Key and Certificate Generation for Secured Local Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#programing-talaria-two">Programing Talaria TWO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#certificates-validity-assessment">Certificates Validity Assessment</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Pulse_Width_Modulation.html">Pulse Width Modulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Radio_and_Module_Parameters.html">Radio and Module Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Secure_Files.html">Secure Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Socket_Wakeup.html">Socket Wakeup</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Software_SPI_Master.html">Software SPI Master</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_Chip_Monitor.html">Chip Monitor</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_Filesystem.html">Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_GPIO.html">GPIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_SNTP.html">SNTP</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_WiFi.html">WIFI</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_WiFi_Power_Management.html">WiFi Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_BLE_5_0.html">BLE 5.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_BLE_Beacons.html">BLE Beacon</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Custom_ATCMDLIB.html">Custom ATCMDLIB</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_HTTP_Client.html">HTTP Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_IFTTT.html">IFTTT</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Low_Power_UART.html">Low Power UART</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_mDNS.html">mDNS</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html">Provisioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#scan-data">Scan Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#configuration-data-format">Configuration Data Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#service">Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#characteristics">Characteristics</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#application-flow">Application Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#sample-code-walkthrough">Sample Code Walkthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#write-the-provisioning-file-into-talaria-two-filesystem">Write the Provisioning File into Talaria TWO Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#programming-talaria-two-board-with-elf">Programming Talaria TWO board with ELF</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#running-the-application-using-android-or-ios-app">Running the Application using Android or iOS App</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Unassociated_Mode.html">Unassociated Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Watchdog_Timer.html">Watchlog Timer</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_WCM_Multi_AP.html">WCM Multi AP</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Websock_Client.html">Websock Client</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Regulatory%20Notices/Regulatory%20Notices.html">FCC/ISED Regulatory Notices</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Security/Security%20-%20Landing%20Page.html">Security</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">InnoPhase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Applications%20-%20Landing%20Page.html">Applications</a></li>
      <li class="breadcrumb-item active">MQTT</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Applications/2. Examples/Example_for_MQTT.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mqtt">
<h1>MQTT<a class="headerlink" href="#mqtt" title="Permalink to this heading"></a></h1>
<p>This application note describes the accompanying example code in which
Talaria TWO publishes a text message to a MQTT Broker and subscribes to
a topic and displays the received message over Talaria TWO’s console.
The application can be evaluated in secure and non-secure modes of MQTT
operations.</p>
<section id="mq-telemetry-transport-protocol">
<h2>MQ Telemetry Transport Protocol<a class="headerlink" href="#mq-telemetry-transport-protocol" title="Permalink to this heading"></a></h2>
<p>MQTT is a messaging protocol based on publish-subscribe pattern. It
works on top of the TCP/IP protocol and is used in internet of things.</p>
<p>The publish-subscribe paradigm is event-driven, and messages are pushed
to the clients. It requires an additional central point, called MQTT
Broker, which takes care of dispatching all the messages between the
senders and the rightful receivers.</p>
<p>When the clients publish messages to the broker, they include a topic
into the message. For the broker, the topic acts as the routing
information. Each client that wants to receive messages subscribes to a
certain topic and the broker takes care of delivering all messages with
the matching topic to the relevant client.</p>
<p>There is no requirement for the clients to know each other directly and
the communication happens only over the topic. This pattern removes the
dependencies of direct connectivity between the data producers and the
data consumers and thus enables scalable solutions.</p>
<p>Apart from this, the protocol has the property of the client side
requiring a small code footprint and less bandwidth, while the MQTT
Broker can do the heavy lifting of receiving messages from thousands of
clients concurrently, filtering and routing each message to the right
client subscribed to the topic.</p>
<p>This makes the MQTT protocol ideal for resource constrained IoT devices,
which need to be bandwidth-efficient and use little battery power.</p>
</section>
<section id="relevant-apis">
<h2>Relevant APIs<a class="headerlink" href="#relevant-apis" title="Permalink to this heading"></a></h2>
</section>
<section id="mqtt-apis">
<h2>MQTT APIs<a class="headerlink" href="#mqtt-apis" title="Permalink to this heading"></a></h2>
</section>
<section id="mqttnetworkinit">
<h2>MQTTNetworkInit()<a class="headerlink" href="#mqttnetworkinit" title="Permalink to this heading"></a></h2>
<p>Initializes MQTT network object with socket read, write, and disconnect
functions.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTNetworkInit(MQTTNetwork* n)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkinit-tls">
<h2>MQTTNetworkInit_Tls()<a class="headerlink" href="#mqttnetworkinit-tls" title="Permalink to this heading"></a></h2>
<p>Initializes MQTT network object with socket read, write, and disconnect
functions for TLS.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTNetworkInit_Tls(MQTTNetwork*);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkconnect">
<h2>MQTTNetworkConnect()<a class="headerlink" href="#mqttnetworkconnect" title="Permalink to this heading"></a></h2>
<p>Opens a socket and tries to connect the MQTT network object to the
network endpoint.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTNetworkConnect(MQTTNetwork* n, char* addr, int port)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkconnect-tls">
<h2>MQTTNetworkConnect_Tls()<a class="headerlink" href="#mqttnetworkconnect-tls" title="Permalink to this heading"></a></h2>
<p>Opens a socket and tries to connect the MQTT network object to the
network endpoint over TLS.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTNetworkConnect_Tls(MQTTNetwork *n, char *host, int port,
ssl_wrap_cfg_t *cfg);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkdisconnect">
<h2>MQTTNetworkDisconnect()<a class="headerlink" href="#mqttnetworkdisconnect" title="Permalink to this heading"></a></h2>
<p>Closes the socket and tries to disconnect the MQTT network object to the
network endpoint.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTNetworkDisconnect(MQTTNetwork *n)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkdisconnect-tls">
<h2>MQTTNetworkDisconnect_Tls()<a class="headerlink" href="#mqttnetworkdisconnect-tls" title="Permalink to this heading"></a></h2>
<p>Closes the socket over TLS and tries to disconnect the MQTT network
object to the network endpoint.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTNetworkDisconnect_Tls(MQTTNetwork*);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttclientinit">
<h2>MQTTClientInit()<a class="headerlink" href="#mqttclientinit" title="Permalink to this heading"></a></h2>
<p>Creates an MQTT client object.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTClientInit(MQTTClient* client, MQTTNetwork* network,
unsigned int command_timeout_ms,unsigned char* sendbuf, size_t
sendbuf_size, unsigned char* readbuf, size_t readbuf_size);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttconnect">
<h2>MQTTConnect()<a class="headerlink" href="#mqttconnect" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT connect packet down the network and waits for a CONNACK.
The network object must be connected to the network endpoint before
calling this.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTConnect(MQTTClient* client, MQTTPacket_connectData*
options);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttdisconnect">
<h2>MQTTDisconnect()<a class="headerlink" href="#mqttdisconnect" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT disconnect packet and closes the connection.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTDisconnect(MQTTClient* client);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttpublish">
<h2>MQTTPublish()<a class="headerlink" href="#mqttpublish" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT publish packet and waits for all acks to complete.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTPublish(MQTTClient* client, const char *topic, MQTTMessage
*message);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttsubscribe">
<h2>MQTTSubscribe()<a class="headerlink" href="#mqttsubscribe" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT subscribe packet and waits for SUBACK before returning.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTSubscribe(MQTTClient* client, const char* topicFilter, enum
QoS qos, MQTTMessageHandler messageHandler);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttunsubscribe">
<h2>MQTTUnsubscribe()<a class="headerlink" href="#mqttunsubscribe" title="Permalink to this heading"></a></h2>
<p>Sends an MQTT unsubscribe packet and waits for UNSUBACK before
returning.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTUnsubscribe(MQTTClient* client, const char* topicFilter);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttyield">
<h2>MQTTYield()<a class="headerlink" href="#mqttyield" title="Permalink to this heading"></a></h2>
<p>MQTT goes to the background for the time (ms) to yield for.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTYield(MQTTClient* client, int time);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnopollinit">
<h2>MQTTNoPollInit()<a class="headerlink" href="#mqttnopollinit" title="Permalink to this heading"></a></h2>
<p>Initializes MQTT without polling for incoming packets. This API blocks
the thread until a message to the subscribed topic is received.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTNoPollInit(void);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkinit-ws">
<h2>MQTTNetworkInit_Ws ()<a class="headerlink" href="#mqttnetworkinit-ws" title="Permalink to this heading"></a></h2>
<p>Initializes the connection handle passed to the API. This API needs to
be called if the intended MQTT connection is over Websocket.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void MQTTNetworkInit_Ws(MQTTNetwork* handle);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="mqttnetworkconnect-ws">
<h2>MQTTNetworkConnect_Ws ()<a class="headerlink" href="#mqttnetworkconnect-ws" title="Permalink to this heading"></a></h2>
<p>Connects to Broker over Websocket. The connection can either be secured
or non-secured.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int MQTTNetworkConnect_Ws(MQTTNetwork* n, websock_config_t *
ws_cfg);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="application-flow">
<h2>Application Flow<a class="headerlink" href="#application-flow" title="Permalink to this heading"></a></h2>
<p>In this application, Talaria TWO is programmed to publish a message to
the MQTT Broker running as a MQTT instance. Talaria TWO also subscribes
to a topic and displays the received message on the console. The
application supports a secured connection over SSL/TLS to the broker and
can connect to the broker(s) with two different MQTT connections.</p>
<p>Following is the application flow:</p>
<ol class="arabic simple">
<li><p>Connect the device to a Wi-Fi network, whose SSID and passphrase are
given as boot arguments while flashing the binary image.</p></li>
<li><p>Connect to the MQTT instance using the URL, port, username, and
password of the cloud which are also given as boot arguments.</p></li>
</ol>
<blockquote>
<div><p>For a secured connection, the URL, port, username, password,
transport mode, path of CA certificate, path of Client certificate,
and path of Client key are provided as boot arguments.</p>
<p>When the mqtt_no_poll boot argument is set to 1, there is no polling
mechanism involved to yield the incoming messages. It is recommended
to set the mqtt_no_poll to 1 to reduce power consumption.</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Subscribe to a topic to receive the messages.</p></li>
<li><p>Publish a message for another topic every 2 seconds.</p></li>
<li><p>The published messages can be seen on the subscriber’s console
window.</p></li>
<li><p>The messages subscribed to the topic can be seen on the Download
tool’s console.</p></li>
</ol>
</section>
<section id="code-walkthrough">
<h2>Code Walkthrough<a class="headerlink" href="#code-walkthrough" title="Permalink to this heading"></a></h2>
</section>
<section id="mounting-the-filesystem">
<h2>Mounting the Filesystem<a class="headerlink" href="#mounting-the-filesystem" title="Permalink to this heading"></a></h2>
<p>The filesystem is mounted to be able to access the certificates required
to perform the SSL/TLS handshake.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>rval = utils_mount_rootfs();</p>
<p>if(0 != rval) {</p>
<p>os_printf(“Error: Mounting rootfs\n”);</p>
<p>return -1;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="reading-the-boot-argument">
<h2>Reading the Boot Argument<a class="headerlink" href="#reading-the-boot-argument" title="Permalink to this heading"></a></h2>
<p>The following bootargs are to be passed to the application while
programming the Talaria TWO with mqtt.elf:</p>
<ol class="arabic simple">
<li><p>SSID and Passphrase of Wi-Fi Network</p></li>
</ol>
<ol class="arabic simple">
<li><p>URL, Port, Username ,Password of the MQTT server and the required
number of MQTT connections.</p></li>
</ol>
<ol class="arabic simple">
<li><p>Transport mode(TCP, TLS or WS), Path of CA certificate, Path of
Client certificate, Path of Client key.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bargs.ssid = os_get_boot_arg_str(“ssid”);</p>
<p>bargs.passphrase = os_get_boot_arg_str(“passphrase”);</p>
<p>bargs.cloud_url = os_get_boot_arg_str(“cloud_url”) ;</p>
<p>bargs.cloud_port = os_get_boot_arg_int(“cloud_port”, 1883);</p>
<p>bargs.cloud_usr_name = os_get_boot_arg_str(“cloud_usr_name”);</p>
<p>bargs.cloud_usr_psw = os_get_boot_arg_str(“cloud_usr_psw”);</p>
<p>bargs.ca_cert = os_get_boot_arg_str(“ca_cert”);</p>
<p>bargs.client_cert = os_get_boot_arg_str(“client_cert”);</p>
<p>bargs.client_key = os_get_boot_arg_str(“client_key”);</p>
<p>bargs.pub_qos = os_get_boot_arg_int(“pub_qos”, 1);</p>
<p>bargs.sub_qos = os_get_boot_arg_int(“sub_qos”, 0);</p>
<p>bargs.transport_mode = os_get_boot_arg_int(“transport_mode”, 0);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>num_conn boot argument allows the user to configure the number of
connections. The application is configured with the following default
value num_conn = 1. By using this boot argument, user can create a
maximum of two connections.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bargs.num_conn = os_get_boot_arg_int(“num_conn”, 1);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>mqtt_no_poll boot argument is set to 1 by default to avoid polling
through boot argument. If the application is enabled with no poll
(mqtt_no_poll = 1), the application does not perform polling and the
MQTT thread blocks until the message is received. Set this flag to
reduce the power consumption.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bargs.mqtt_no_poll = os_get_boot_arg_int(“mqtt_no_poll”, 0);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>websock_url boot argument allows the user to configure the websocket URL
to connect the Talaria TWO websocket client.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>bargs.websock_url = os_get_boot_arg_str(“websock_url”);</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="selecting-the-transport-mode">
<h2>Selecting the Transport Mode<a class="headerlink" href="#selecting-the-transport-mode" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Set transport_mode=0 for unencrypted, unauthenticated connection.</p></li>
<li><p>Set transport_mode=1 for server authentication. This is an encrypted
connection and will require the server certificate.</p></li>
<li><p>Set transport_mode=2 for mutual authentication. This mode also
supports client authentication if the server intends to do so. This
is an encrypted connection and will require a server certificate and
the client certificate.</p></li>
<li><p>Set transport_mode=3 for a secured connection without connection
verification. This connection is encrypted and does not need
certificates.</p></li>
<li><p>Set transport_mode=4 for unencrypted, unauthenticated websocket
connection.</p></li>
<li><p>Set transport_mode=5 for websocket server authentication. This is an
encrypted connection and will require the server certificate. For
websocket server authentication requires a server certificate.</p></li>
<li><p>Set transport_mode=6 for secured websocket no certificate
verification.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>if(bargs-&gt;transport_mode == TCP){</p>
<p>m-&gt;transport = APP_MQTT_TM_TCP;</p>
<p>}else if(bargs-&gt;transport_mode == TLS){</p>
<p>m-&gt;transport = APP_MQTT_TM_TLS;</p>
<p>}else if(bargs-&gt;transport_mode == TLS_CLIENT_VERFIY){</p>
<p>m-&gt;transport = APP_MQTT_TM_TLS;/*With Client Authentication if the</p>
<p>Server forces it*/</p>
<p>}else if(bargs-&gt;transport_mode == TLS_NO_CERT_VERIFY){</p>
<p>m-&gt;transport = APP_MQTT_TM_TLS_NO_CERT_VERIFY;</p>
<p>}else if(bargs-&gt;transport_mode == WEBSOCK){</p>
<p>m-&gt;transport = APP_MQTT_TM_WEBSOCK;</p>
<p>}else if(bargs-&gt;transport_mode == SECURED_WEBSOCK){</p>
<p>m-&gt;transport = APP_MQTT_TM_SECURED_WEBSOCK;</p>
<p>}else if(bargs-&gt;transport_mode == SECURED_WEBSOCK_NO_CERT_VERIFY){</p>
<p>m-&gt;transport = APP_MQTT_TM_SECURED_WEBSOCK_NO_CERT_VERIFY;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="connecting-to-a-wi-fi-network">
<h2>Connecting to a Wi-Fi Network<a class="headerlink" href="#connecting-to-a-wi-fi-network" title="Permalink to this heading"></a></h2>
<p>The wcm_create() API starts creating the Wi-Fi network interface.
wifi_connect_to_network() API connects to the Wi-Fi network. This API
waits indefinitely for the Wi-Fi connection as the argument
WCM_CONN_WAIT_INFINATE is passed.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>h= wcm_create(NULL);</p>
<p>rval = wifi_connect_to_network(&amp;h, WCM_CONN_WAIT_INFINATE,
&amp;wcm_connected);</p>
<p>if(rval &lt; 0) {</p>
<p>os_printf(”\nError: Unable to connect to network\n”);</p>
<p>return 0;</p>
<p>}</p>
<p>if(wcm_connected != true) {</p>
<p>os_printf(”\nCouldn’t Connect to network”);</p>
<p>wcm_disconnect(h);</p>
<p>return -1;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>If the Wi-Fi connection is successful, wcm_connected flag is set to
True.</p>
</section>
<section id="initializing-mqtt-client">
<h2>Initializing MQTT Client<a class="headerlink" href="#initializing-mqtt-client" title="Permalink to this heading"></a></h2>
<p>On successfully establishing a Wi-Fi connection, an application thread
is created to handle the MQTT connection, publish and subscribe
operations. It initiates either the polling based MQTT operation or
non-polling-based operation depending upon the value of the bootarg:
mqtt_no_poll.</p>
<p>The app_mqtt_params_set(&amp;bargs, &amp;mqtt_param_1) function copies the MQTT
configuration data received from the boot arguments variable bargs to
mqtt_param_1. The app_auto_generate_params(&amp;mqtt_param_1, 1) function
generates a unique MQTT client ID based on Talaria TWO’s MAC ID. The
subscribe and publish topics are also generated based on the generated
MQTT client ID.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>if(bargs.mqtt_no_poll){</p>
<p>/*NO Polling for incoming packets*/</p>
<p>MQTTNoPollInit();</p>
<p>}</p>
<p>app_mqtt_params_set(&amp;bargs, &amp;mqtt_param_1);</p>
<p>app_auto_generate_params(&amp;mqtt_param_1, 1);</p>
<p>mqtt_param_2 = mqtt_param_1;</p>
<p>app_auto_generate_params(&amp;mqtt_param_2, 2);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>This application initiates two connection to the broker(s). Hence,
app_auto_generate_params() function is called again to generate another
MQTT client ID, publish and subscribe topics.</p>
<p>app_mqtt_params_set() API copies the MQTT configuration data from
bootargs, selects the appropriate transport mode and provides pointers
to the certificates and the client key.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>m-&gt;cloud_url = bargs-&gt;cloud_url;</p>
<p>m-&gt;cloud_port = bargs-&gt;cloud_port;</p>
<p>m-&gt;cloud_usr_name = bargs-&gt;cloud_usr_name;</p>
<p>m-&gt;cloud_usr_psw = bargs-&gt;cloud_usr_psw;</p>
<p>m-&gt;ca_cert = bargs-&gt;ca_cert;</p>
<p>m-&gt;client_cert = bargs-&gt;client_cert;</p>
<p>m-&gt;client_key = bargs-&gt;client_key;</p>
<p>m-&gt;pub_qos = bargs-&gt;pub_qos;</p>
<p>m-&gt;sub_qos = bargs-&gt;sub_qos;</p>
<p>m-&gt;websock_url = bargs-&gt;websock_url;</p>
<p>m-&gt;mqtt_cmd_timeout = bargs-&gt;mqtt_cmd_timeout;</p>
<p>if(bargs-&gt;transport_mode == TCP){</p>
<p>m-&gt;transport = APP_MQTT_TM_TCP;</p>
<p>}else if(bargs-&gt;transport_mode == TLS){</p>
<p>m-&gt;transport = APP_MQTT_TM_TLS;</p>
<p>}else if(bargs-&gt;transport_mode == TLS_CLIENT_VERFIY){</p>
<p>m-&gt;transport = APP_MQTT_TM_TLS;/*With Client Authentication if the</p>
<p>Server forces it*/</p>
<p>}else if(bargs-&gt;transport_mode == TLS_NO_CERT_VERIFY){</p>
<p>m-&gt;transport = APP_MQTT_TM_TLS_NO_CERT_VERIFY;</p>
<p>}else if(bargs-&gt;transport_mode == WEBSOCK){</p>
<p>m-&gt;transport = APP_MQTT_TM_WEBSOCK;</p>
<p>}else if(bargs-&gt;transport_mode == SECURED_WEBSOCK){</p>
<p>m-&gt;transport = APP_MQTT_TM_SECURED_WEBSOCK;</p>
<p>}else if(bargs-&gt;transport_mode == SECURED_WEBSOCK_NO_CERT_VERIFY){</p>
<p>m-&gt;transport = APP_MQTT_TM_SECURED_WEBSOCK_NO_CERT_VERIFY;</p>
<p>}</p>
<p>m-&gt;cfg.auth_mode = SSL_WRAP_VERIFY_NONE;</p>
<p>if(m-&gt;transport == APP_MQTT_TM_TLS || m-&gt;transport ==
APP_MQTT_TM_SECURED_WEBSOCK){</p>
<p>if(m-&gt;ca_cert !=NULL){</p>
<p>/*CA certificate*/</p>
<p>m-&gt;cfg.ca_cert.buf = utils_file_get(m-&gt;ca_cert, &amp;m-&gt;cfg.ca_cert.len);</p>
<p>if(m-&gt;cfg.ca_cert.buf == NULL){</p>
<p>os_printf(“Provide a valid path for the CA certificate-1\r\n”);</p>
<p>return -2;</p>
<p>}</p>
<p>}else{</p>
<p>os_printf(“Provide a valid path for the CA certificate\r\n”);</p>
<p>return -2;</p>
<p>}</p>
<p>m-&gt;cfg.auth_mode = SSL_WRAP_VERIFY_REQUIRED;</p>
<p>}</p>
<p>if(m-&gt;client_cert != NULL){</p>
<p>/*Client certificate*/</p>
<p>m-&gt;cfg.client_cert.buf = utils_file_get(m-&gt;client_cert,
&amp;m-&gt;cfg.client_cert.len);</p>
<p>if(m-&gt;cfg.client_cert.buf == NULL &amp;&amp; bargs-&gt;transport_mode ==
TLS_CLIENT_VERFIY){</p>
<p>os_printf(“Provide a valid path for client certificate\r\n”);</p>
<p>return -2;</p>
<p>}</p>
<p>}else if(bargs-&gt;transport_mode == TLS_CLIENT_VERFIY){</p>
<p>os_printf(“Provide a valid path for client certificate\r\n”);</p>
<p>return -2;</p>
<p>}</p>
<p>if(m-&gt;client_key != NULL){</p>
<p>/*Client key*/</p>
<p>m-&gt;cfg.client_key.buf = utils_file_get(m-&gt;client_key,
&amp;m-&gt;cfg.client_key.len);</p>
<p>if(m-&gt;cfg.client_key.buf == NULL &amp;&amp; bargs-&gt;transport_mode ==
TLS_CLIENT_VERFIY){</p>
<p>os_printf(“Provide a valid path for Client key\r\n”);</p>
<p>return -2;</p>
<p>}</p>
<p>}else if (bargs-&gt;transport_mode == TLS_CLIENT_VERFIY){</p>
<p>os_printf(“Provide a valid path for Client key\r\n”);</p>
<p>return -2;</p>
<p>}</p>
<p>return 0;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>app_auto_generate_params() calls the app_fetch_t2_macid() function to
fetch Talaria TWO’s MAC ID and generate the MQTT client ID, publish and
subscribe topics based on the generated client ID.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>uint8_t t2_mac_id[LEN_OF_MAC_ID];</p>
<p>char buf[6];</p>
<p>int index = 0;</p>
<p>/*Get MAC ID*/</p>
<p>app_fetch_t2_macid(t2_mac_id);</p>
<p>for (int i=0; i &lt; LEN_OF_MAC_ID; i++){</p>
<p>index += snprintf(&amp;buf[index], 128-index, “%x”, t2_mac_id[i]);</p>
<p>}</p>
<p>snprintf(m-&gt;client_id, MAX_MQTT_CLIENT_ID_LEN, “T2_%s_%d”,buf,
conn_num);</p>
<p>os_printf(”\n%s:%d, size = %d”, __FUNCTION__, __LINE__,
sizeof(m-&gt;publish_topic));</p>
<p>snprintf(m-&gt;publish_topic, MAX_TOPIC_LEN, “%s%s_%d”,</p>
<p>m-&gt;client_id,”/pt2”, conn_num);</p>
<p>snprintf(m-&gt;subscribe_topic, MAX_TOPIC_LEN, “%s%s_%d”,</p>
<p>m-&gt;client_id,”/st2”, conn_num);</p>
<p>m-&gt;mqtt_lwt_enable = 1;</p>
<p>m-&gt;lwt_qos = QOS1;</p>
<p>m-&gt;lwt_retain_enable = 0;</p>
<p>if(conn_num == 1){</p>
<p>m-&gt;lwt_msg_len = strlen(APP_LWT_MESSAGE_1);</p>
<p>strncpy(m-&gt;lwt_topic_name, MQTT_LWT_TOPIC_1, MAX_LWT_TOPIC_LEN);</p>
<p>memcpy((uint8_t*)m-&gt;lwt_message,(uint8_t*)APP_LWT_MESSAGE_1,
m-&gt;lwt_msg_len);</p>
<p>}else{</p>
<p>m-&gt;lwt_msg_len = strlen(APP_LWT_MESSAGE_2);</p>
<p>strncpy(m-&gt;lwt_topic_name, MQTT_LWT_TOPIC_2, MAX_LWT_TOPIC_LEN);</p>
<p>memcpy((uint8_t*)m-&gt;lwt_message,(uint8_t*)APP_LWT_MESSAGE_2,
m-&gt;lwt_msg_len);</p>
<p>}</p>
<p>os_prin
tf(”\r\n————————————————–\r\n”);</p>
<p>os_printf(“T2 MQTT Client id : %s\r\n”,m-&gt;client_id);</p>
<p>os_printf(“T2 MQTT publish topic : %s\r\n”, m-&gt;publish_topic);</p>
<p>os_printf(“T2 MQTT subscribe topic: %s\r\n”, m-&gt;subscribe_topic);</p>
<p>os_printf(“T2 LWT topic : %s\r\n”, m-&gt;lwt_topic_name);</p>
<p><a href="#id1"><span class="problematic" id="id2">os_</span></a>
printf(”—————————————————-\r\n”);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The generated MQTT client ID, Talaria TWO publish topic and the
subscribe topic information is printed on to the console. Users can
publish and subscribe to these topics from the other MQTT clients.</p>
<p>app_fetch_t2_macid()fetches Talaria TWO’s MAC ID by calling
wcm_get_hwaddr() API. Following is the definition of
app_fetch_t2_macid():</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>const uint8_t *mac_addr = wcm_get_hwaddr(h);</p>
<p>os_printf(“mac id:”);</p>
<p>for(int index = 0;index &lt; 6;index++){</p>
<p>mac_id[index] = *(mac_addr+index);</p>
<p>os_printf(“%x”,mac_id[index]);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>app_mqtt_connect()is called and the address of the structure variable of
type app_mqtt_conn_t and struct app_mqtt_param_t are passed.</p>
<p>app_mqtt_connect() initializes the MQTT connection based on the
transport mode configured through the boot argument. The MQTT
application allows the user to configure the connection based on the
mqtt_tranport_mode enum.</p>
<p>The app_mqtt_connect()allocates the required buffers using
app_mqtt_conn_init () and depending on the transport parameter value
selected, the non-secure/secure MQTT network initialization API -
MQTTNetworkInit()/MQTTNetworkInit_Tls() is called followed by
MQTTNetworkConnect/MQTTNetworkConnect_Tls().</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>os_printf(”\n%s %d”, __FUNCTION__, __LINE__);</p>
<p>if(app_mqtt_conn_init(cn) &lt; 0){</p>
<p>goto exit;</p>
<p>}</p>
<p>/*MQTT N/w connect, based on the transport*/</p>
<p>if(m-&gt;transport == APP_MQTT_TM_TCP){</p>
<p>/*Non secured MQTT*/</p>
<p>MQTTNetworkInit(cn-&gt;mqtt_network);</p>
<p>ret = MQTTNetworkConnect(cn-&gt;mqtt_network, (char *)m-&gt;cloud_url,</p>
<p>m-&gt;cloud_port);</p>
<p>if (ret != 0) {</p>
<p>os_printf(“NetworkConnect = %d\n”, ret);</p>
<p>goto exit;}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The MQTT websocket initialization API M MQTTNetworkConnect_Ws() is
called followed by MQTTNetworkInit_Ws() to initialize the
non-secure/secure websocket client connection. websock_config_t contains
all the parameters needed by the websocket.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>else if(m-&gt;transport == APP_MQTT_TM_WEBSOCK ||</p>
<p>m-&gt;transport == APP_MQTT_TM_SECURED_WEBSOCK ||</p>
<p>m-&gt;transport == APP_MQTT_TM_SECURED_WEBSOCK_NO_CERT_VERIFY) {</p>
<p>websock_config_t ws_cfg;</p>
<p>/*Init mqtt*/</p>
<p>MQTTNetworkInit_Ws(cn-&gt;mqtt_network);</p>
<p>/*Connect to broker over websocket*/</p>
<p>memset(&amp;ws_cfg, 0, sizeof(ws_cfg));</p>
<p>os_printf(”\nmqttbroker_address = %s”, m-&gt;cloud_url);</p>
<p>ws_cfg.hostname = (char *)m-&gt;cloud_url;</p>
<p>ws_cfg.uri = (char *)m-&gt;websock_url;</p>
<p>ws_cfg.port = m-&gt;cloud_port;</p>
<p>ws_cfg.time_out = 300;</p>
<p>ws_cfg.secured = (m-&gt;transport == APP_MQTT_TM_WEBSOCK) ? 0 : 1;</p>
<p>memcpy((char *)&amp;ws_cfg.ssl_config,(const char *) &amp;m-&gt;cfg,
sizeof((m-&gt;cfg)));</p>
<p>ret = MQTTNetworkConnect_Ws(cn-&gt;mqtt_network, &amp;ws_cfg);</p>
<p>if(ret &lt; 0) {</p>
<p>os_printf(”\r\nmqtt_connect_ws %d “,</p>
<p>ret);</p>
<p>goto exit;</p>
<p>}</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Then, MQTTClientInit() is called to configure the client connection with
the parameters like time out and the required buffers. MQTT client is
also initiated with the LWT parameters. When the client performs
rough-hewn disconnect, Talaria TWO LWT topic will be published with the
LWT message. MQTTConnect() is called by passing the pointer to the
client configuration and the MQTT packet connect data to connect to a
broker.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>MQTTClientInit(cn-&gt;mqtt_client, cn-&gt;mqtt_network, 15*1000,
cn-&gt;sendbuf,</p>
<p>APP_MQTT_SEND_BUF_SIZE, cn-&gt;readbuf,</p>
<p>APP_MQTT_READ_BUF_SIZE);</p>
<p>MQTTPacket_connectData data = MQTTPacket_connectData_initializer;</p>
<p>data.willFlag = 0;</p>
<p>data.willFlag = m-&gt;mqtt_lwt_enable;</p>
<p>if(data.willFlag) {</p>
<p>data.will.qos = m-&gt;lwt_qos;</p>
<p>data.will.struct_version = 3;</p>
<p>data.will.retained = m-&gt;lwt_retain_enable;</p>
<p>data.will.topicName.lenstring.len = strlen(m-&gt;lwt_topic_name);</p>
<p>data.will.topicName.lenstring.data = m-&gt;lwt_topic_name;</p>
<p>data.will.message.lenstring.len = m-&gt;lwt_msg_len;</p>
<p>data.will.message.lenstring.data = m-&gt;lwt_message;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>data.willFlag is enabled when mqtt_lwt_enable is enabled. LWT client is
configured with QOS1.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>data.MQTTVersion = 3;</p>
<p>data.clientID.cstring = (char *)m-&gt;client_id;</p>
<p>data.username.cstring = (char *)m-&gt;cloud_usr_name;</p>
<p>data.password.cstring = (char *)m-&gt;cloud_usr_psw;</p>
<p>data.keepAliveInterval = APP_MQTT_DEFAULT_KA_INTR;</p>
<p>data.cleansession = APP_MQTT_DEFAULT_CLEAN_SESSION;</p>
<p>data.kaRespTimeout = 0;</p>
<p>os_printf(”\r\nConnecting …\n”);</p>
<p>ret = MQTTConnect(cn-&gt;mqtt_client, &amp;data);</p>
<p>if(0 == ret){</p>
<p>cn-&gt;connected = 1;</p>
<p>os_printf(”\nMQTTConnect Success. ret = %d”, ret);</p>
<p>}else{</p>
<p>os_printf(”\nMQTTConnect Failed. ret = %d”, ret);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>On successfully establishing the MQTT connection, app_thread_entry_fn
thread subscribes to the unique topics generated, by calling
app_subscribe(&amp;c1, &amp;mqtt_param_1). Since there are two connections,
app_subscribe(&amp;c1, &amp;mqtt_param_2) is called again with a different
subscription topic.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/* MQTT connect*/</p>
<p>if(!c1.connected){</p>
<p>app_mqtt_connect(&amp;c1, &amp;mqtt_param_1);</p>
<p>/* MQTT Subscribe*/</p>
<p>app_subscribe(&amp;c1, &amp;mqtt_param_1);</p>
<p>}</p>
<p>/* MQTT connect - a second connection*/</p>
<p>if(bargs.num_conn == 2 &amp;&amp; !c2.connected){</p>
<p>app_mqtt_connect(&amp;c2, &amp;mqtt_param_2);</p>
<p>/* MQTT Subscribe*/</p>
<p>app_subscribe(&amp;c2, &amp;mqtt_param_2);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>app_subscribe() function calls MQTTSubscribe() API to subscribe to the
given topic and register a callback.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>MQTTSubscribe(cn-&gt;mqtt_client, m-&gt;subscribe_topic,</p>
<p>m-&gt;qos, app_mqtt_subscribe_cb);</p>
<p>return 0;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Here, the callback function, app_mqtt_subscribe_cb gets invoked when a
message is received from the broker of the subscribed topic. The
callback extracts the topic name, topic length and the message payload.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void app_mqtt_subscribe_cb(MessageData* Msg)</p>
<p>{</p>
<p>int i;</p>
<p>os_printf(”\nMQTTSubscribe Call back”);</p>
<p>if(Msg-&gt;topicName-&gt;cstring){</p>
<p>os_printf(”\n\ttopic = %s”, Msg-&gt;topicName-&gt;cstring);</p>
<p>}else{</p>
<p>os_printf(”\n\ttopic = “);</p>
<p>for(i= 0; i &lt; Msg-&gt;topicName-&gt;lenstring.len; i++)</p>
<p>os_printf(“%c”, Msg-&gt;topicName-&gt;lenstring.data[i]);</p>
<p>os_printf(”\n”);</p>
<p>}</p>
<p>os_printf(”\n\tMessage = “);</p>
<p>char *p= Msg-&gt;message-&gt;payload;</p>
<p>for(i= 0; i &lt; Msg-&gt;message-&gt;payloadlen; i++)</p>
<p>os_printf(“%c”, p[i]);</p>
<p>os_printf(”\n”);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Now, app_thread_entry_fn thread publishes the messages to both the
connections by calling app_mqtt_publish() function. The thread publishes
data every 1 second.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>if(c1.connected){</p>
<p>app_mqtt_publish(&amp;c1, &amp;mqtt_param_1, “Hello From T2”);</p>
<p>}</p>
<p>if(c2.connected){</p>
<p>os_printf(”\n%s:%d”, __FUNCTION__, __LINE__);</p>
<p>app_mqtt_publish(&amp;c2, &amp;mqtt_param_2, “Hello From T2”);</p>
<p>}</p>
<p>os_msleep(1000);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>app_mqtt_init() API Initializes MQTT. The client connects to the broker
with the specific protocol based on transport mode specified in boot
argument (tcp/tls).</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>if(app_mqtt_parse_params(param) == 0){</p>
<p>if(param.cloud_url == NULL || param.cloud_port == 0 ){</p>
<p>return -1;</p>
<p>}</p>
<p>os_printf(”\nparam parsing done…”);</p>
<p>/* Initialize the mqtt</p>
<p>*/</p>
<p>if(app_mqtt_init() &lt; 0){</p>
<p>return -1;</p>
<p>}</p>
<p>mqtt_network = os_alloc(sizeof(MQTTNetwork));</p>
<p>if (NULL == mqtt_network) {</p>
<p>os_printf(”\nMalloc Fail &#64;%s:%d”, __FUNCTION__,</p>
<p>__LINE__);</p>
<p>return -1;</p>
<p>}</p>
<p>mqtt_client = os_alloc(sizeof(MQTTClient));</p>
<p>if(NULL == mqtt_client){</p>
<p>os_printf(”\nMalloc Fail &#64;%s:%d”, __FUNCTION__,</p>
<p>__LINE__);</p>
<p>return -1;</p>
<p>}</p>
<p>if(param.transport == APP_MQTT_TRANSPORT_TCP){</p>
<p>/*Non secured MQTT*/</p>
<p>MQTTNetworkInit(mqtt_network);</p>
<p>ret = MQTTNetworkConnect(mqtt_network, (char *)param.cloud_url,
param.cloud_port);</p>
<p>if (ret != 0) {</p>
<p>os_printf(“NetworkConnect = %d\n”, ret);</p>
<p>return -3;</p>
<p>}</p>
<p>}else if((param.transport == APP_MQTT_TRANSPORT_TLS) ||
(param.transport == APP_MQTT_TRANSPORT_TLS_NO_CERT_VERIFY)){</p>
<p>/*Secured MQTT*/</p>
<p>MQTTNetworkInit_Tls(mqtt_network);</p>
<p>ret = MQTTNetworkConnect_Tls(mqtt_network,
(char*)param.cloud_url,param.cloud_port,&amp;cfg);</p>
<p>if (ret &lt; 0) {</p>
<p>os_printf(”\r\nmqtt_connect_tls %d !!”, ret);</p>
<p>return -3;</p>
<p>}</p>
<p>}else{</p>
<p>os_printf(“Set proper MQTT Transport mode\r\n”);</p>
<p>}}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Mqttclientinit() API initializes the MQTT Client. This API is called
with the MQTT network object mqtt_network, pointers to read, send
buffers and the MQTTClient handle mqtt_client as arguments.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>MQTTClientInit(mqtt_client, mqtt_network, 15*1000, sendbuf,
STW_MQTT_SEND_BUF_SIZE, readbuf, STW_MQTT_READ_BUF_SIZE);</p>
<p>MQTTPacket_connectData data = MQTTPacket_connectData_initializer;</p>
<p>data.willFlag = 0;</p>
<p>data.MQTTVersion = 3;</p>
<p>data.clientID.cstring = (char *)mqtt_param.client_id;</p>
<p>data.username.cstring = (char *)mqtt_param.cloud_usr_name;</p>
<p>data.password.cstring = (char *)mqtt_param.cloud_usr_psw;</p>
<p>data.keepAliveInterval = STW_MQTT_DEFAULT_KA_INTR;</p>
<p>data.kaRespTimeout = 20;</p>
<p>data.cleansession = STW_MQTT_DEFAULT_CLEAN_SESSION;</p>
<p>os_printf(”\r\nConnecting …\n”);</p>
<p>ret = MQTTConnect(mqtt_client, &amp;data);</p>
<p>os_printf(”\nMQTTConnect ret = %d”, ret);</p>
<p>return ret;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>[data.kaRespTimeout = 20] keepalive ensures the connection between the
broker and client is still open and that the broker and the client are
aware of being connected.</p>
</section>
<section id="publishing-data-to-the-mqtt-instance">
<h2>Publishing Data to the MQTT Instance<a class="headerlink" href="#publishing-data-to-the-mqtt-instance" title="Permalink to this heading"></a></h2>
<p>Function app_mqtt_publish_message() takes a pointer to the message, a
pointer to the topic, the length of a message as arguments and publishes
it to the remote MQTT Broker running a MQTT instance.</p>
<p>The message is published under the topic T2_&lt;mac id of T2&gt;/publisher.
MQTTPublish()API is used to publish a message. The MQTT client ID,
publish topic and subscribe topic are unique to the Talaria TWO module.</p>
<p>For example, MQTT client ID computed for Talaria TWO module is
T2_e0693a02dfa. Hence, Talaria TWO’s publish topic is
T2_e0693a02dfa/subscribe and the subscribe topic is
T2_e0693a02dfa/publisher. These details are displayed on the Download
Tool’s console.</p>
<p>Commands to publish and subscribe to the given topic are as follows:</p>
<p>Subscribing to a topic from a host(PC):</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_sub.exe -h test.mosquitto.org -p 1883 -u &lt;user name&gt; -P
&lt;Password&gt; -t T2_&lt;mac id of T2&gt;/subscribe</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Publishing data to the given topic :</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_pub.exe -h test.mosquitto.org -p 1883 -u &lt;user name&gt; -P
&lt;Password&gt; -t T2_&lt;mac id of T2&gt;/publisher -m “Message to Publish”</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Note</strong>: The actual MQTT Client ID, publish and subscribe topics are
computed by the application and displayed on the Download Tool’s
console.</p>
<p>app_mqtt_publish_message() publishes the MQTT messages to the server.
The pmessage contains the address of the buffer that contains the
message to be published. The length variable contains the length of the
publish message.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>char device_data_recieved[MAX_PUBLISH_MSG_SIZE];</p>
<p>if(len &lt; MAX_PUBLISH_MSG_SIZE){</p>
<p>/* Message is published under the topic innophase_t2/temperature.</p>
<p>MQTTPublish()is used for this. */</p>
<p>MQTTMessage *publish = os_zalloc(sizeof(MQTTMessage));</p>
<p>publish-&gt;payload = pmessage;</p>
<p>publish-&gt;payloadlen = len;</p>
<p>/* As we are restarting provisioning, reset the housekeeping</p>
<p>and status mssg to default value ‘waiting’. */</p>
<p>memcpy(device_data_recieved, pmessage, len);</p>
<p>device_data_recieved[len]=’\0’;</p>
<p>rc = MQTTPublish(mqtt_client, pub_topic, publish);</p>
<p>if(rc != 0)</p>
<p>{</p>
<p>os_printf(”\nMQTTPublish failed. Ret= %d”, rc);</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p>os_printf(”\n%u:Message published successfully [%s]”,os_systime(),
device_data_recieved);</p>
<p>}</p>
<p>os_free(publish);</p>
<p>}else{</p>
<p>os_printf(”\n Could not publish the message. Please send a message
less than 248 bytes”);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="subscribing-to-mqtt-topic">
<h2>Subscribing to MQTT Topic<a class="headerlink" href="#subscribing-to-mqtt-topic" title="Permalink to this heading"></a></h2>
<p>Function app_subscribe() subscribes to a topic and registers the call
back function app_mqtt_subscribe_cb(MessageData* Msg). The call back
gets invoked when there is a message published by a client on the same
topic.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>os_printf(”\n%s:%d”, __FUNCTION__, __LINE__);</p>
<p>MQTTSubscribe(cn-&gt;mqtt_client, m-&gt;subscribe_topic,</p>
<p>m-&gt;sub_qos, app_mqtt_subscribe_cb);</p>
<p>os_printf(”\n%s: %d”, __FUNCTION__, __LINE__);</p>
<p>return 0;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>In the main function, app_subscribe() is called once to register a
handler for MQTT subscribe and app_mqtt_publish() is called every two
seconds to publish a message.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int i;</p>
<p>os_printf(”\nMQTTSubscribe Call back”);</p>
<p>if(Msg-&gt;topicName-&gt;cstring){</p>
<p>os_printf(”\n\ttopic = %s”, Msg-&gt;topicName-&gt;cstring);</p>
<p>}else{</p>
<p>os_printf(”\n\ttopic = “);</p>
<p>for(i= 0; i &lt; Msg-&gt;topicName-&gt;lenstring.len; i++)</p>
<p>os_printf(“%c”, Msg-&gt;topicName-&gt;lenstring.data[i]);</p>
<p>os_printf(”\n”);</p>
<p>}</p>
<p>os_printf(”\n\tMessage = “);</p>
<p>char *p= Msg-&gt;message-&gt;payload;</p>
<p>for(i= 0; i &lt; Msg-&gt;message-&gt;payloadlen; i++)</p>
<p>os_printf(“%c”, p[i]);</p>
<p>os_printf(”\n”);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="last-will-testament">
<h2>Last Will &amp; Testament<a class="headerlink" href="#last-will-testament" title="Permalink to this heading"></a></h2>
<p>In MQTT, Last Will and Testament (LWT) is used to notify other clients
about a rough-hewn disconnected client. All the clients can specify
their last-will message when it connects to a broker. The last-will
message is a normal MQTT message with a topic, retained message flag,
QoS, and payload.</p>
<p>The broker stores the message until it detects that the client has
disconnected ungracefully. In response to the rough-hewn disconnect, the
broker sends the last-will message to all subscribed clients of the
last-will message topic.</p>
<p>If the client disconnects gracefully with a correct DISCONNECT message,
the broker discards the stored LWT message.</p>
<p>LWT publish topics and messages are defined in the application.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*last will topics for connections*/</p>
<p>#define MQTT_LWT_TOPIC_1 “will_con1”</p>
<p>#define MQTT_LWT_TOPIC_2 “will_con2”</p>
<p>/*LWT messages*/</p>
<p>#define APP_LWT_MESSAGE_1 “Connection-1 Terminated”</p>
<p>#define APP_LWT_MESSAGE_2 “Connection-1 Terminated”</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>If Talaria TWO client disconnects with a rough-hewn disconnect, the
server publishes LWT messages defined in the application to all the LWT
topics after 90 seconds, as Talaria TWO has a default keepalive of 60
seconds. Hence, the server will wait for a period of 90 seconds to
ensure the connection is lost.</p>
</section>
<section id="running-the-application-using-mosquitto-projects-test-server">
<h2>Running the Application using Mosquitto Project’s Test Server<a class="headerlink" href="#running-the-application-using-mosquitto-projects-test-server" title="Permalink to this heading"></a></h2>
<p>Eclipse Mosquitto is an open source (EPL/EDL licensed) message broker
that implements the MQTT protocol versions 5.0, 3.1.1 and 3.1.</p>
<p>The Mosquitto project allows to test the MQTT based applications to test
using its test server. Users can use a custom server or any of the
following tested public MQTT brokers:</p>
<ol class="arabic simple">
<li><p>mqtt.eclipseprojects.io</p>
<ol class="loweralpha simple">
<li><p>1883 : MQTT over unencrypted TCP</p></li>
<li><p>8883 : MQTT over encrypted TCP</p></li>
<li><p>80 : MQTT over unencrypted Websocket (note: URL must be <em>/mqtt</em> )</p></li>
<li><p>443: MQTT over encrypted WebSockets (note: URL must be <em>/mqtt</em> )</p></li>
</ol>
</li>
<li><p>mqtt-dashboard.com</p>
<ol class="loweralpha simple">
<li><p>TCP Port: 1883</p></li>
<li><p>TLS TCP Port: 8883</p></li>
<li><p>Websocket Port: 8000</p></li>
<li><p>TLS Websocket Port: 8884</p></li>
</ol>
</li>
<li><p>test.mosquitto.org</p>
<ol class="loweralpha simple">
<li><p>1883: MQTT, unencrypted, unauthenticated</p></li>
<li><p>1884: MQTT, unencrypted, authenticated</p></li>
<li><p>8883: MQTT, encrypted, unauthenticated</p></li>
<li><p>8884: MQTT, encrypted, client certificate required</p></li>
<li><p>8080: MQTT over WebSockets, unencrypted, unauthenticated</p></li>
<li><p>8081: MQTT over WebSockets, encrypted, unauthenticated</p></li>
<li><p>8091: MQTT over WebSockets, unencrypted, authenticated</p></li>
</ol>
</li>
</ol>
<p><strong>Note</strong>: test.mosquitto.org is used in this document for illustration
purposes only.</p>
<p>The following steps describe the procedure to test the MQTT application
using the Mosquitto project’s test server.</p>
<p>To evaluate the secure MQTT, the certificates (CA certificate, Client
certificate, Client key) bundled along with the MQTT sample app can be
used. The TLS certificates are generated from the following URL:
<a class="reference external" href="https://test.mosquitto.org/ssl/">https://test.mosquitto.org/ssl/</a>.</p>
<p><strong>Note</strong>:</p>
<ol class="arabic simple">
<li><p>The certificates provided as a part of the MQTT example application
are generated from <a class="reference external" href="https://test.mosquitto.org/">https://test.mosquitto.org/</a> and
<a class="reference external" href="https://test.mosquitto.org/ssl/">https://test.mosquitto.org/ssl/</a>.</p></li>
<li><p>The CA certificate: mosquitto.org.crt can be downloaded from
<a class="reference external" href="https://test.mosquitto.org/">https://test.mosquitto.org/</a>.</p></li>
<li><p>The client certificate: client.crt and the client key: client.key can
be generated from <a class="reference external" href="https://test.mosquitto.org/ssl/">https://test.mosquitto.org/ssl/</a> by following the
instruction mentioned in the same website.</p></li>
</ol>
<p>The validity of the certificates generated is only 90 days, hence it is
recommended to generate the three certificates while evaluating the MQTT
sample application, to ensure that the expired certificates are not
used.</p>
<p>Refer to section 0 to access the validity of the certificates.</p>
</section>
<section id="installing-and-running-the-mosquitto-mqtt-tool">
<h2>Installing and Running the Mosquitto MQTT Tool<a class="headerlink" href="#installing-and-running-the-mosquitto-mqtt-tool" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Download
<a class="reference external" href="file:///C:C:C:C:Usersinnopmqttembedded_appsC:C:Users91963Downloadsmosquitto-2.0.11-install-windows-x64.exe">mosquitto-2.0.11-install-windows-x64.exe</a>
from <a class="reference external" href="https://mosquitto.org/download/">https://mosquitto.org/download/</a> and install the same.</p></li>
<li><p>Open a command prompt window on the PC and subscribe to a topic by
issuing the following command:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_sub.exe -h test.mosquitto.org -p 1883 -u &lt;user name&gt; -P
&lt;Password&gt; -t T2_&lt;mac id of T2&gt;/subscribe</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Ensure the note in section 0 is followed and the binary is generated.</p>
<blockquote>
<div><p>In the example, the username and password used are innophase. The
topic programmed in the application binary mqtt.elf is T2_&lt;mac_id of
T2&gt;/subscribe.</p>
<p>The following picture shows the command prompt window:</p>
<p>For example, subscribe to a topic of one of the two connections
initiated over non-secure port:</p>
<p><a class="reference internal" href="../../_images/image110.png"><img alt="image1" src="../../_images/image110.png" style="width: 6.69306in; height: 0.28056in;" /></a></p>
</div></blockquote>
<p>Figure 1: Non-secure - Command prompt window</p>
</section>
<section id="programming-the-talaria-two-module">
<h2>Programming the Talaria TWO module<a class="headerlink" href="#programming-the-talaria-two-module" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Certificates need to be flashed for secure MQTT. In case of
non-secure MQTT, the user can begin the procedure from step 2.b. The
certificates for the sample app are present in:
<em>freertos_sdk_x.y/examples/mqtt/certs/data</em> directory.</p></li>
</ol>
<blockquote>
<div><p><strong>Note</strong>: x and y refers to the SDK version. For example:
freertos_sdk_2.5.</p>
<p>Provide the path of the certificates stored on host PC in the Write
files from a directory column to store the certificates on Talaria
TWO’s file system i.e., /data/</p>
<p><a class="reference internal" href="../../_images/image23.png"><img alt="image2" src="../../_images/image23.png" style="width: 5.90551in; height: 1.71396in;" /></a></p>
</div></blockquote>
<p>Figure 2: Flashing the certificates to Talaria TWO file system by
loading from a directory</p>
<blockquote>
<div><p>After writing the certificates to Talaria TWO’s file system, verify
the path of the certificates by clicking on Show File System
Contents. A dialog box pops up and displays the path of the
certificates written along with the size of each of these
certificates.</p>
<p><a class="reference internal" href="../../_images/image33.png"><img alt="Graphical user interface, text Description automatically generated" src="../../_images/image33.png" style="width: 5.90551in; height: 1.28172in;" /></a></p>
</div></blockquote>
<p>Figure 3: Certificates along with size displayed</p>
<ol class="arabic simple" start="2">
<li><p>Program mqtt.elf (<em>freertos_sdk_x.y/examples/mqtt/bin</em>) using the
Download Tool (<em>freertos_sdk_x.y/pc_tools/Download_Tool/bin)</em>.</p>
<ol class="loweralpha simple">
<li><p>Launch the Download Tool provided with InnoPhase Talaria TWO SDK.</p></li>
<li><p>In the GUI window:</p>
<ol class="lowerroman simple">
<li><p>Boot Target: Select the appropriate EVK from the drop-down.</p></li>
<li><p>ELF Input: Load the mqtt.elf by clicking on Select ELF File.</p></li>
<li><p>AP Options: Provide the SSID and Passphrase under AP Options
to connect to an Access Point.</p></li>
<li><p>Boot arguments: Pass the following boot arguments:</p>
<ol class="arabic simple">
<li><p>Non-secured MQTT:</p></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.org,cloud_port=1883,cloud_usr_name=&lt;user
name &gt;,cloud_usr_psw=&lt;password&gt;,mqtt_no_poll=1, num_conn=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="2">
<li><p>For secured MQTT (Verifying server certificate) :</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.org,cloud_port=8883,
cloud_u
sr_name=&lt;username&gt;,cloud_usr_psw=&lt;password&gt;,transport_mode=1,pub_qos=
1,sub_qos=1,ca_cert=/data/mosquitto.org.crt,mqtt_no_poll=1,num_conn=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="3">
<li><p>For secured MQTT (No certificate verify) :</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.org,cloud_port=8883,
cloud_usr_name=&lt;username&gt;,cloud_us
r_psw=&lt;password&gt;,transport_mode=3,pub_qos=1,sub_qos=1,mqtt_no_poll=1,
num_conn=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="4">
<li><p>For secured MQTT (verify the server certificate and provide the
client certificate) :</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.org,cloud_port=8884,
cloud_usr_name=&lt;username&gt;,cloud_usr_psw=&lt;password&gt;,,transport_mod
e=2,pub_qos=1,sub_qos=1,ca_cert=/data/mosquitto.org.crt,client_cert=/
data/client.crt,client_key=/data/client.key,mqtt_no_poll=1,num_conn=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="5">
<li><p>For MQTT over WebSockets, unencrypted, unauthenticated:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.or
g,cloud_port=8080,cloud_usr_name=&lt;username&gt;,cloud_usr_psw=&lt;password&gt;,
mqtt_no_poll=1,num_conn=1,transport_mode=4,
websock_url=ws://test.mosquitto.org/mqtt</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="6">
<li><p>For MQTT over WebSockets, encrypted, with certificate verification:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.org
,cloud_port=8081,cloud_usr_name=innophase,cloud_usr_psw=inno
phase,mqtt_no_poll=1,num_conn=1,transport_mode=5,pub_qos=1,sub_qos=1,
websock_url=ws://test.mosquitto.org/mqtt,ca_cert=/data/mosqu
itto.org.crt,client_cert=/data/client.crt,client_key=/data/client.key</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="7">
<li><p>For MQTT over WebSockets, encrypted, without certificate
verification:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=test.mosquitto.org
,cloud_port=8091,cloud_usr_name=&lt;
username&gt;,cloud_usr_psw=&lt;password&gt;,mqtt_no_poll=1,num_conn=1,transpor
t_mode=6,pub_qos=1,sub_qos=1,websock_url=ws://test.mosquitto.org/mqtt</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="loweralpha simple" start="22">
<li><p>Programming: Click on Prog Flash.</p></li>
</ol>
<ol class="arabic simple" start="3">
<li><p>The console window displays MQTTConnect ret = 0 indicating that
Talaria TWO can connect to the test.mosquitto.org server.</p></li>
</ol>
<blockquote>
<div><p>Non-secured MQTT:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWWWWAE</p>
<p>Build $Id: git-df9b9ef $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-00b0-0064-ffffffffffff</p>
<p>Bootargs: cloud_url=test.mosquitto.org cloud_port=1883 mqtt_no_poll=1
num_conn=1 np_conf_path=/data/nprofile.json ssid=Lucy
<a class="reference external" href="mailto:passphrase=Password&#37;&#52;&#48;321">passphrase=Password<span>&#64;</span>321</a></p>
<p>$App:git-94e4627</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>MQTT Example App</p>
<p>addr e0:69:3a:00:16:d4</p>
<p>Connecting to added network : Lucy</p>
<p>[0.580,194] CONNECT:c8:e7:d8:8c:ba:3c Channel:6 rssi:-82 dBm</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_LINK_UP</p>
<p>app_wifi_status_cb: status = 124457wcm_notify_cb to App Layer -
WCM_NOTIFY_MSG_ADDRESS</p>
<p>app_wifi_status_cb: status = 6881281[0.695,319] MYIP 192.168.1.103</p>
<p>[0.695,484] IPv6 [fe80::e269:3aff:fe00:16d4]-link</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_CONNECTED</p>
<p>app_wifi_status_cb: status = 105</p>
<p>Connected to added network : Lucy</p>
<p>MQTTNoPollInit:774</p>
<p>MQTTRun_NoPollThread: 718mac id:e0693a016d4</p>
<p>T2 MQTT Client id : T2_e0693a016d4_1</p>
<p>T2 MQTT publish topic : T2_e0693a016d4_1/pt2_1</p>
<p>T2 MQTT subscribe topic: T2_e0693a016d4_1/st2_1</p>
<p>T2 LWT topic : will_con1</p>
<p>app_mqtt_connect 155</p>
<p>app_mqtt_conn_init</p>
<p>/home/synergic/Workspace/FreeRTOS/freertos_em
bedded_apps/components/mqtt/platform/mqtt_nw_tcp.c:MQTTNetworkConnect</p>
<p>Connecting …</p>
<p>_mqtt_cycle : packet_type = 2</p>
<p>MQTTConnect Success. ret = 0</p>
<p>app_subscribe:307</p>
<p>_mqtt_cycle : packet_type = 9</p>
<p>app_subscribe: 311</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 1, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 2, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 3, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 4, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 5, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 6, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 7, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 8, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 9, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 10, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 11, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 12, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 13, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 14, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 15, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 16, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 17, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 18, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 19, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 20, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 21, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 22, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 23, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 24, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 25, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 26, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Secured MQTT:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWWWWAE</p>
<p>Build $Id: git-df9b9ef $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-00b0-0064-ffffffffffff</p>
<p>Bootargs: cloud_url=test.mosquitto.org cloud_port=8883
transport_mode=1 pub_qos=1 sub_qos=1 ca_cert=/data/mosquitto.org.crt
mqtt_no_poll=1 num_conn=1 np_conf_path=/data/nprofile.json ssid=Lucy
<a class="reference external" href="mailto:passphrase=Password&#37;&#52;&#48;321">passphrase=Password<span>&#64;</span>321</a></p>
<p>$App:git-94e4627</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>MQTT Example App</p>
<p>addr e0:69:3a:00:16:d4</p>
<p>Connecting to added network : Lucy</p>
<p>[0.708,336] CONNECT:c8:e7:d8:8c:ba:3c Channel:6 rssi:-80 dBm</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_LINK_UP</p>
<p>app_wifi_status_cb: status = 124457wcm_notify_cb to App Layer -
WCM_NOTIFY_MSG_ADDRESS</p>
<p>app_wifi_status_cb: status = 6881281[0.907,204] MYIP 192.168.1.103</p>
<p>[0.907,369] IPv6 [fe80::e269:3aff:fe00:16d4]-link</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_CONNECTED</p>
<p>app_wifi_status_cb: status = 105</p>
<p>Connected to added network : Lucy</p>
<p>MQTTNoPollInit:774</p>
<p>MQTTRun_NoPollThread: 718</p>
<p>T2 MQTT Client id : T2_e0693a0a66_1</p>
<p>T2 MQTT publish topic : T2_e0693a0a66_1/pt2_1</p>
<p>T2 MQTT subscribe topic: T2_e0693a0a66_1/st2_1</p>
<p>T2 LWT topic : will_con1</p>
<p>mac id:e0693a0a66</p>
<p>app_auto_generate_params:111, size = 64</p>
<p>T2 MQTT Client id : T2_e0693a016d4_1</p>
<p>T2 MQTT publish topic : T2_e0693a016d4_1/pt2_1</p>
<p>T2 MQTT subscribe topic: T2_e0693a016d4_1/st2_1</p>
<p>T2 LWT topic : will_con1</p>
<p>app_mqtt_connect 155</p>
<p>app_mqtt_conn_init</p>
<p>/home/synergic/Workspace/FreeRTOS/freertos_embedd
ed_apps/components/mqtt/platform/mqtt_nw_tls.c:MQTTNetworkConnect_Tls</p>
<p>. [SSL_WRAP]Checking input configurations…</p>
<p>. [SSL_WRAP]Seeding the random number generator…</p>
<p>. [SSL_WRAP]Loading the CA root certificate …Cert Len = 1477</p>
<p>. [SSL_WRAP]Connecting to tcp test.mosquitto.org:8883…</p>
<p>. [SSL_WRAP]Setting up the SSL/TLS structure…</p>
<p>. [SSL_WRAP]setting configurations..</p>
<p>&gt;auth mode = 2 (0- skip, 1- optional, 2- required</p>
<p>&gt;max fragment len = 0</p>
<p>&gt;Handshake timeout = 30 Sec</p>
<p>. [SSL_WRAP]Performing the SSL/TLS handshake…</p>
<p>. [SSL_WRAP] Handshake done. ok</p>
<p>. [SSL_WRAP]Verifying peer X.509 certificate.</p>
<p>Connecting …</p>
<p>_mqtt_cycle : packet_type = 2</p>
<p>MQTTConnect Success. ret = 0</p>
<p>app_subscribe:264</p>
<p>_mqtt_cycle : packet_type = 9</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 1, Failure = 0</p>
<p>mqtt_ssl_sock_read: setting rval to 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 2, Failure = 0</p>
<p>mqtt_ssl_sock_read: setting rval to 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 3, Failure = 0</p>
<p>mqtt_ssl_sock_read: setting rval to 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 4, Failure = 0</p>
<p>mqtt_ssl_sock_read: setting rval to 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>…</p>
<p>…</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="4">
<li><p>For testing the MQTT over WebSocket protocol, Mosquitto Websocket
server is used.</p></li>
</ol>
<blockquote>
<div><p>To connect MQTT over Websocket, add the following boot argument to
the test.mosquitto.org websocket server.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>websock_url=ws://test.mosquitto.org/mqtt</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Non-secured MQTT over WebSocket:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWWWWAE</p>
<p>Build $Id: git-df9b9ef $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-00b0-0064-ffffffffffff</p>
<p>Bootargs: cloud_url=test.mosquitto.org cloud_port=8080
cloud_usr_name=innophase ,cloud_usr_psw=innophase mqtt_no_poll=1
num_conn=1 transport_mode=4 websock_url=ws://test.mosquitto.org/mqtt
np_conf_path=/data/nprofile.json ssid=Lucy <a class="reference external" href="mailto:passphrase=Password&#37;&#52;&#48;321">passphrase=Password<span>&#64;</span>321</a></p>
<p>$App:git-94e4627</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>MQTT Example App</p>
<p>addr e0:69:3a:00:0a:66</p>
<p>Connecting to added network : Lucy</p>
<p>[0.812,590] CONNECT:96:6a:1b:0d:62:e4 Channel:1 rssi:-25 dBm</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_LINK_UP</p>
<p>app_wifi_status_cb: status = 200wcm_notify_cb to App Layer -
WCM_NOTIFY_MSG_ADDRESS</p>
<p>app_wifi_status_cb: status = 202[0.865,350] MYIP 192.168.58.243</p>
<p>[0.865,630] IPv6 [fe80::e269:3aff:fe00:a66]-link</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_CONNECTED</p>
<p>app_wifi_status_cb: status = 204</p>
<p>Connected to added network : Lucy</p>
<p>MQTTNoPollInit:714mac id:e0693a0a66</p>
<p>app_auto_generate_params:154, size = 64</p>
<p>T2 MQTT Client id : T2_e0693a0a66_1</p>
<p>T2 MQTT publish topic : T2_e0693a0a66_1/pt2_1</p>
<p>T2 MQTT subscribe topic: T2_e0693a0a66_1/st2_1</p>
<p>T2 LWT topic : will_con1</p>
<p>app_mqtt_connect 145</p>
<p>app_mqtt_conn_init</p>
<p>mqttbroker_address = test.mosquitto.org</p>
<p>MQTTNetworkConnect_Ws</p>
<p>MQTTRun_NoPollThread: 658</p>
<p>Connecting …</p>
<p>_mqtt_cycle : packet_type = 2</p>
<p>MQTTConnect Success. ret = 0</p>
<p>app_subscribe:293</p>
<p>_mqtt_cycle : packet_type = 9</p>
<p>app_subscribe: 297</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 1, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 2, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 3, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 4, Failure = 0</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Secured MQTT over Websocket:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWWWWAE</p>
<p>Build $Id: git-aba7fa2 $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-008d-009d-ffffffffffff</p>
<p>Bootargs: cloud_url=172.16.16.30 cloud_port=9001
cloud_usr_name=innophase cloud_usr_psw=innophase mqtt_no_poll=1
num_conn=1 transport_mode=5 websock_url=ws://172.16.16.30/mqtt
ca_cert=/data/ca.crt client_cert=/data/client.crt
client_key=/data/client.key np_conf_path=/data/nprofile.json
ssid=Xiaomi_Ax6000_iop passphrase=InnoQA2023$</p>
<p>$App:git-e719539</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>MQTT Example App</p>
<p>addr e0:69:3a:00:16:06</p>
<p>Connecting to added network : Xiaomi_Ax6000_iop</p>
<p>[1.197,870] CONNECT:d4:da:21:54:d3:c6 Channel:1 rssi:-21 dBm</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_LINK_UP</p>
<p>app_wifi_status_cb: status = 124457wcm_notify_cb to App Layer -
WCM_NOTIFY_MSG_ADDRESS</p>
<p>app_wifi_status_cb: status = 6881281[1.811,667] MYIP 192.168.31.198</p>
<p>[1.811,833] IPv6 [fe80::e269:3aff:fe00:1606]-link</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_CONNECTED</p>
<p>app_wifi_status_cb: status = 105</p>
<p>Connected to added network : Xiaomi_Ax6000_iop</p>
<p>MQTTNoPollInit:775</p>
<p>MQTTRun_NoPollThread: 719mac id:e0693a0166 T2 MQTT Client id :
T2_e0693a0166_1</p>
<p>T2 MQTT publish topic : T2_e0693a0166_1/pt2_1</p>
<p>T2 MQTT subscribe topic: T2_e0693a0166_1/st2_1</p>
<p>T2 LWT topic : will_con1 app_mqtt_connect 155</p>
<p>app_mqtt_conn_init</p>
<p>mqttbroker_address = 172.16.16.30</p>
<p>MQTTNetworkConnect_Ws</p>
<p>. [SSL_WRAP]Checking input configurations…</p>
<p>. [SSL_WRAP]Seeding the random number generator…</p>
<p>. [SSL_WRAP]Loading the CA root certificate …Cert Len = 1221</p>
<p>. Loading the Client(Own) certificate …Cert Len = 1108</p>
<p>. [SSL_WRAP]Loading the Client(Own) Key …Key Len = 1676</p>
<p>. [SSL_WRAP]Connecting to tcp 172.16.16.30:9001…</p>
<p>. [SSL_WRAP]Setting up the SSL/TLS structure…</p>
<p>. [SSL_WRAP]setting configurations..</p>
<p>&gt;auth mode = 2 (0- skip, 1- optional, 2- required</p>
<p>&gt;max fragment len = 0</p>
<p>&gt;Handshake timeout = 30 Sec</p>
<p>. [SSL_WRAP]Performing the SSL/TLS handshake…</p>
<p>. [SSL_WRAP] Handshake done. ok</p>
<p>. [SSL_WRAP]Verifying peer X.509 certificate.</p>
<p>Connecting …</p>
<p>_mqtt_cycle : packet_type = 2</p>
<p>MQTTConnect Success. ret = 0</p>
<p>app_subscribe:307</p>
<p>_mqtt_cycle : packet_type = 9</p>
<p>app_subscribe: 311</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 1, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 2, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="publishing-the-message">
<h2>Publishing the Message<a class="headerlink" href="#publishing-the-message" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Application continues publishing the message “<strong>Hello From T2”</strong>
every second. The published message can be seen on the subscriber’s
window (command prompt on the PC).</p></li>
</ol>
<blockquote>
<div><p>The MAC ID of the Talaria TWO device used in this example is
e0:69:3a:00:0e:ba. The unique MQTT Client ID generated based on this
MAC ID is T2_e0693a0eba_1 for the first connection and
T2_e0693a0eba_2 for the second connection .</p>
<p>Talaria TWO publishes the messages to the topics
T2_e0693a0eba_1/pt2_1 from the first connection and
T2_e0693a0eba_2/pt2_2 from the second connection.</p>
<p>Hence, the other MQTT Client (PC here) will subscribe to the same
topic.</p>
<p><a class="reference internal" href="../../_images/image43.png"><img alt="image3" src="../../_images/image43.png" style="width: 6.29921in; height: 0.71462in;" /></a></p>
</div></blockquote>
<p>Figure : Talaria TWO’s Published messages</p>
</section>
<section id="subscribing-to-a-topic">
<h2>Subscribing to a Topic<a class="headerlink" href="#subscribing-to-a-topic" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Talaria TWO device has subscribed to the topic T2_&lt;mac id&gt; _1/st2_1
(in this example, Talaria TWO’s subscribed topic is based on the MAC
ID T2_e0693a0eba_1/st2_1) from the first connection and T2_&lt;mac id&gt;
_1/st2_2 from the second connection (i.e., T2_e0693a0eba_2/st2_2).
The message published by other MQTT client to this topic will be
displayed on Talaria TWO’s console.</p></li>
<li><p>Publish a message to the topic innophase_t2/subscriber for another
MQTT client (PC) as shown in Figure 5.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image53.png"><img alt="image4" src="../../_images/image53.png" style="width: 6.29921in; height: 0.5017in;" /></a></p>
</div></blockquote>
<p>Figure : The published message will be displayed on Talaria TWO’s
console</p>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image62.png"><img alt="image5" src="../../_images/image62.png" style="width: 6.29921in; height: 0.79637in;" /></a></p>
</div></blockquote>
<p>Figure 6: Message received by Talaria TWO for the topic subscribed</p>
</section>
<section id="evaluating-lwt-feature">
<h2>Evaluating LWT Feature<a class="headerlink" href="#evaluating-lwt-feature" title="Permalink to this heading"></a></h2>
<p>To evaluate the LWT feature of Talaria TWO example application, an MQTT
client should be subscribed to the LWT topic of Talaria TWO.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_sub.exe -h Innophase-SYNEM2043 -p 1883 -u innophase -P
innophase -t will_con1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>If Talaria TWO client disconnects with a rough-hewn disconnect, the
server publishes LWT messages defined in the application to all the LWT
topics after 90 seconds.</p>
<p><a class="reference internal" href="../../_images/image72.png"><img alt="image6" src="../../_images/image72.png" style="width: 6.49606in; height: 0.40941in;" /></a></p>
<p>Figure : MQTT client subscriber for LWT Topic</p>
<p>Server-side console:</p>
<p>Server sends the LWT message to all the clients subscribed to LWT topic.</p>
<p><a class="reference internal" href="../../_images/image82.png"><img alt="image7" src="../../_images/image82.png" style="width: 6.49606in; height: 0.76728in;" /></a></p>
<p>Figure : LWT publish message published to all the clients</p>
</section>
<section id="evaluating-websocket-feature">
<h2>Evaluating Websocket Feature<a class="headerlink" href="#evaluating-websocket-feature" title="Permalink to this heading"></a></h2>
<p>To evaluate the websocket feature of Talaria TWO, example application
MQTT Box extension is used. MQTTBox is a developers helper program to
create and test MQTT connectivity protocol, which is available as an
google extension.</p>
<p><a class="reference internal" href="../../_images/image92.png"><img alt="image8" src="../../_images/image92.png" style="width: 3.14961in; height: 1.19198in;" /></a></p>
<p>Figure : MQTTBox Extension</p>
<p>To test the websocket client, launch the MQTT Box Extension and create a
new MQTT over websocket client.</p>
<p><a class="reference internal" href="../../_images/image102.png"><img alt="image9" src="../../_images/image102.png" style="width: 6.69291in; height: 2.49419in;" /></a></p>
<p>Figure : MQTTBox Extension settings</p>
<ol class="arabic simple">
<li><p>Add client name.</p></li>
<li><p>Select <strong>WS</strong> Protocol.</p></li>
<li><p>Add the host address (test.mosquitto.org:8080)</p></li>
<li><p>Add username password for the MQTT over websocket client.</p></li>
<li><p>Click on “Save” button.</p></li>
</ol>
<p>After saving, client will connect to the server if the connection is
successful. The connection message will be shown in the publish and
subscribe window.</p>
<p><a class="reference internal" href="../../_images/image112.png"><img alt="image10" src="../../_images/image112.png" style="width: 6.29921in; height: 4.23535in;" /></a></p>
<p>Figure : MQTTBox Extension publish subscribe window</p>
<ol class="arabic simple">
<li><p>Add Talaria TWO subscribe topic as a publish topic.</p></li>
<li><p>Select the Publish QOS value.</p></li>
<li><p>Add Talaria TWO publish topic as a subscribe topic.</p></li>
<li><p>Select the subscribe QOS value.</p></li>
<li><p>For publishing the payload click on “Publish” Button.</p></li>
<li><p>For subscribing click on “Subscribe” Button.</p></li>
</ol>
<p>Once the connection is successful, Talaria TWO published messages are
subscribed at the subscription window.</p>
<p><a class="reference internal" href="../../_images/image122.png"><img alt="image11" src="../../_images/image122.png" style="width: 6.69291in; height: 4.54131in;" /></a></p>
<p>Figure : MQTTBox Extension publish subscribe window</p>
<p>After successfully publishing, the published message will be printed
over Talaria TWO console.</p>
<p><a class="reference internal" href="../../_images/image131.png"><img alt="image12" src="../../_images/image131.png" style="width: 5.90551in; height: 2.79027in;" /></a></p>
<p>Figure : Published message over the Talaria TWO console</p>
</section>
<section id="evaluating-the-application-using-mosquitto-local-server">
<h2>Evaluating the Application using Mosquitto Local Server<a class="headerlink" href="#evaluating-the-application-using-mosquitto-local-server" title="Permalink to this heading"></a></h2>
</section>
<section id="non-secured">
<h2>Non-secured<a class="headerlink" href="#non-secured" title="Permalink to this heading"></a></h2>
<p>The application can also be evaluated by setting up a local Mosquitto
server/broker on the host PC. The following steps describe the procedure
to set up a local Mosquitto server and evaluate the example application.</p>
<ol class="arabic simple">
<li><p>Download the
<a class="reference external" href="https://mosquitto.org/files/binary/win64/mosquitto-2.0.11-install-windows-x64.exe">mosquitto-2.0.11-install-windows-x64.exe</a>
from <a class="reference external" href="https://mosquitto.org/download/">https://mosquitto.org/download/</a> and install it.</p></li>
<li><p>From the command line create a password file using:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_passwd.exe -c &lt; Name of password file &gt; &lt;User name&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><strong>Note</strong>: Run the command prompt using administrator privileges.</p>
<p><a class="reference internal" href="../../_images/image142.png"><img alt="image13" src="../../_images/image142.png" style="width: 6.29931in; height: 0.66389in;" /></a></p>
</div></blockquote>
<p>Figure : Password file generation using mosquito_passwd</p>
<ol class="arabic simple" start="3">
<li><p>Append the following configuration to mosquito.conf file (open the
file with administrator privileges). The allow_anonymous true
parameter can be ignored if a password and username are used<em>.</em></p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>listener &lt;Port number&gt;</p>
<p>allow_anonymous true</p>
<p>max_keepalive &lt;timeout&gt;</p>
<p>password_file &lt;Path to the password file&gt;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>as shown in the following example:</p>
<p><a class="reference internal" href="../../_images/image151.png"><img alt="image14" src="../../_images/image151.png" style="width: 6.29921in; height: 1.18477in;" /></a></p>
</div></blockquote>
<p>Figure : mosquito configuration file</p>
<ol class="arabic simple" start="4">
<li><p>Start the Mosquitto broker by issuing the following command:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto -c mosquitto.conf -v</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>The output shown in Figure 16 will be displayed.</p>
<p><a class="reference internal" href="../../_images/image162.png"><img alt="image15" src="../../_images/image162.png" style="width: 6.29931in; height: 1.30764in;" /></a></p>
</div></blockquote>
<p>Figure 16: Starting the mosquito broker</p>
<ol class="arabic simple" start="5">
<li><p>Issue the following command in command prompt and check if the active
connection with the listener port number is listed as shown in Figure
17 with port number 1883.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>netstat -a</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image171.png"><img alt="image16" src="../../_images/image171.png" style="width: 6.29921in; height: 3.15452in;" /></a></p>
</div></blockquote>
<p>Figure : Output of netstat command</p>
<ol class="arabic simple" start="6">
<li><p>In another command prompt window, execute the following command to
subscribe to the topic T2_&lt;mac id of T2_1/pt2_1. The MQTT server
address is the IP address of the machine that is running mosquito.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_sub.exe -h &lt;IP address of the host PC running the local
MQTT server&gt; -u &lt;user name&gt; -P &lt;Password&gt; -t T2_&lt;mac id of
T2_1/pt2_1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>In the example, the username and password are innophase and the local
IP address is 192.168.1.8. Talaria TWO publishes to the topic
T2_e0693a0eba_1/pt2_1. Hence, the other MQTT client (PC here) will
also subscribe to the same topic.</p>
</div></blockquote>
<ol class="arabic simple" start="7">
<li><p>Program the mqtt_non_secured.elf along with the following bootargs
using the Download Tool (refer steps from section 0 step 2).</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url= &lt; IP address of the host PC running the local MQTT
server&gt;,cloud_port=1883,cloud_usr_name=&lt;user name
&gt;,cloud_usr_psw=&lt;password&gt;,mqtt_no_poll=1, num_conn =1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="8">
<li><p>Output is displayed in the Download Tool console, confirming that
Talaria TWO is connected to the local mosquito broker running on the
host PC.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWWWWAE</p>
<p>Build $Id: git-df9b9ef $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-00b0-0064-ffffffffffff</p>
<p>Bootargs: cloud_url= 192.168.1.105 cloud_port=1883
cloud_usr_name=innophase cloud_usr_psw=innophase ,mqtt_no_poll=1,
num_conn =1np_conf_path=/data/nprofile.json ssid=Lucy
<a class="reference external" href="mailto:passphrase=Password&#37;&#52;&#48;321">passphrase=Password<span>&#64;</span>321</a></p>
<p>$App:git-94e4627</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>MQTT Example App</p>
<p>addr e0:69:3a:00:0a:66</p>
<p>Connecting to added network : Lucy</p>
<p>[0.801,387] CONNECT:04:d1:3a:b2:48:63 Channel:6 rssi:-35 dBm</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_LINK_UP</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_ADDRESS</p>
<p>[0.902,070] MYIP 192.168.43.164</p>
<p>[0.902,233] IPv6 [fe80::e269:3aff:fe00:a66]-link</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_CONNECTED</p>
<p>Connected to added network : Lucy</p>
<p>app_thread_entry_fnmac id:e0693a0a66</p>
<p>app_auto_generate_params:111, size = 64</p>
<p>T2 MQTT Client id : T2_e0693a0a66_1</p>
<p>T2 MQTT publish topic : T2_e0693a0a66_1/pt2_1</p>
<p>T2 MQTT subscribe topic: T2_e0693a0a66_1/st2_1</p>
<p>T2 LWT topic : will_con1</p>
<p>mac id:e0693a0a66</p>
<p>app_auto_generate_params:111, size = 64</p>
<p>T2 MQTT Client id : T2_e0693a0a66_2</p>
<p>T2 MQTT publish topic : T2_e0693a0a66_2/pt2_2</p>
<p>T2 MQTT subscribe topic: T2_e0693a0a66_2/st2_2</p>
<p>T2 LWT topic : will_con2</p>
<p>app_mqtt_connect 134mqtt_init</p>
<p>mqtt/platform/mqtt_nw_tcp.c:MQTTNetworkConnect</p>
<p>Connecting …</p>
<p>_mqtt_cycle : packet_type = 2</p>
<p>MQTTConnect Success. ret = 0</p>
<p>app_subscribe:264</p>
<p>_mqtt_cycle : packet_type = 9</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 1, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 2, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 3, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 4, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 5, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 5</p>
<p>_mqtt_cycle : packet_type = 7</p>
<p>Message Published Successfully …</p>
<p>…</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="9">
<li><p>Open command prompt and issue the following command:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_sub.exe -h &lt;IP addr of local machine &gt; -u innophase -P
innophase -t T2_e0693a0a66_1/pt2_1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="10">
<li><p>The following sample output will be observed on the command prompt
console:</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image43.png"><img alt="image17" src="../../_images/image43.png" style="width: 5.90551in; height: 0.66995in;" /></a></p>
</div></blockquote>
<p>Figure : Command prompt output</p>
<blockquote>
<div><p>The message gets published every two seconds and the count keeps
incrementing.</p>
</div></blockquote>
<ol class="arabic simple" start="11">
<li><p>In the example, Talaria TWO has subscribed to a topic
T2_e0693a0a66_1/st2_1. Open another command prompt window and issue
the following command:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto_pub.exe -h 192.168.43.3 -p 1883 -u innophase -P innophase
-t T2_e0693a0eba_1/st2_1 -m “Sending Data to T2”</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="12">
<li><p>Talaria TWO received the message when the MQTT Client (host PC)
published to the topic T2_e0693a0a66_1/st2_1 and the output is
displayed on the Download Tool’s console.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image62.png"><img alt="image18" src="../../_images/image62.png" style="width: 6.29921in; height: 0.77314in;" /></a></p>
</div></blockquote>
<p>Figure 19: Download Tool Output</p>
</section>
<section id="secured">
<h2>Secured<a class="headerlink" href="#secured" title="Permalink to this heading"></a></h2>
<p>The following steps describe the procedure to set up a local Mosquitto
server and evaluate the example application with a secured SSL/TLS
connection.</p>
<p><strong>Prerequisites</strong>:</p>
<ol class="arabic simple">
<li><p>Broker: Mosquitto</p></li>
<li><p>Key and certificate generation: OpenSSL</p></li>
</ol>
</section>
<section id="key-and-certificate-generation-for-secured-local-server">
<h2>Key and Certificate Generation for Secured Local Server<a class="headerlink" href="#key-and-certificate-generation-for-secured-local-server" title="Permalink to this heading"></a></h2>
<section id="install-openssl">
<h3>Install OpenSSL<a class="headerlink" href="#install-openssl" title="Permalink to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Download the OpenSSL v3.0.0 from the following location and install
the same: <a class="reference external" href="https://slproweb.com/products/Win32OpenSSL.html">https://slproweb.com/products/Win32OpenSSL.html</a>.</p></li>
<li><p>Click on the Windows button on your keyboard/taskbar. Search for
Environment Variables. Select Edit the system environment variables.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image181.png"><img alt="image19" src="../../_images/image181.png" style="width: 5.11811in; height: 4.15298in;" /></a></p>
<p>Figure : Environment variables</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>In the window that pops-up, click on Environment variables.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image191.png"><img alt="image20" src="../../_images/image191.png" style="width: 3.14961in; height: 3.59007in;" /></a></p>
</div></blockquote>
<p>Figure : System properties</p>
<ol class="arabic simple" start="4">
<li><p>This pops-up a window showing User variables and System variables. In
the User variables section, select Path and click Edit.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image201.png"><img alt="image21" src="../../_images/image201.png" style="width: 3.14961in; height: 3.49108in;" /></a></p>
<p>Figure : Environment variables - User variables</p>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><p>Click on Browse.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image211.png"><img alt="image22" src="../../_images/image211.png" style="width: 3.14961in; height: 3.49195in;" /></a></p>
</div></blockquote>
<p>Figure : Edit Environment Variable</p>
<ol class="arabic simple" start="6">
<li><p>This will already have some automatically added paths for other
applications. Go to where the openssl.exe is, which should be at This
PC &gt; Windows (C:) &gt; Program Files &gt; OpenSSL - Win64 &gt; bin and select
the folder.</p></li>
<li><p>Click OK.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image221.png"><img alt="image23" src="../../_images/image221.png" style="width: 3.14961in; height: 3.64467in;" /></a></p>
<p>Figure : Edit Environment Variables</p>
</div></blockquote>
<ol class="arabic simple" start="8">
<li><p>This will be added at the top. Ensure to click OK on this screen and
the subsequent screens.</p></li>
</ol>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image231.png"><img alt="image24" src="../../_images/image231.png" style="width: 3.14961in; height: 3.47452in;" /></a></p>
</div></blockquote>
<p>Figure : Modified Environment Variables</p>
</section>
<section id="generate-certificates">
<h3>Generate Certificates<a class="headerlink" href="#generate-certificates" title="Permalink to this heading"></a></h3>
<p>For secured Mosquitto on local, there is a need to create certificates
locally using OpenSSL commands in OpenSSL command prompt. The subsequent
sections provide the OpenSSL commands which can be used to generate
certificates.</p>
<p><strong>Certificate Authority</strong></p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>First, create a key pair for the CA using the following command on</dt><dd><p>OpenSSL command prompt:</p>
</dd>
</dl>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl genrsa -des3 -out ca.key 2048</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="Applications/2. Examples/media/image24.tmp"><img alt="image25" src="Applications/2. Examples/media/image24.tmp" style="width: 5.51181in; height: 1.35733in;" /></a></p>
<p>Figure : CA key generation</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>Create a certificate for the CA using the CA key created in step 1.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl req -new -x509 -days 1826 -key ca.key -out ca.crt</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image25.png"><img alt="image26" src="../../_images/image25.png" style="width: 5.51181in; height: 2.38165in;" /></a></p>
<p>Figure : CA Certificate generation</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>Now we create a server key pair which will be used by the broker.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl genrsa -out server.key 2048</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="Applications/2. Examples/media/image26.tmp"><img alt="image27" src="Applications/2. Examples/media/image26.tmp" style="width: 5.51181in; height: 1.96044in;" /></a></p>
<p>Figure : Server key generation</p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><dl class="simple">
<dt>Now, create a certificate request .csr. When filling out the form,</dt><dd><p>the common name is important and is usually the domain name of the
server.</p>
</dd>
</dl>
</li>
</ol>
<blockquote>
<div><p><strong>Note:</strong> Here, the PC name is used as a common name.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl req -new -out server.csr -key server.key</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image27.png"><img alt="image28" src="../../_images/image27.png" style="width: 5.51181in; height: 3.26837in;" /></a></p>
<p>Figure : Server.csr generation</p>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><dl class="simple">
<dt>Now, the CA key is used to verify and sign the server certificate.</dt><dd><p>This creates the server.crt file.</p>
</dd>
</dl>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key
-CAcreateserial -out server.crt -days 360</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="Applications/2. Examples/media/image28.tmp"><img alt="image29" src="Applications/2. Examples/media/image28.tmp" style="width: 5.51181in; height: 0.65205in;" /></a></p>
<p>Figure : Server certificate generation</p>
<p><strong>Client Certificates</strong></p>
</div></blockquote>
<ol class="arabic simple">
<li><p>To generate the client key, first create a client private key.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl genrsa -out client.key 2048</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="Applications/2. Examples/media/image29.tmp"><img alt="image30" src="Applications/2. Examples/media/image29.tmp" style="width: 5.7874in; height: 0.95916in;" /></a></p>
<p>Figure : Creating client key</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><dl class="simple">
<dt>Next, create a certificate request and use the client’s private key</dt><dd><p>to sign it.</p>
</dd>
</dl>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl req -new -out client.csr -key client.key</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image30.png"><img alt="image31" src="../../_images/image30.png" style="width: 5.7874in; height: 3.35239in;" /></a></p>
<p>Figure : Creating client csr</p>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><dl class="simple">
<dt>Execute the following command to complete the request and create a</dt><dd><p>client certificate.</p>
</dd>
</dl>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key
-CAcreateserial -out client.crt -days 360</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="Applications/2. Examples/media/image31.tmp"><img alt="image32" src="Applications/2. Examples/media/image31.tmp" style="width: 5.7874in; height: 0.51552in;" /></a></p>
<p>Figure : Client.crt generation</p>
<p><strong>Mosquitto Configuration File</strong>:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>listener &lt;port number&gt;</p>
<p>#extra listener</p>
<p>listener &lt; port number &gt;</p>
<p>per_listener_settings true</p>
<p>password_file &lt;your_path\passwordfile&gt;</p>
<p>allow_anonymous false</p>
<p>cafile &lt;your_path\ca.crt&gt;</p>
<p>certfile &lt;your_path\server.crt&gt;</p>
<p>keyfile &lt;your_path\server.key&gt;</p>
<p>tls_version tlsv1.2</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="Applications/2. Examples/media/image32.tmp"><img alt="image33" src="Applications/2. Examples/media/image32.tmp" style="width: 5.90486in; height: 2.30417in;" /></a></p>
<p>Figure : mosquitto.conf file</p>
<p>Start the Mosquitto broker by issuing the following command:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>mosquitto -v -c mosquitto.conf</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Expected output:</p>
<p><a class="reference internal" href="Applications/2. Examples/media/image33.tmp"><img alt="image34" src="Applications/2. Examples/media/image33.tmp" style="width: 5.7874in; height: 1.63313in;" /></a></p>
<p>Figure : Starting the mosquito broker</p>
<p>Issue the following command in command prompt and check if the active
connection with the listener port number is listed as shown in Figure
36 with port numbers 8884 and 8883.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>netstat -a</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p><a class="reference internal" href="../../_images/image34.png"><img alt="image35" src="../../_images/image34.png" style="width: 5.7874in; height: 3.43555in;" /></a></p>
</div></blockquote>
<p>Figure : Output - netstat command</p>
<blockquote>
<div><p>Post executing these steps, update the file system of the Talaria TWO
module with newly generated certificates following the steps from
section 0 step 1.</p>
<p><a class="reference internal" href="../../_images/image23.png"><img alt="image36" src="../../_images/image23.png" style="width: 5.7874in; height: 1.67968in;" /></a></p>
<p>Figure : Newly generated certificates to file system</p>
<p><a class="reference internal" href="../../_images/image35.png"><img alt="image37" src="../../_images/image35.png" style="width: 5.7874in; height: 1.30505in;" /></a></p>
<p>Figure : Certificates available in File System</p>
</div></blockquote>
</section>
</section>
<section id="programing-talaria-two">
<h2>Programing Talaria TWO<a class="headerlink" href="#programing-talaria-two" title="Permalink to this heading"></a></h2>
<ol class="arabic">
<li><dl class="simple">
<dt>Program mqtt.elf (<em>freertos_sdk_x.y/examples/mqtt/bin</em>)using the</dt><dd><p>Download Tool.</p>
</dd>
</dl>
<ol class="loweralpha simple">
<li><p>Launch the Download Tool provided with InnoPhase Talaria TWO SDK.</p></li>
<li><p>In the GUI window:</p>
<ol class="lowerroman simple">
<li><p>Boot Target: Select the appropriate EVK from the drop-down.</p></li>
<li><p>ELF Input: Load the mqtt.elf by clicking on Select ELF File.</p></li>
<li><dl class="simple">
<dt>AP Options: Pass the appropriate SSID and passphrase to</dt><dd><p>connect to an Access Point.</p>
</dd>
</dl>
</li>
<li><p>Programming: Prog RAM or Prog Flash as per requirement.</p></li>
</ol>
</li>
</ol>
</li>
<li><p>Pass the following boot arguments in the Boot Arguments field:</p></li>
</ol>
<blockquote>
<div><p>For secured MQTT (Verifying server certificate):</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url &lt; IP address of the host PC running the local MQTT
server&gt;,
cloud_port=8883,cloud_usr_name=innophase,cloud_usr_psw=innophase,tran
sport_mode=1,pub_qos=2,sub_qos=1,ca_cert=/data/ca.crt,mqtt_no_poll=1,
num_conn=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>For secured MQTT (No certificate verify):</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url=&lt; IP address of the host PC running the local MQTT
server&gt;,cloud_port=88
83,cloud_usr_name=innophase,cloud_usr_psw=innophase,transport_mode=3,
pub_qos=2,sub_qos=1,mqtt_no_poll=1, num_conn=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>For secured MQTT (Verifying the server certificate and provide the
client certificate)</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cloud_url= &lt; IP address of the host PC running the local MQTT
server&gt;,cloud_port=8884,cloud_usr_name=innophase,cloud_usr_psw=in
nophase,transport_mode=2,pub_qos=2,sub_qos=1,ca_cert=/data/ca.crt,cli
ent_cert=/data/client.crt,client_key=/data/client.key,mqtt_no_poll=1,
num_conn=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Expected Output: Local Secured MQTT:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWWWAE4 DWT comparators, range 0x8000</p>
<p>Build $Id: git-defd1fcaf $</p>
<p>cloud_url=172.16.16.30 cloud_port=8884 cloud_usr_name=innophase
cloud_usr_psw=innophase transport_mode=2 pub_qos=1 sub_qos=1
ca_cert=/data/ca.crt client_cert=/data/client.crt
client_key=/data/client.key mqtt_no_poll=1 num_conn=1
np_conf_path=/data/nprofile.json ssid=Xiaomi_Ax6000_iop
passphrase=InnoQA2023$</p>
<p>$App:git-d90a1da0</p>
<p>SDK Ver: FREERTOS_SDK_1.0</p>
<p>MQTT Example App</p>
<p>addr 02:03:04:0c:2d:50</p>
<p>Connecting to added network : Xiaomi_Ax6000_iop</p>
<p>[0.876,266] CONNECT:d4:da:21:54:d3:c6 Channel:13 rssi:-21 dBm</p>
<p>wcm_notify_callback :WCM_NOTIFY_MSG_LINK_UP</p>
<p>app_wifi_status_cb: status = 757536wcm_notify_callback
:CM_NOTIFY_MSG_ADDRESS</p>
<p>app_wifi_status_cb: status = 755720[3.262,188] MYIP 192.168.31.179</p>
<p>[3.262,351] IPv6 [fe80::3:4ff:fe0c:2d50]-link</p>
<p>wcm_notify_callback :_NOTIFY_MSG_CONNECTED</p>
<p>app_wifi_status_cb: status = 751512</p>
<p>Connected to added network : Xiaomi_Ax6000_iop</p>
<p>MQTTNoPollInit:712 - initdone = 0</p>
<p>MQTTRun_NoPollThread: 658mac id:234c2d50 T2 MQTT Client id :
T2_234c2d50_1</p>
<p>T2 MQTT publish topic : T2_234c2d50_1/pt2_1</p>
<p>T2 MQTT subscribe topic: T2_234c2d50_1/st2_1</p>
<p>T2 LWT topic : will_con1</p>
<p>app_mqtt_connect 145</p>
<p>app_mqtt_conn_init</p>
<p>mqtt/platform/mqtt_nw_tls.c:MQTTNetworkConnect_Tls</p>
<p>. [SSL_WRAP]Checking input configurations…</p>
<p>. [SSL_WRAP]Seeding the random number generator…</p>
<p>. [SSL_WRAP]Loading the CA root certificate …Cert Len = 1221</p>
<p>. Loading the Client(Own) certificate …Cert Len = 1108</p>
<p>. [SSL_WRAP]Loading the Client(Own) Key …Key Len = 1676</p>
<p>. [SSL_WRAP]Connecting to tcp 172.16.16.30:8884…</p>
<p>. [SSL_WRAP]Setting up the SSL/TLS structure…</p>
<p>. [SSL_WRAP]setting configurations..</p>
<p>auth mode = 2 (0- skip, 1- optional, 2- required</p>
<p>max fragment len = 0</p>
<p>Handshake timeout = 30 Sec</p>
<p>. [SSL_WRAP]Performing the SSL/TLS handshake…</p>
<p>. [SSL_WRAP] Handshake done. ok</p>
<p>. [SSL_WRAP]Verifying peer X.509 certificate.</p>
<p>Connecting …</p>
<p>_mqtt_cycle : packet_type = 2</p>
<p>MQTTConnect Success. ret = 0</p>
<p>app_subscribe:295</p>
<p>_mqtt_cycle : packet_type = 9</p>
<p>app_subscribe: 299</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 1, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 2, Failure = 0</p>
<p>_mqtt_cycle : packet_type = 4</p>
<p>Message Published Successfully</p>
<p>Publish stats: Success = 3, Failure = 0</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Server console:</p>
<p><a class="reference internal" href="../../_images/image36.png"><img alt="image38" src="../../_images/image36.png" style="width: 5.90551in; height: 4.20719in;" /></a></p>
</div></blockquote>
<p>Figure : Secure MQTT - server – Console</p>
</section>
<section id="certificates-validity-assessment">
<h2>Certificates Validity Assessment<a class="headerlink" href="#certificates-validity-assessment" title="Permalink to this heading"></a></h2>
<p>The certificate bundled in the MQTT example application may be expired.
Ensure to check the validity of the certificate added with this example
application.</p>
<p>Execute the following command to verify the validity of the x509
certificates:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cat mosquito.org.crt | openssl x509 -noout -enddate</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><a class="reference internal" href="Applications/2. Examples/media/image37.tmp"><img alt="image39" src="Applications/2. Examples/media/image37.tmp" style="width: 7.07577in; height: 0.33958in;" /></a></p>
<p>Figure : Certificates verification</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Example_for_LPScan.html" class="btn btn-neutral float-left" title="LPS Scan" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Example_for_Pulse_Width_Modulation.html" class="btn btn-neutral float-right" title="Pulse Width Modulation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 InnoPhase IoT, Inc. | All Rights Reserved | Proprietary &amp; Confidential.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>