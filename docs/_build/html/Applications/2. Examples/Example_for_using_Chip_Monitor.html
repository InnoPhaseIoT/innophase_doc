<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chip Monitor &mdash; InnoPhase 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Filesystem" href="Example_for_using_Filesystem.html" />
    <link rel="prev" title="Software SPI Master" href="Example_for_Software_SPI_Master.html" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="../../_static/js/custom.js" defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            InnoPhase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Getting%20Started/Getting%20Started%20-%20Landing%20Page.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Hardware%20Reference/Hardware-Reference.html">Hardware-Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Porting%20Guide/Porting-Guide.html">Porting-Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Disclaimers/Disclaimers.html">Disclaimer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Appendix/Appendix-Landing_Page.html">Appendix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Support/Support.html">Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Software%20Reference/Software_Reference_Landing_Page.html">Software Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Development%20Environments/Development%20Environments%20-%20Landing%20Page.html">Development Environments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Tools/Tools-landing%20page.html">Tools</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#apps">Apps</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../Applications%20-%20Landing%20Page.html#examples">Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Example_for_Analog_to_Digital_Converter.html">Analog to Digital Converter (ADC)</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Audio_over_I2S.html">Audio Over I2S</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_BLE_WiFi_Bridge.html">BLE WiFi Bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Crash_handling.html">Crash Handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_I2C.html">I2C</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_LPScan.html">LPS Scan</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_MQTT.html">MQTT</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Pulse_Width_Modulation.html">Pulse Width Modulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Radio_and_Module_Parameters.html">Radio and Module Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Secure_Files.html">Secure Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Socket_Wakeup.html">Socket Wakeup</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_Software_SPI_Master.html">Software SPI Master</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Chip Monitor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#chip-monitoring-services-standalone-application">Chip Monitoring Services Standalone Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building">Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chip-monitor-apis">Chip monitor APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chip-monitor-power-init">chip_monitor_power_init()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chip-monitor-start">chip_monitor_start()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chip-monitor-stop">chip_monitor_stop()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sample-code-walkthrough">Sample Code Walkthrough</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-the-application">Running the Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#programming-talaria-two-using-the-download-tool">Programming Talaria TWO using the Download Tool</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chip-monitoring-services-hosted-application">Chip Monitoring Services - Hosted Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-running-on-external-host">Application Running on External Host</a></li>
<li class="toctree-l4"><a class="reference internal" href="#measured-current-values-for-multiple-dtim-intervals">Measured Current Values for multiple DTIM Intervals</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_Filesystem.html">Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_GPIO.html">GPIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_SNTP.html">SNTP</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_using_WiFi.html">WIFI</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_for_WiFi_Power_Management.html">WiFi Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_BLE_5_0.html">BLE 5.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_BLE_Beacons.html">BLE Beacon</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Custom_ATCMDLIB.html">Custom ATCMDLIB</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_HTTP_Client.html">HTTP Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_IFTTT.html">IFTTT</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Low_Power_UART.html">Low Power UART</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_mDNS.html">mDNS</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html">Provisioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#scan-data">Scan Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#configuration-data-format">Configuration Data Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#service">Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#characteristics">Characteristics</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#application-flow">Application Flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#sample-code-walkthrough">Sample Code Walkthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#write-the-provisioning-file-into-talaria-two-filesystem">Write the Provisioning File into Talaria TWO Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#programming-talaria-two-board-with-elf">Programming Talaria TWO board with ELF</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Provisioning.html#running-the-application-using-android-or-ios-app">Running the Application using Android or iOS App</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Unassociated_Mode.html">Unassociated Mode</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Watchdog_Timer.html">Watchlog Timer</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_WCM_Multi_AP.html">WCM Multi AP</a></li>
<li class="toctree-l3"><a class="reference internal" href="Example_using_Websock_Client.html">Websock Client</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Regulatory%20Notices/Regulatory%20Notices.html">FCC/ISED Regulatory Notices</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Security/Security%20-%20Landing%20Page.html">Security</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">InnoPhase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Applications%20-%20Landing%20Page.html">Applications</a></li>
      <li class="breadcrumb-item active">Chip Monitor</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Applications/2. Examples/Example_for_using_Chip_Monitor.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="chip-monitor">
<h1>Chip Monitor<a class="headerlink" href="#chip-monitor" title="Permalink to this heading"></a></h1>
<p>The chip monitoring service allows the application to fetch the changes
in the values of the device core temperature, Voltage of VBAT, the
external ADC and the estimated current consumption of Talaria TWO
device.</p>
<p>The power measurement performed on Talaria TWO device is an estimated
value based on the state that the Talaria TWO device is in and the
duration that the Talaria TWO device stays in that particular state. The
Talaria TWO device can be in any of the four possible states:</p>
<ol class="arabic simple">
<li><p>Suspend mode</p></li>
<li><p>CPU mode</p></li>
<li><p>Rx mode</p></li>
<li><p>Tx mode</p></li>
</ol>
<p>Hence:</p>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Table : DTIM intervals</span><a class="headerlink" href="#id1" title="Permalink to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>estimated power consumption of T2 = Power consumption of the device
in a particular state x Duration for which the device stays in that
state</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Since the power consumption of Talaria TWO in a particular state is a
known value, it is possible to calculate the approximate power
consumption value by measuring the duration for which the device stays
in a particular state and multiplying it with the known power
consumption value of the device in that state.</p>
<p>This application note provides details on using the chip monitoring
services for the changes in the values of core temperature, voltage of
VBAT, the external ADC and the estimated current consumption of Talaria
TWO modules using:</p>
<ol class="arabic simple">
<li><p>A standalone application running on the Talaria TWO module which
provides the change in the values of the services periodically when
varied by a threshold.</p></li>
<li><p>An application running on Talaria TWO that responds to the requests
from an application running on the host. The python script –
talaria_cli.py present in the freertos_sdk/scripts directory will be
used as the application running on the host PC.</p></li>
</ol>
<section id="chip-monitoring-services-standalone-application">
<h2>Chip Monitoring Services Standalone Application<a class="headerlink" href="#chip-monitoring-services-standalone-application" title="Permalink to this heading"></a></h2>
<p>The application running on Talaria TWO can register to any (or all) of
the chip monitoring services i.e., the core temperature of the chip,
voltage of VBAT, the external ADC to monitor the change in the values
and the estimated current consumed by the T2 module by a threshold value
set. The registered service callback will get invoked when there is a
variation of the threshold value set.</p>
<p>The sample application described in this application note will subscribe
to all the four chip monitoring services.</p>
</section>
<section id="building">
<h2>Building<a class="headerlink" href="#building" title="Permalink to this heading"></a></h2>
<p>To build the sample application, execute the following commands:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>cd examples/chip_monitor</p>
<p>make</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The make command should generate the chip_monitor.elf in the out
directory.</p>
</section>
<section id="chip-monitor-apis">
<h2>Chip monitor APIs<a class="headerlink" href="#chip-monitor-apis" title="Permalink to this heading"></a></h2>
</section>
<section id="chip-monitor-power-init">
<h2>chip_monitor_power_init()<a class="headerlink" href="#chip-monitor-power-init" title="Permalink to this heading"></a></h2>
<p>Allocates energy reports for power measurements. Callers who want to
subscribe on power measurement need to call this before calling
chip_monitor_start().</p>
</section>
<section id="chip-monitor-start">
<h2>chip_monitor_start()<a class="headerlink" href="#chip-monitor-start" title="Permalink to this heading"></a></h2>
<p>Starts subscription for changes on specified source.</p>
<p>To calculate the Talaria TWO current power consumption, it is required
that chip_monitor_power_init() is called prior to chip_monitor_start().
The time for a measurement is dictated by time between the measurements
plus the possible time the chip is suspended.</p>
</section>
<section id="chip-monitor-stop">
<h2>chip_monitor_stop()<a class="headerlink" href="#chip-monitor-stop" title="Permalink to this heading"></a></h2>
<p>Stops the subscription service.</p>
</section>
<section id="sample-code-walkthrough">
<h2>Sample Code Walkthrough<a class="headerlink" href="#sample-code-walkthrough" title="Permalink to this heading"></a></h2>
<p><strong>chip_monitor.c</strong></p>
<p>The chip monitor sample code allows the device to subscribe to services
for measuring the estimated power consumption of Talaria TWO, changes in
core temperature, voltage and ADC.</p>
<p>The sample application subscribes to all the four services and sets a
threshold value of 1 to be able to print the information in the console
if there is a change from the last value captured by a threshold of 1.
The threshold value in the sample example is set to 1 for the purpose of
demonstration. The threshold value can be set to any valid value.</p>
<p>The registered call back service_fn_clbk gets invoked for change in the
values of the estimated power consumed, core temperature, VBAT and ADC
by a value of 1. If the threshold value is set to 0, the call back gets
invoked for the period specified by the minterval irrespective of the
change in the measured value.</p>
<p>The main function starts with receiving the boot arguments for the
following parameters:</p>
<ol class="arabic simple">
<li><p>minterval: Time interval in seconds for measuring the value of the
subscribed chip monitor service.</p></li>
<li><p>measure_count: Total number of estimated power consumption
measurements to be made.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>uint32_t minterval = os_get_boot_arg_int(“minterval”, 10);</p>
<p>uint32_t li = os_get_boot_arg_int(“li”, 15);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>chip_monitor_power_init() allocates energy reports for power
measurements. This API needs to be called before calling
chip_monitor_start() for the estimated power measurements on Talaria
TWO.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>chip_monitor_power_init();</p>
<p>ctms_t0 = os_systime64();</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Depending on the of bootargs value (0:Service not subscribed; 1:Service
subscribed) for the following services, a service is either subscribed
or not subscribed. If a service is subscribed, the change in the
measured value of that service is notified through the registered
callback.</p>
<ol class="arabic simple">
<li><p>adc_service</p></li>
<li><p>vbat_service</p></li>
<li><p>temperature_service</p></li>
<li><p>power_service</p></li>
</ol>
<p>By default ,all the services are subscribed.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>if(os_get_boot_arg_int(“adc_service”, 1) == 1)</p>
<p>{</p>
<p>os_printf(“Enabling ADC service\r\n”);</p>
<p>enable_chip_monitor_service(CHIP_MSOURCE_ADC, true);</p>
<p>}</p>
<p>if(os_get_boot_arg_int(“vbat_service”, 1) == 1)</p>
<p>{</p>
<p>os_printf(“Enabling VBAT service\r\n”);</p>
<p>enable_chip_monitor_service(CHIP_MSOURCE_VBAT, true);</p>
<p>}</p>
<p>if(os_get_boot_arg_int(“temperature_service”, 1) == 1)</p>
<p>{</p>
<p>os_printf(“Enabling Temperature service\r\n”);</p>
<p>enable_chip_monitor_service(CHIP_MSOURCE_CORE_TEMP, true);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The enable_chip_monitor_service() API subscribes or unsubscribes the
given service that is provided as an argument.</p>
<p>The power service will also be enabled by default if the Wi-Fi
connection is successful. The chip_monitor_wifi_conn() establishes a
Wi-Fi connection and sets the power management configuration for the
Wi-Fi interface and returns 0 upon successful Wi-Fi connection. This
sample application measures the power consumption of Talaria TWO
(estimated power consumption) with idle Wi-Fi connection.</p>
<p>First, The Wi-Fi network interface is created using wcm_create()and
wcm_notify_enable() enables the callback function.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>wcm_handle = wcm_create(NULL);</p>
<p>wcm_notify_enable(wcm_handle, cm_wcm_notify_cb, NULL);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>network_profile structure adds a network profile to WCM. np_conf_path
pointer variable contains the path of the network profile file (a JSON
file) present in Talaria TWO filesystem.
network_profile_new_from_file_system()API builds a network profile from
the network profile file in the filesystem and the path to this file is
provided by the np_conf_path variable that receives the path to the
network profile file through a boot argument.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>const char *np_conf_path = os_get_boot_arg_str(“np_conf_path”)?:
NULL;</p>
<p>struct network_profile *profile;</p>
<p>if (np_conf_path != NULL)</p>
<p>{</p>
<p>rval = network_profile_new_from_file_system(&amp;profile, np_conf_path);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>wcm_add_network_profile() adds the network profile to WCM and
wcm_auto_connect() starts the auto connection with Wi-Fi network.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>rval = wcm_add_network_profile(wcm_handle, profile);</p>
<p>if (rval &lt; 0) {</p>
<p>pr_err(“could not associate network profile to wcm %d\n”, rval);</p>
<p>return 0; }</p>
<p>if(wcm_auto_connect(my_wcm_handle, 1) == 0)</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>After the Wi-Fi connection is successful, the system is triggered to
enter into the suspend state depending upon the value of the boot
argument – suspend provided.</p>
<ol class="arabic simple">
<li><p>suspend =1; Triggers the Talaria TWO device to enter into suspend
state.</p></li>
<li><p>suspend =0; Talaria TWO device does not enter into suspend state.</p></li>
</ol>
<p>By default, the system is not triggered to enter the suspend state.
However, for the power measurements in idle mode, Talaria TWO device
will be triggered into suspend state through the boot argument.</p>
<p>The os_suspend_enable()API triggers Talaria TWO into suspend state.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>if (os_get_boot_arg_int(“suspend”, 0) != 0)</p>
<p>os_suspend_enable();</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Similarly, the gratuitous ARP can either be disabled or enabled based on
the value provided through the boot argument – arp_enable.</p>
<ol class="arabic simple">
<li><p>arp_enable = 0; Gratious ARP is disabled.</p></li>
<li><p>arp_enable =1; Gratious ARP is not disabled. This is the default
setting.</p></li>
</ol>
<p>The reception of multicast frames is disabled and the power management
configuration for the Wi-Fi interface is set. The li value for the power
management configuration is received as a boot argument. By default, the
value of listen interval is set to 10, the traffic time out to 12, and
the power management flags to 0.</p>
<p>Refer to the API Reference Guide
(<em>freertos_sdk_x.y/doc/api_reference_guide/T2-RM001-Vxy-Talaria_TWO_SDK_API_Reference_Guide.pdf</em>)
for more information on the description of all these APIs.</p>
<p><strong>Note</strong>: x and y in freertos_sdk_x.y refer to the SDK release version.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>pm_mask |= WIFI_PM_STA_RX_NAP | WIFI_PM_STA_ONLY_BROADCAST |
WIFI_PM_TX_PS | WIFI_PM_MCAST_DONT_CARE | WIFI_PM_DTIM_ONLY;</p>
<p>wcm_pm_config(wcm_handle, li, 12, pm_mask);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>chip_monitor_wifi_conn() returns 0 upon successful Wi-Fi connection and
setting the power management configuration. Now, execution of the main
thread is suspended for a period of 15 seconds for the device to
stabilize before starting the power measurements. The power measurement
service will be enabled by default since the default value of the boot
argument - power_service is set to 1. if the value of the boot argument
– power_service is set to 0. Then the power measurement service will be
disabled.</p>
<p>The enable_chip_monitor_service() function enables/disables a chip
monitor service and takes the following boot arguments:</p>
<ol class="arabic simple">
<li><p>threshold: A threshold value to trigger the registered call back for
a subscribed service. Any change in the measured value by the
threshold value will trigger the call back and prints the measured
value</p></li>
<li><p>curr_value: It is the last sample value measured. This value gets
updated every time the measurement is made.</p></li>
</ol>
<p>Depending on the arguments provided to the function,
enable_chip_monitor_service(enum chip_monitor_source service, bool
enable), the selected chip monitor service is either enabled or
disabled. The chip_monitor_start() API registers a call back function-
service_fn_clbk() for a given service.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>uint32_t threshold = os_get_boot_arg_int(“threshold”, 0);</p>
<p>uint32_t curr_value = os_get_boot_arg_int(“curr_value”, 0);</p>
<p>switch(service){</p>
<p>case CHIP_MSOURCE_CORE_TEMP:</p>
<p>if(enable == false){</p>
<p>chip_monitor_stop(temp_serv);</p>
<p>break;</p>
<p>}</p>
<p>temp_serv = os_zalloc(sizeof *temp_serv);</p>
<p>assert(temp_serv != NULL);</p>
<p>chip_monitor_start(temp_serv, CHIP_MSOURCE_CORE_TEMP, curr_value,
threshold, minterval, (chip_mon_notify_t)service_fn_clbk);</p>
<p>break;</p>
<p>case CHIP_MSOURCE_VBAT:</p>
<p>if(enable == false){</p>
<p>chip_monitor_stop(vbat_serv);</p>
<p>break;</p>
<p>}</p>
<p>vbat_serv = os_zalloc(sizeof *vbat_serv);</p>
<p>assert(vbat_serv != NULL);</p>
<p>chip_monitor_start(vbat_serv, CHIP_MSOURCE_VBAT, curr_value,
threshold, minterval, (chip_mon_notify_t)service_fn_clbk);</p>
<p>break;</p>
<p>case CHIP_MSOURCE_ADC:</p>
<p>if(enable == false){</p>
<p>chip_monitor_stop(adc_serv);</p>
<p>break;</p>
<p>}</p>
<p>adc_serv = os_zalloc(sizeof *adc_serv);</p>
<p>assert(adc_serv != NULL);</p>
<p>chip_monitor_start(adc_serv, CHIP_MSOURCE_ADC, curr_value, threshold,
minterval, (chip_mon_notify_t)service_fn_clbk);</p>
<p>break;</p>
<p>case CHIP_MSOURCE_POWER:</p>
<p>if(enable == false){</p>
<p>chip_monitor_stop(power_serv);</p>
<p>break;</p>
<p>}</p>
<p>power_serv = os_zalloc(sizeof *power_serv);</p>
<p>assert(power_serv != NULL);</p>
<p>chip_monitor_start(power_serv, CHIP_MSOURCE_POWER, curr_value,
threshold, minterval, (chip_mon_notify_t)service_fn_clbk);</p>
<p>break;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The service_fn_clbk()gets invoked if there is change by the threshold in
values measured for a given service i.e., core temperature, voltage,
ADCs or the estimated power measured.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void service_fn_clbk(struct chip_monitor_serv* serv, enum
chip_monitor_source source, uint32_t last_value){</p>
<p>….</p>
<p>….</p>
<p>switch(source){</p>
<p>case CHIP_MSOURCE_CORE_TEMP:</p>
<p>os_printf(“Time:%llu sec Chip Core Temp: %u C\n”, now, last_value);</p>
<p>break;</p>
<p>case CHIP_MSOURCE_VBAT:</p>
<p>os_printf(“Time:%llu sec Chip Vbat: %u dV\n”, now, last_value);</p>
<p>break;</p>
<p>case CHIP_MSOURCE_ADC:</p>
<p>os_printf(“Time:%llu sec Chip ADCin: %u \n”, now, last_value);</p>
<p>break;</p>
<p>……</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>For the power measurement service, the average of the measured current
values has to be considered. Hence, the sum of the values measured/the
number of samples is also displayed on the console. The total number of
samples to be captured is specified through the boot argument
measure_count.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>case CHIP_MSOURCE_POWER:</p>
<p>os_printf(“Chip mscource power\r\n”);</p>
<p>if (start_count_down == 0) {</p>
<p>count++;</p>
<p>total += last_value;</p>
<p>os_printf(“Average Current:%duA\n”, total/count);</p>
<p>if(count &gt; measure_count){</p>
<p>os_printf(“Completed %d measurements\r\n”,measure_count);</p>
<p>chip_monitor_stop_power_measurement(); }</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>After capturing the total number of power measurements, the
chip_monitor_stop_power_measurement() is called to stop the measurements
after displaying the average current measured.</p>
<p>The chip_monitor_stop_power_measurement()function stops the power
measurement by calling the
enable_chip_monitor_service(CHIP_MSOURCE_POWER, false) function and
shutting down and cleaning up a WCM interface.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>enable_chip_monitor_service(CHIP_MSOURCE_POWER, false);</p>
<p>wcm_remove_network(wcm_handle, ssid, NULL);</p>
<p>wcm_destroy(wcm_handle);</p>
<p>wcm_handle = NULL;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The print_wifi_config() prints the Wi-Fi configuration parameters.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void print_wifi_config()</p>
<p>{</p>
<p>uint32_t current_li;</p>
<p>uint32_t current_traffic_tmo;</p>
<p>uint32_t current_pm_flags;</p>
<p>int current_sleep_period;</p>
<p>wcm_pm_config_get(wcm_handle,&amp;current_li,
&amp;current_traffic_tmo,&amp;current_pm_flags);</p>
<p>wcm_pm_get_sleep_period(wcm_handle, &amp;current_sleep_period);</p>
<p>os_printf(”\n******\n”);</p>
<p>os_printf(“li: %d\n”, current_li);</p>
<p>os_printf(“traffic_tmo: %d\n”, current_traffic_tmo);</p>
<p>os_printf(“pm_flags: 0x%x\n”, current_pm_flags);</p>
<p>os_printf(“sleep_period: %d ms\n”, current_sleep_period/1000);</p>
<p>os_printf(”******\n”);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="running-the-application">
<h2>Running the Application<a class="headerlink" href="#running-the-application" title="Permalink to this heading"></a></h2>
</section>
<section id="programming-talaria-two-using-the-download-tool">
<h2>Programming Talaria TWO using the Download Tool<a class="headerlink" href="#programming-talaria-two-using-the-download-tool" title="Permalink to this heading"></a></h2>
<p>Program chip_monitor.elf
<em>(freertos_sdk_x.y\examples\chip_monitor\bin)</em> using the Download
tool:</p>
<ol class="arabic simple">
<li><p>Launch the Download tool provided with InnoPhase Talaria TWO SDK.</p></li>
<li><p>In the GUI window:</p>
<ol class="loweralpha simple">
<li><p>Boot Target: Select the appropriate EVK from the drop-down</p></li>
<li><p>ELF Input: Load the ELF by clicking on Select ELF File.</p></li>
<li><p>AP Options: Provide the SSID and Passphrase under AP Options to
connect to an Access Point.</p></li>
<li><p>Boot Arguments: Pass the following boot arguments to enable power
service and disable all other services:</p></li>
</ol>
</li>
</ol>
<blockquote>
<div><p><strong>Enabling only Power_service</strong>:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>adc_service=0,vbat_service=0,temperature_service=0,power
_service=1,suspend=1,arp_enable=0,li=10,minterval=10,measure_count=15</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="loweralpha simple" start="5">
<li><p>Programming: Prog RAM or Prog Flash as per requirement.</p></li>
</ol>
<p>Expected Output:</p>
<p>On flashing the application using the Download Tool, the console output
is as follows. The application displays the current measured and the
Average current in µA.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PWWWWWWWAE</p>
<p>Build $Id: git-5b930c8 $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0080-0055-ffffffffffff</p>
<p>Bootargs: adc_service=0 vbat_service=0 temperature_service=0
power_service=1 ssid=ratheesh passphrase=1122334455</p>
<p>=== CMS - Chip Monitor Service ===</p>
<p>addr e0:69:3a:00:08:38</p>
<p>network profile created for ssid: ratheesh</p>
<p>Wait for 15 seconds for the device to stabilize before starting power
measurement service</p>
<p>[0.756,643] ASSOCIATION:FAIL=2,30</p>
<p>[0.756,830] DISCONNECTED</p>
<p>[2.857,188] CONNECT:be:2a:54:1b:92:2d Channel:6 rssi:-40 dBm</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_LINK_UP</p>
<p>wcm_notify_cb to App Layer - WCM_NOTIFY_MSG_ADDRESS</p>
<p>[3.505,627] MYIP 172.20.10.2</p>
<p>[3.505,675] IPv6 [fe80::e269:3aff:fe00:838]-link</p>
<p>Enabling power consumption service</p>
<p>== Calibrating ==</p>
<p>Chip mscource power</p>
<p>Waiting to start power measurement!</p>
<p>== Calibrating ==</p>
<p>Chip mscource power</p>
<p>Waiting to start power measurement!</p>
<p>== Calibrating ==</p>
<p>Chip mscource power</p>
<p>Time:45 sec;Power measurement-1:7555uA</p>
<p>Average Current:7555uA</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p><strong>Enabling adc, vbat and temp services</strong>:</p>
<p>In the GUI, Boot Arguments: Pass the following boot arguments to disable
power service and enable all other services:</p>
<p>Add the following boot arguments to disable power service and enable all
other services:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>adc_service=1,vbat_service=1,temperature_service=1,power_service=0</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Expected Output:</p>
<p>On flashing the application using the Download Tool, the console output
is as follows.</p>
<p>The application displays the raw value that varies according to the
input provided to the ADC pin. Apart from the raw value measured out of
the ADC pin, the internal temperature in °C and VBAT measured from
source in mV are also displayed.</p>
<p>The following is the expected output:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PWWWWWWWAE</p>
<p>Build $Id: git-5b930c8 $</p>
<p>Flash detected. flash.hw.uuid: 39483937-3207-0080-0055-ffffffffffff</p>
<p>Bootargs: adc_service=1 vbat_service=1 temperature_service=1
power_service=0</p>
<p>=== CMS - Chip Monitor Service ===</p>
<p>Enabling ADC service</p>
<p>Enabling VBAT service</p>
<p>Enabling Temperature service</p>
<p>== Calibrating ==</p>
<p>Time:0 sec Chip ADCin: 504</p>
<p>== Calibrating ==</p>
<p>Time:0 sec Chip Vbat: 3216 dV</p>
<p>== Calibrating ==</p>
<p>Time:0 sec Chip Core Temp: 25 C</p>
<p>== Calibrating ==</p>
<p>Time:10 sec Chip ADCin: 7</p>
<p>== Calibrating ==</p>
<p>Time:10 sec Chip Core Temp: 26 C</p>
<p>== Calibrating ==</p>
<p>Time:20 sec Chip Core Temp: 25 C</p>
<p>== Calibrating ==</p>
<p>Time:30 sec Chip Core Temp: 26 C</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="chip-monitoring-services-hosted-application">
<h2>Chip Monitoring Services - Hosted Application<a class="headerlink" href="#chip-monitoring-services-hosted-application" title="Permalink to this heading"></a></h2>
<blockquote>
<div><p>The application running on an external host can communicate with
Talaria TWO and fetch the information on the change in the values of
the core temperature, External ADC, VBAT and the estimated current
measured values. The procedure to fetch this information is described
in the following sections.</p>
</div></blockquote>
</section>
<section id="application-running-on-external-host">
<h2>Application Running on External Host<a class="headerlink" href="#application-running-on-external-host" title="Permalink to this heading"></a></h2>
<p>The talaria_cli.py script running on the host (PC) will fetch required
information from stw application running on the Talaria TWO to fetch the
required information. The following are the steps to be executed:</p>
<ol class="arabic simple">
<li><p>Flash the bins/stw.elf onto Talaria TWO (refer steps in section 9.1.1
for more details on flashing the ELF onto Talaria TWO).</p></li>
</ol>
<blockquote>
<div><p>Console output:</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790dal- b- 7</p>
<p>ROM yoda- h0- rom- 16- 0- gd5a8e586</p>
<p>FLASH: PNWWWWWAEBuild $Id: git – d468c7b54 $</p>
<p>Serial – to – Wireless: Ready</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="2">
<li><p>Execute the following in Talaria TWO command line:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>python3 ./script/talaria_cli.py /dev/ttyUSB2</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Console output:</p>
<p><a class="reference internal" href="../../_images/image110.png"><img alt="Text Description automatically generated" src="../../_images/image110.png" style="width: 6.29931in; height: 2.73611in;" /></a></p>
</div></blockquote>
<p>Figure : Talaria TWO - Command Line Output</p>
<ol class="arabic simple" start="3">
<li><p>In the Talaria CLI, create a WCM handle and connect to a network.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>[talaria-2]$ create</p>
<p>[talaria-2]$ add_network &lt;SSID&gt; -p &lt;Password&gt;</p>
<p>[talaria-2]$ auto_connect</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>The execution of these commands and the output is as follows:</p>
<p><a class="reference internal" href="../../_images/image23.png"><img alt="image1" src="../../_images/image23.png" style="width: 6.19583in; height: 2.17014in;" /></a></p>
</div></blockquote>
<p>Figure : Creating a WCM handle and connecting to a network</p>
<ol class="arabic simple" start="4">
<li><p>Enable device suspend</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>[talaria-2]$ suspend 1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="5">
<li><p>Execute chip_monitor to fetch data from Talaria TWO:</p>
<ol class="loweralpha simple">
<li><p>To initiate chip_monitor, execute the following command:</p></li>
</ol>
</li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>[talaria-2]$ chip_monitor -ip</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="loweralpha simple" start="2">
<li><p>To start chip_monitor, execute the following command:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>[talaria-2]$ chip_monitor –start -s&lt;0/1/2/3&gt; -i&lt;interval&gt;</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Console outputs for the sources – Estimated Current measurement, ADC,
Internal temperature and VBAT are as follows:</p>
<ol class="arabic simple">
<li><p>Estimated current measurement:</p></li>
</ol>
<p><a class="reference internal" href="../../_images/image33.png"><img alt="image2" src="../../_images/image33.png" style="width: 6.32788in; height: 2.61026in;" /></a></p>
<p>Figure : Estimated current measurement</p>
<ol class="arabic simple" start="2">
<li><p>ADC:</p></li>
</ol>
<p><a class="reference internal" href="../../_images/image4.jpeg"><img alt="image3" src="../../_images/image4.jpeg" style="width: 6.06446in; height: 2.0297in;" /></a></p>
<p>Figure 4: ADC</p>
<ol class="arabic simple" start="3">
<li><p>Internal Temperature:</p></li>
</ol>
<p><a class="reference internal" href="../../_images/image5.jpeg"><img alt="image4" src="../../_images/image5.jpeg" style="width: 6.00885in; height: 2.10018in;" /></a></p>
<p>Figure 5: Internal temperature</p>
<ol class="arabic simple" start="4">
<li><p>VBAT:</p></li>
</ol>
<p><a class="reference internal" href="../../_images/image62.jpeg"><img alt="image5" src="../../_images/image62.jpeg" style="width: 6.17334in; height: 2.19167in;" /></a></p>
<p>Figure 6: VBAT</p>
</section>
<section id="measured-current-values-for-multiple-dtim-intervals">
<h2>Measured Current Values for multiple DTIM Intervals<a class="headerlink" href="#measured-current-values-for-multiple-dtim-intervals" title="Permalink to this heading"></a></h2>
<p>For reference, the estimated power consumption values measured using the
chip_monitor app for various DTIM intervals (clean environment current
numbers) are provided in Table 1.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>DTIM</strong></p></th>
<th class="head"><p><strong>Current consumption (µA)</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>~395</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>~140</p></td>
</tr>
<tr class="row-even"><td><p>10</p></td>
<td><p>~52</p></td>
</tr>
<tr class="row-odd"><td><p>100</p></td>
<td><p>~22</p></td>
</tr>
</tbody>
</table>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Example_for_Software_SPI_Master.html" class="btn btn-neutral float-left" title="Software SPI Master" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Example_for_using_Filesystem.html" class="btn btn-neutral float-right" title="Filesystem" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 InnoPhase IoT, Inc. | All Rights Reserved | Proprietary &amp; Confidential.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>