<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction &mdash; InnoPhase 1.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Regulatory Notice" href="../Regulatory%20Notices/Regulatory%20Notices.html" />
    <link rel="prev" title="Introduction" href="Wi-Fi%20Power%20Management.html" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="../_static/js/custom.js" defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            InnoPhase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Getting_Started_Landing_page.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Hardware-Reference.html">Hardware-Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Porting-Guide.html">Porting-Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Software_Reference/Prerequisites/libusbK_driver-Zadig.html">Software Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Development_Environments/Development_Environments.html">Development Environments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Tools/Tools_Landing.html">Tools</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="Applications-Landing_Page.html">Applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#alarm">1.  Alarm</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#analog-to-digital-converter">2.  Analog to Digital Converter</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#audio-over-i2s">3.  Audio over I2S</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#ble-5-0">4.  BLE 5.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#ble-beacons">3.  BLE Beacons</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#ble-wi-fi-bridge">4.  BLE Wi-Fi Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#chip-monitor">5.  Chip Monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#crash-handling">6.  Crash Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#custom-atcmdlib">6.  Custom ATCMDLIB</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#filesystem">7.  Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#firmware-over-the-air-upgrade">8.  Firmware Over the Air Upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#gpio">9.  GPIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#host-interface-protocol">10. Host Interface Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#http-client">11. HTTP Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#i2c">12. I2C</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#ifttt">13. IFTTT</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#iot-aws">14. IoT AWS</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#iot-azure">15. IoT Azure</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#low-power-scan">16. Low Power Scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#low-power-uart">17. Low Power UART</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#mdns">18. mDNS</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#memory-management-and-error-handling">19.  Memory Management and Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#message-queues">20.  Message Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#mqtt">21.  MQTT</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#provisioning">22.  Provisioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#pulse-width-modulation">23.  Pulse Width Modulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#radio-and-module-parameters">24. Radio and Module Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#secure-files">25. Secure Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#simple-network-time-protocol">26.  Simple Network Time Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#sleep-enable-disable">27.  Sleep Enable Disable</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#socket-wakeup">28. Socket Wakeup</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#software-spi-master">29. Software SPI Master</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#spi-flash">30. SPI Flash</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#ssbl">31. SSBL</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#thread-and-semaphores">32.  Thread and Semaphores</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#throughput-measurement">32.  Throughput Measurement</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#timers-and-callouts">33. Timers and Callouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#unassociated-mode">34. Unassociated Mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#using-wi-fi">35. Using Wi-Fi</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#watchdog-timer">36. Watchdog Timer</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#websocket-client">37. Websocket Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#wi-fi-connection-manager-multi-ap">38. Wi-Fi Connection Manager Multi-AP</a></li>
<li class="toctree-l2"><a class="reference internal" href="Applications-Landing_Page.html#wi-fi-power-management">39. Wi-Fi Power Management</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="Applications-Landing_Page.html#work-queues">40. Work Queues</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#work-queue">Work Queue</a></li>
<li class="toctree-l3"><a class="reference internal" href="#work-queue-apis">Work Queue APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#os-init-work">os_init_work()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-init-workqueue">os_init_workqueue()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-run-work">os_run_work()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-flush-workqueue">os_flush_workqueue()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-queue-work">os_queue_work()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-cancel-work">os_cancel_work()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-queue-system-work">os_queue_system_work()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-init-delayed-work">os_init_delayed_work()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-queue-delayed-work">os_queue_delayed_work()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#os-cancel-delayed-work">os_cancel_delayed_work()</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#code-walkthrough">Code Walkthrough</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sample-application-1-work-queue-using-system-thread">Sample Application 1 – Work Queue using System Thread</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sample-application-2-work-queue-using-application-defined-thread">Sample Application 2 – Work Queue using Application defined Thread</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Regulatory%20Notices/Regulatory%20Notices.html">Regulatory Notice</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Security/Security%20-%20Landing%20Page.html">Security</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Backend%20Files%20-%20for%20cross%20referencing/Backend%20File%20Landing.html">Backend Files - for cross referencing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">InnoPhase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="Applications-Landing_Page.html">Applications</a></li>
      <li class="breadcrumb-item active">Introduction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/Applications/Work Queues.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading"></a></h1>
<p>This application note describes the concept and usage of Work Queues.
Accompanying sample application provides a brief on how to use Work
Queue APIs available with the SDK.</p>
</section>
<section id="work-queue">
<h1>Work Queue<a class="headerlink" href="#work-queue" title="Permalink to this heading"></a></h1>
<p>Work Queues are used to defer a set of work by scheduling functions
doing that work to run by a dedicated thread. For example, a set of work
can be differed from interrupt context to thread context using this
mechanism.</p>
<p>These deferred function calls are managed by an abstraction called work,
defined by the struct os_work, which is initialized with a work function
by calling os_init_work().</p>
<p>A work queue is a list of os_work objects which are initialized using
os_init_workqueue().</p>
<p>Once the work queue is created and initialized, a set of Work objects
can be Queued to this queue.</p>
<p>A dedicated thread called Worker Thread is created to service the work
queue. This thread simply calls the function os_run_work() with a
pointer to an initialized work queue as a single argument. Then the
functions in the queued set of work are called from this thread’s
context when the Worker Thread is given time to run by the scheduler.</p>
<p>More information on the APIs in the consecutive sections.</p>
<p>The system automatically creates a work queue on start-up that is used
internally for executing system type work. For example, cleaning up
after the threads have terminated. It is called a system work queue and
can be used by applications having simple work functions, not requiring
a dedicated thread context.</p>
<p>Alternatively, application defined threads can be used to service a work
queue. This gives more control to the application to create many threads
and manage their properties (stack size and priorities) as per the
needs.</p>
<p>Two examples accompanying this application note showcase the system
threads approach and application created threads approach for servicing
the work queue.</p>
</section>
<section id="work-queue-apis">
<h1>Work Queue APIs<a class="headerlink" href="#work-queue-apis" title="Permalink to this heading"></a></h1>
<section id="os-init-work">
<h2>os_init_work()<a class="headerlink" href="#os-init-work" title="Permalink to this heading"></a></h2>
<p>Initializes a struct os_work with a work function. Pointers to both the
work functions are passed as input.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static inline void os_init_work(struct os_work *work, os_workfn_t
func)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="os-init-workqueue">
<h2>os_init_workqueue()<a class="headerlink" href="#os-init-workqueue" title="Permalink to this heading"></a></h2>
<p>Initializes os_workqueue struct.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void os_init_workqueue(struct os_workqueue *wq)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="os-run-work">
<h2>os_run_work()<a class="headerlink" href="#os-run-work" title="Permalink to this heading"></a></h2>
<p>This function is called to service a work queue.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void os_run_work(struct os_workqueue *wq)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The function will not return until the work queue is flushed via a call
to os_flush_workqueue().</p>
</section>
<section id="os-flush-workqueue">
<h2>os_flush_workqueue()<a class="headerlink" href="#os-flush-workqueue" title="Permalink to this heading"></a></h2>
<p>Called to flush a work queue.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void os_flush_workqueue(struct os_workqueue *wq)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Flushing a work queue stops any new work from being queued and signals
the os_run_work() function to exit when the previously queued work has
been completed.</p>
</section>
<section id="os-queue-work">
<h2>os_queue_work()<a class="headerlink" href="#os-queue-work" title="Permalink to this heading"></a></h2>
<p>Used to queue work on a specified work queue. Pointers to both are
passed as input.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int os_queue_work(struct os_workqueue *wq, struct os_work *work)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Returns true if work is added to the work queue, false if the work is
not (for example, if work is already queued or work queue is destroyed).
The work struct must have been initialized before passing it to this
function.</p>
<p>The work will be queued on the specified work queue and handled when the
associated worker thread is given time to run by the scheduler.</p>
</section>
<section id="os-cancel-work">
<h2>os_cancel_work()<a class="headerlink" href="#os-cancel-work" title="Permalink to this heading"></a></h2>
<p>Removes work from the specified work queue.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int os_cancel_work(struct os_work *work)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Work that has been queued on a work queue may be removed while it is
waiting to be carried out. This function will remove such work if it has
not yet reached the head of the service queue.</p>
<p>Returns true if the work was pending on the work queue, false otherwise.</p>
</section>
<section id="os-queue-system-work">
<h2>os_queue_system_work()<a class="headerlink" href="#os-queue-system-work" title="Permalink to this heading"></a></h2>
<p>Queues work on the system work queue.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int os_queue_system_work(struct os_work *work)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The system work queue can be used by applications that have simple work
functions that do not require a dedicated thread context. The work
functions that are scheduled on the system work queue should be
relatively simple to avoid starving others out.</p>
</section>
<section id="os-init-delayed-work">
<h2>os_init_delayed_work()<a class="headerlink" href="#os-init-delayed-work" title="Permalink to this heading"></a></h2>
<p>Initializes struct os_delayed_work with a work function.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void os_init_delayed_work(struct os_delayed_work *dw, os_workfn_t
func)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="os-queue-delayed-work">
<h2>os_queue_delayed_work()<a class="headerlink" href="#os-queue-delayed-work" title="Permalink to this heading"></a></h2>
<p>Queues work that is to be run at the specified absolute time passed as
parameter expire in the future on the specified work queue.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int os_queue_delayed_work (struct os_delayed_work *dw,</p>
<p>struct os_workqueue *wq, uint32_t expire)</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The delayed work struct must have been initialized before passing it to
this function. The work will be queued on the specified work queue when
the system time passes the expiration value. Returns true if the delayed
work was previously pending, false otherwise.</p>
</section>
<section id="os-cancel-delayed-work">
<h2>os_cancel_delayed_work()<a class="headerlink" href="#os-cancel-delayed-work" title="Permalink to this heading"></a></h2>
<p>Cancels a pending delayed work from expiring.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int os_cancel_delayed_work(struct os_delayed_work *dw)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Delayed work that has been scheduled to run on a work queue may be
removed while waiting for its timer to expire. Returns true if the
delayed work was still pending to be put on the work queue, false
otherwise.</p>
</section>
</section>
<section id="code-walkthrough">
<h1>Code Walkthrough<a class="headerlink" href="#code-walkthrough" title="Permalink to this heading"></a></h1>
<section id="sample-application-1-work-queue-using-system-thread">
<h2>Sample Application 1 – Work Queue using System Thread<a class="headerlink" href="#sample-application-1-work-queue-using-system-thread" title="Permalink to this heading"></a></h2>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h3>
<p>In the sample code in the path /examples/innoos_work_q/src/workq1.c, a
work is initialized and added to the system work queue. The work is to
convert the received data structure into a specific json format and
print it to console output.</p>
</section>
<section id="sample-code-walkthrough">
<h3>Sample Code Walkthrough<a class="headerlink" href="#sample-code-walkthrough" title="Permalink to this heading"></a></h3>
<p>Define a data structure for the data which is to be handled in the work:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*define the data for the work*/</p>
<p>typedef struct my_wq_data_tag</p>
<p>{</p>
<p>struct os_work work; /*first member should be of type struct
os_work*/</p>
<p>char deviceid[64];</p>
<p>int current_reading;</p>
<p>struct os_thread *generated_by;</p>
<p>}my_wq_data;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>As shown in the code, apart from struct os_work, this structure has a
character array to hold the device ID, an integer current reading, and
an os_thread structure pointer to keep the reference of the thread which
will be generating and populating this structure.</p>
<p>Worker function is defined as shown in the following code snippet. This
is the thread function for the work and forms a simple payload (json)
from the input and prints it to the console.</p>
<p>The work function takes a pointer to a work object, struct os_work
*work, as input. A pointer to the full data structure defined for work
can be retrieved using macro container_of() on this pointer *work
provided to the worker function.</p>
<p>The macro container_of(ptr, type,member)takes three arguments:</p>
<ol class="arabic simple">
<li><p>A pointer</p></li>
<li><p>Type of the container</p></li>
<li><p>Name of the member the pointer refers to.</p></li>
</ol>
<blockquote>
<div><p>The macro will then expand to a new address pointing to the container
which accommodates the respective member.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void prepare_and_dispatch_device_reading_json(struct os_work
*work)</p>
<p>{</p>
<p>my_wq_data *my_data;</p>
<p>/*extracting the app data*/</p>
<p>my_data = container_of(work, my_wq_data, work);</p>
<p>os_printf
(”\n{\n\t\”device_id\”:\”%s\”,\n\t\”r
eading\”:%u,\n\t\”generated_by\”:%x,\n\t\”send_by\”:%x\n}”,</p>
<p>my_data-&gt;deviceid,</p>
<p>my_data-&gt;current_reading,(unsignedint)my_data-&gt;generated_by,</p>
<p>(unsignedint)os_self());</p>
<p>os_msleep(25);</p>
<p>os_free (my_data);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Data for the work is prepared by the application main thread.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*preparing the data for the work*/</p>
<p>my_wq_data *data ;</p>
<p>data = os_alloc(sizeof(my_wq_data));</p>
<p>snprintf (data-&gt;deviceid,sizeof(data-&gt;deviceid),”this is exe by
system thread_%u”, rand());</p>
<p>data-&gt;current_reading =1;</p>
<p>data-&gt;generated_by = os_self();</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>To initialize a work and to associate a function with it, we use
os_init_work().</p>
<p>Here, the member work of my_wq_data *data is initialized and associated
with worker function prepare_and_dispatch_device_reading_json().</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*initialize the work, associating work, and work function*/</p>
<p>os_init_work(&amp;data-&gt;work, prepare_and_dispatch_device_reading_json);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>To add a work to the work queue, we use os_queue_system_work().</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*inserting to system work q*/</p>
<p>os_queue_system_work(&amp;data-&gt;work);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Please note that the system work queue does not need to be separately
created or initialized, as it is created and initialized at the time of
system start-up itself.</p>
<p>When the system work queue is serviced by the system thread, it will
call the worker function with parameter *work, which will eventually
retrieve the full data structure associated with my_wq_data *my_data,
and will perform the defined work on that data from the context of the
system thread.</p>
<p>The work defined here is printing the data and the reference to the
thread which generated the data to the console in a json format, as
shown in section 5.1.4.</p>
</section>
<section id="running-the-application">
<h3>Running the Application<a class="headerlink" href="#running-the-application" title="Permalink to this heading"></a></h3>
<p>Program workq1.elf(sdk_x.y\examples\innoos_work_q\bin) using the
Download tool:</p>
<ol class="arabic simple">
<li><p>Launch the Download tool provided with InnoPhase Talaria TWO SDK.</p></li>
<li><p>In the GUI window:</p>
<ol class="loweralpha simple">
<li><p>Boot Target: Select the appropriate EVK from the drop-down.</p></li>
<li><p>ELF Input: Load the workq1.elf by clicking on Select ELF File.</p></li>
<li><p>Programming: Prog RAM or Prog Flash as per requirement.</p></li>
</ol>
</li>
</ol>
<p>For more details on using the Download tool, refer to the document:
UG_Download_Tool.pdf (path: <em>sdk_x.y/pc_tools/Download_Tool/doc</em>).</p>
<p><strong>Note</strong>: x and y refer to the SDK release version. For example:
sdk_2.4/doc.</p>
</section>
<section id="expected-output">
<h3>Expected Output<a class="headerlink" href="#expected-output" title="Permalink to this heading"></a></h3>
<p>workq1.elf is created when compiling this code and gives the following
console output when programmed to Talaria TWO.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>UART:NWWWWWAE4 DWT comparators, range 0x8000</p>
<p>Build $Id: git-7e2fd6a94 $</p>
<p>app=gordon</p>
<p>flash: Gordon ready!</p>
<p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWAEBuild $Id: git-65f6c1f46 $</p>
<p>$App:git-46e2bea7</p>
<p>SDK Ver: sdk_2.4</p>
<p>Workqueue Demo App 1</p>
<p>{</p>
<p>“device_id”:”this is exe by system thread_0”,</p>
<p>“reading”:1,</p>
<p>“generated_by”:b2de0,</p>
<p>“send_by”:bede8</p>
<p>}</p>
<p>all done</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="sample-application-2-work-queue-using-application-defined-thread">
<h2>Sample Application 2 – Work Queue using Application defined Thread<a class="headerlink" href="#sample-application-2-work-queue-using-application-defined-thread" title="Permalink to this heading"></a></h2>
<section id="overview-1">
<span id="id1"></span><h3>Overview<a class="headerlink" href="#overview-1" title="Permalink to this heading"></a></h3>
<p>In the sample code in the path /examples/innoos_work_q/src/workq2.c, two
threads are created to generate requests to the work queue and two
threads for handling the requests.</p>
</section>
<section id="sample-code-walkthrough-1">
<span id="id2"></span><h3>Sample Code Walkthrough<a class="headerlink" href="#sample-code-walkthrough-1" title="Permalink to this heading"></a></h3>
<p>Define a data structure for the data which is to be handled in the work:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*define the data structure for the workqueue*/</p>
<p>typedef struct my_wq_data_tag</p>
<p>{</p>
<p>Struct os_work work;</p>
<p>char deviceid[64];</p>
<p>int current_reading;</p>
<p>struct os_thread *generated_by;</p>
<p>}my_wq_data;</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>As shown in the code, apart from struct os_work, this structure has a
character array to hold the device ID, an integer current reading, and
an os_thread structure pointer to keep the reference of the thread which
will be generating and populating this structure.</p>
<p>In this sample, two different work functions are defined.</p>
<p>First work function, prepare_and_dispatch_device_reading_json() forms
the json message from the input data.</p>
<p>Second work function prepare_and_dispatch_device_reading_xml()prints to
the console in XML format.</p>
<p>Both the work functions take the pointer to a work object, struct
os_work *work, as input. A pointer to the full data structure defined
for work can be retrieved using macro container_of() on this pointer
*work, which is provided to the worker function, as explained in the
code sample in section 5.1.</p>
<p>Work 1:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void prepare_and_dispatch_device_reading_json(struct os_work
*work)</p>
<p>{</p>
<p>my_wq_data *my_data;</p>
<p>/*extracting the app data*/</p>
<p>my_data = container_of(work, my_wq_data, work);</p>
<p>os_printf
(”\n{\n\t\”device_id\”:\”%s\”,\n\t\”r
eading\”:%u,\n\t\”generated_by\”:%x,\n\t\”send_by\”:%x\n}”,</p>
<p>my_data-&gt;deviceid,</p>
<p>my_data-&gt;curren
t_reading,(unsignedint)my_data-&gt;generated_by,(unsignedint)os_self());</p>
<p>os_msleep(25);</p>
<p>os_free (my_data);}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Work2:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void prepare_and_dispatch_device_reading_xml(struct os_work
*work)</p>
<p>{</p>
<p>my_wq_data *my_data;</p>
<p>/*extracting the app data*/</p>
<p>my_data = container_of(work, my_wq_data, work);</p>
<p>os_printf
(”\n{\n\t\”device_id\”:\”%s\”,\n\t\”reading\”:%u, \</p>
<p>\n\t\”generated_by\”:%x,\n\t\”send_by\”:%x\n}”,</p>
<p>my_data-&gt;deviceid,</p>
<p>my_data-&gt;current_reading, (unsigned int)my_data-
&gt;generated_by,(unsigned int)os_self());</p>
<p>os_msleep(25);</p>
<p>os_free (my_data);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>In this example, a separate thread is created to service the work queue
where a work queue is to be initialized. To achieve this we use
os_init_workqueue().</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*work q handle*/</p>
<p>struct os_workqueue hwq;</p>
<p>/*initializing work q*/</p>
<p>os_init_workqueue(&amp;hwq);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Two worker threads (worker1 and worker2) are created and associated with
the same work queue previously initialized.</p>
<p>To achieve this, os_create_thread()is used to create these two worker
threads and a function is associated with them:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*thread 1*/</p>
<p>os_create_thread(“worker1”, my_work_thread,&amp;hwq,1, WORKQ_STACK_SIZE);</p>
<p>/*thread 2*/</p>
<p>os_create_thread(“worker2”, my_work_thread,&amp;hwq,1, WORKQ_STACK_SIZE);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The function my_work_thread()is associated with both the worker threads.</p>
<p>The work queue handle is passed as an argument to this thread function
while creating both the worker threads.</p>
<p>The application can set the required stack size and priority for the
threads based on the type of work it intends to defer to these threads.</p>
<p>The thread function takes the pointer to the work queue handle passed as
input and calls os_run_work()with this work queue handle.
os_run_work()is a blocking call and it will exit on
os_flush_workqueue().</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void *my_work_thread(void*p)</p>
<p>{</p>
<p>struct os_workqueue *wq = p;</p>
<p>os_printf (”\n%x:started worker thread”,(unsignedint)os_self());</p>
<p>os_run_work(wq);</p>
<p>/* the above function will return when the workqueue is destroyed*/</p>
<p>os_printf (”\n%x:exitng worker thread”,(unsignedint)os_self());</p>
<p>returnNULL;}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Two more threads (producer1 and producer2) are created in this example
and are associated with the same work queue initialized previously.
These producer threads will produce the work for the worker threads
previously created.</p>
<p>To achieve this, os_create_thread()is used to create these two producer
threads and a function is associated with them:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>int main()</p>
<p>{</p>
<p>…</p>
<p>…</p>
<p>producer_thread_1 = os_create_thread(“producer1”,
workq_load_producer, &amp;hwq, 1, WORKQ_STACK_SIZE);</p>
<p>producer_thread_2 = os_create_thread(“producer2”,
workq_load_producer, &amp;hwq, 1, WORKQ_STACK_SIZE);</p>
<p>os_join_thread(producer_thread_1);</p>
<p>os_join_thread(producer_thread_2);</p>
<p>…</p>
<p>…</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The function workq_load_producer()is associated with both of these
producer threads. The work queue handle is passed as an argument to this
thread function while creating both the producer threads.</p>
<p>The data for the work is prepared by these producer threads inside the
thread function workq_load_producer(), and os_init_work() is used to
associate the work with the two work functions in a way that alternate
data goes to xml and json works.</p>
<p>The work is then added to the work queue using os_queue_work()which
returns true if succeeds in adding or false if the work is already
queued.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static void *workq_load_producer(void*p)</p>
<p>{</p>
<p>struct os_workqueue *wq = p;</p>
<p>int msg_counter = 0;</p>
<p>…</p>
<p>…</p>
<p>while ( (msg_counter &lt;= MAX_MESSAGES_PER_THREAD))</p>
<p>{</p>
<p>my_wq_data *data ;</p>
<p>data = os_alloc(sizeof(my_wq_data));</p>
<p>snprintf (data-&gt;deviceid, sizeof(data-&gt;deviceid), “abcd_xyz_%u”,
rand());</p>
<p>data-&gt;current_reading = msg_counter;</p>
<p>data-&gt;generated_by = os_self();</p>
<p>…</p>
<p>…</p>
<p>…</p>
<p>if(0==(msg_counter%2))</p>
<p>{</p>
<p>os_init_work(&amp;data-&gt;work, prepare_and_dispatch_device_reading_json);</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p>os_init_work(&amp;data-&gt;work, prepare_and_dispatch_device_reading_xml);</p>
<p>}</p>
<p>/*inserting to the workq*/</p>
<p>ret = os_queue_work(wq, &amp;data-&gt;work);</p>
<p>if (!ret)</p>
<p>{</p>
<p>os_printf(”\nrequest is in q. ret:%d”, ret);</p>
<p>}</p>
<p>os_msleep(10);</p>
<p>++msg_counter;</p>
<p>}</p>
<p>…</p>
<p>…</p>
<p>…</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Each of the two producer threads adds work1 and work2 alternatively to
the work queue until a while loop counter finishes.</p>
<p>os_flush_workqueue() is used to send a signal to the
os_run_work()function to exit when all the previously queued work has
been completed.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/*for worker thread 1*/</p>
<p>os_flush_workqueue(&amp;hwq);</p>
<p>/*for worker thread 2*/</p>
<p>os_flush_workqueue(&amp;hwq);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
<section id="running-the-application-1">
<span id="id3"></span><h3>Running the Application<a class="headerlink" href="#running-the-application-1" title="Permalink to this heading"></a></h3>
<p>Program workq2.elf(sdk_x.y\examples\innoos_work_q\bin) using the
Download tool:</p>
<ol class="arabic simple">
<li><p>Launch the Download tool provided with InnoPhase Talaria TWO SDK.</p></li>
<li><p>In the GUI window:</p>
<ol class="loweralpha simple">
<li><p>Boot Target: Select the appropriate EVK from the drop-down.</p></li>
<li><p>ELF Input: Load the workq2.elf by clicking on Select ELF File.</p></li>
<li><p>Programming: Prog RAM or Prog Flash as per requirement.</p></li>
</ol>
</li>
</ol>
<p>For more details on using the Download tool, refer to the document:
UG_Download_Tool.pdf (path: <em>sdk_x.y/pc_tools/Download_Tool/doc</em>).</p>
<p><strong>Note</strong>: x and y refer to the SDK release version. For example:
sdk_2.4/doc.</p>
</section>
<section id="expected-output-1">
<span id="id4"></span><h3>Expected Output<a class="headerlink" href="#expected-output-1" title="Permalink to this heading"></a></h3>
<p>workq2.elf is created when compiling this code and gives the following
console output when programmed to Talaria TWO.</p>
<p>Note that when the two worker threads are started, send by field in each
message refers to either of these worker threads, whichever serviced the
message. Based on scheduling, the messages serviced by the worker
threads are random.</p>
<p>Each reading is generated twice, once per producer thread, and is shown
in generated by the field. All the even readings by both the producers
are dispatched as json and all the odd ones as xml.</p>
<p>This is provided as an output to the console till reading 50 is
generated by both the producers. Post this, the work queue is flushed,
and the worker threads exit as shown in the following snippet.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>UART:NWWWWWAE4 DWT comparators, range 0x8000</p>
<p>Build $Id: git-7e2fd6a94 $</p>
<p>app=gordon</p>
<p>flash: Gordon ready!</p>
<p>Y-BOOT 208ef13 2019-07-22 12:26:54 -0500 790da1-b-7</p>
<p>ROM yoda-h0-rom-16-0-gd5a8e586</p>
<p>FLASH:PNWWWAEBuild $Id: git-65f6c1f46 $</p>
<p>$App:git-46e2bea7</p>
<p>SDK Ver: sdk_2.4</p>
<p>Workqueue Demo App 2</p>
<p>bf968:started worker thread</p>
<p>b35e8:started worker thread</p>
<p>b3ae8:started worker thread</p>
<p>{</p>
<p>“device_id”:”abcd_xyz_0”,</p>
<p>“reading”:0,</p>
<p>“generated_by”:b3fe8,</p>
<p>“send_by”:bf968</p>
<p>}</p>
<p>&lt;payload&gt;</p>
<p>&lt;device_id&gt;</p>
<p>abcd_xyz_1774527498</p>
<p>&lt;/device_id&gt;</p>
<p>&lt;reading&gt;</p>
<p>1</p>
<p>&lt;/reading&gt;</p>
<p>&lt;generated_by&gt;</p>
<p>b3fe8</p>
<p>&lt;/generated_by&gt;</p>
<p>&lt;send_by&gt;</p>
<p>b3ae8</p>
<p>&lt;/send_by&gt;</p>
<p>&lt;/payload&gt;</p>
<p>{</p>
<p>“device_id”:”abcd_xyz_2099690603”,</p>
<p>“reading”:2,</p>
<p>“generated_by”:b3fe8,</p>
<p>“send_by”:b35e8</p>
<p>}</p>
<p>{</p>
<p>“device_id”:”abcd_xyz_1452469787”,</p>
<p>“reading”:0,</p>
<p>“generated_by”:b44e8,</p>
<p>“send_by”:bf968</p>
<p>}</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>&lt;payload&gt;</p>
<p>&lt;device_id&gt;</p>
<p>abcd_xyz_790790538</p>
<p>&lt;/device_id&gt;</p>
<p>&lt;reading&gt;</p>
<p>49</p>
<p>&lt;/reading&gt;</p>
<p>&lt;generated_by&gt;</p>
<p>b3fe8</p>
<p>&lt;/generated_by&gt;</p>
<p>&lt;send_by&gt;</p>
<p>b3ae8</p>
<p>&lt;/send_by&gt;</p>
<p>&lt;/payload&gt;</p>
<p>{</p>
<p>“device_id”:”abcd_xyz_2035955618”,</p>
<p>“reading”:40,</p>
<p>“generated_by”:b44e8,</p>
<p>“send_by”:bf968</p>
<p>}</p>
<p>&lt;payload&gt;</p>
<p>&lt;device_id&gt;</p>
<p>abcd_xyz_657584690</p>
<p>&lt;/device_id&gt;</p>
<p>&lt;reading&gt;</p>
<p>49</p>
<p>&lt;/reading&gt;</p>
<p>&lt;generated_by&gt;</p>
<p>b44e8</p>
<p>&lt;/generated_by&gt;</p>
<p>&lt;send_by&gt;</p>
<p>b3ae8</p>
<p>&lt;/send_by&gt;</p>
<p>&lt;/payload&gt;</p>
<p>b35e8:exiting worker thread</p>
<p>b3ae8:exiting worker thread</p>
<p>all done</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Wi-Fi%20Power%20Management.html" class="btn btn-neutral float-left" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../Regulatory%20Notices/Regulatory%20Notices.html" class="btn btn-neutral float-right" title="Regulatory Notice" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 InnoPhase IoT, Inc. | All Rights Reserved | Proprietary &amp; Confidential.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>