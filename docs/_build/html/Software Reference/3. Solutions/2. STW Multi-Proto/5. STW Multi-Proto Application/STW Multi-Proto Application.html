<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STW Multi Proto Application &mdash; InnoPhase 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Overview" href="../../3.%20Dual-Stack/Dual-Stack%20-%20Landing%20Page.html" />
    <link rel="prev" title="Host Application" href="../4.%20Host%20Application/Host%20Application.html" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="../../../../_static/js/custom.js" defer></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            InnoPhase
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Getting%20Started/Getting%20Started%20-%20Landing%20Page.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Hardware%20Reference/Hardware-Reference.html">Hardware-Reference</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../Software_Reference_Landing_Page.html">Software Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../Software_Reference_Landing_Page.html#libraries">Libraries</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../Software_Reference_Landing_Page.html#solutions">Solutions</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../Solutions%20-%20Landing%20Page.html">AT Commands</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../Solutions%20-%20Landing%20Page.html#stw-multi-proto">STW Multi-Proto</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../STW%20Multi-Proto%20-%20Landing%20Page.html">SMP Application Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="../STW%20Multi-Proto%20-%20Landing%20Page.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="../STW%20Multi-Proto%20-%20Landing%20Page.html#build-environment">Build Environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../STW%20Multi-Proto%20-%20Landing%20Page.html#evaluating-the-application">Evaluating the Application</a></li>
<li class="toctree-l4"><a class="reference internal" href="../STW%20Multi-Proto%20-%20Landing%20Page.html#host-application">Host Application</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../STW%20Multi-Proto%20-%20Landing%20Page.html#stw-multi-proto-application">STW Multi Proto Application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Solutions%20-%20Landing%20Page.html#dual-stack">Dual stack</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../Software_Reference_Landing_Page.html#cloud-frameworks">Cloud Frameworks</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Development%20Environments/Development%20Environments%20-%20Landing%20Page.html">Development Environments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Tools/Tools-landing%20page.html">Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Applications/Applications%20-%20Landing%20Page.html">Applications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Regulatory%20Notices/Regulatory%20Notices.html">Regulatory Notices</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Security/Security%20-%20Landing%20Page.html">Security</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Porting%20Guide/Porting-Guide.html">Porting-Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Support/Support.html">Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Disclaimers/Disclaimers.html">Disclaimer</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../Appendix/Appendix-Landing_Page.html">Appendix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">InnoPhase</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../Software_Reference_Landing_Page.html">Software Reference</a></li>
          <li class="breadcrumb-item"><a href="../../Solutions%20-%20Landing%20Page.html">AT Commands</a></li>
          <li class="breadcrumb-item"><a href="../STW%20Multi-Proto%20-%20Landing%20Page.html">SMP Application Flow</a></li>
      <li class="breadcrumb-item active">STW Multi Proto Application</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/Software Reference/3. Solutions/2. STW Multi-Proto/5. STW Multi-Proto Application/STW Multi-Proto Application.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="stw-multi-proto-application">
<h1>STW Multi Proto Application<a class="headerlink" href="#stw-multi-proto-application" title="Permalink to this heading"></a></h1>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this heading"></a></h2>
<p>This application represents various host interface APIs in groups called
HIO groups. The HIO groups are similar to the HAPI groups, except that
the HIO groups are part of the SMP application running on Talaria TWO.</p>
<p>HAPI and HIO groups maintain the same GROUP ID and MSGID numbers. The
list of required APIs can be enabled from the Makefile. Few APIs (like
WCM) are enabled by default.</p>
<p>Following is the description of the types of APIs supported by each of
these groups.</p>
<ol class="arabic simple">
<li><p>WCM: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Connect to and disconnect from a Wi-Fi network.</p></li>
<li><p>Set and get IPV4/IPV6 address.</p></li>
<li><p>Set/Get Wi-Fi power management.</p></li>
<li><p>Get RSSI and Tx power values.</p></li>
<li><p>Set regulatory domains.</p></li>
</ol>
</li>
<li><p>Socket: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Create a server and client socket.</p></li>
<li><p>Send and receive data.</p></li>
<li><p>Get peer information.</p></li>
</ol>
</li>
<li><p>MDNS: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Set up, stop, and resolve MDNS.</p></li>
<li><p>Add and remove an MDNS service.</p></li>
</ol>
</li>
<li><p>MQTT: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Connect to and disconnect from MQTT server.</p></li>
<li><p>Publish and subscribe to and unsubscribe from a topic.</p></li>
<li><p>Store and delete certificates required to perform MQTT over TLS.</p></li>
</ol>
</li>
<li><p>TLS: Provide APIs to:</p>
<ol class="loweralpha simple">
<li><p>Set up and close a TLS connection.</p></li>
<li><p>Upload a certificate.</p></li>
<li><p>Perform TLS handshake.</p></li>
<li><p>Read and write.</p></li>
</ol>
</li>
<li><p>BLE: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Create a BT host.</p></li>
<li><p>Perform GAP operations like setting GAP address, scan, discovery,
initiate/terminate a connection, configure broadcast,
discoverable modes and configure advertising interval.</p></li>
<li><p>Start a GATT server, initiate/destroy a GATT service, add
characteristics, configure the device to send notifications,
indications.</p></li>
</ol>
</li>
<li><p>HTTP: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Set up and start a HTTP client.</p></li>
<li><p>Send client data, set, and delete the HTTP client header.</p></li>
<li><p>Store and delete the certificates required to perform a TLS
connection.</p></li>
</ol>
</li>
<li><p>GPIO: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Select a GPIO.</p></li>
<li><p>Set and reset the state of the GPIO.</p></li>
</ol>
</li>
<li><p>File: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Add a file to the file system.</p></li>
<li><p>Delete a file from file system.</p></li>
</ol>
</li>
<li><p>AWS: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Connect to and disconnect from AWS server.</p></li>
<li><p>Set configuration like AWS host URL, thing name, AWS port, the
path of the certificates, client id.</p></li>
<li><p>Send and receive data from AWS server.</p></li>
</ol>
</li>
<li><p>FOTA: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Start FOTA operation.</p></li>
<li><p>Send FOTA configuration data.</p></li>
</ol>
</li>
<li><p>FOS: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Start firmware upgrade over serial port.</p></li>
<li><p>Send FOTA configuration data.</p></li>
<li><p>Commit FOS data to mark as end of image data received by Talaria
TWO.</p></li>
</ol>
</li>
<li><p>Un-assoc: Provides APIs to:</p>
<ol class="loweralpha simple">
<li><p>Start and stop the unassoc mode.</p></li>
<li><p>Configure the mode with parameters like number of probes to be
transmitted, transmission interval, data rate and information
element.</p></li>
</ol>
</li>
</ol>
<p>Talaria TWO device will service the functionality over UART/SPI/SDIO
interface. The normal operation is to first issue a HIO query request
message. The HIO query response message will include a table of groups
and messages supported by Talaria TWO. It also includes the maximum
request size the device can handle.</p>
</section>
<section id="request-response-message-exchange">
<h2>Request-Response Message Exchange<a class="headerlink" href="#request-response-message-exchange" title="Permalink to this heading"></a></h2>
<p>The SMP application registers a particular HIO group by calling the
&lt;group&gt;_hio_init() function which in turn calls the hio_api_init(const
struct hio_api *api, void *ctx) API to register the HIO message group.</p>
<p>The first argument struct hio_api *api has the following prototype:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static const struct hio_api hio_api = {</p>
<p>.group = 0,</p>
<p>.num_handlers = n,</p>
<p>.handler = {</p>
<p>Handler_1,</p>
<p>.</p>
<p>.</p>
<p>Handler_n,</p>
<p>}</p>
<p>};</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The hio_api struct specifies the following:</p>
<ol class="arabic simple">
<li><p>Group ID.</p></li>
<li><p>Number of handlers to be registered as a part of HIO group
registration.</p></li>
<li><p>Pointers to the handlers that call a Talaria TWO networking API (or a
custom user API which will be discussed in the subsequent sections)
to perform the request from the host.</p></li>
</ol>
<p>Each handler is associated with a unique ID called MSGID. When a request
packet is sent from a HAPI-based host, The HIO interpreter invokes the
corresponding handler based on the group_id and msg_id. The handler
calls the relevant Talaria TWO’s networking API to execute the request
received from the host and returns a response.</p>
<p>The communication between a HAPI-based application and the SMP
application is illustrated in Figure 7.</p>
<p><a class="reference internal" href="../../../../_images/image169.png"><img alt="Diagram Description automatically generated" src="../../../../_images/image169.png" style="width: 5.90551in; height: 5.30038in;" /></a></p>
<p>Figure 7: Exchange of request-response packets between Host and Talaria
TWO</p>
</section>
</section>
<section id="talaria-two-reset-sequence">
<h1>Talaria TWO Reset Sequence<a class="headerlink" href="#talaria-two-reset-sequence" title="Permalink to this heading"></a></h1>
<p>After Talaria TWO powers up, a reset needs to be issued by the host
application. This can be done by pulling down the reset pin low for a
period of about 100 ms and then high for a period of about 100 ms.</p>
<p><a class="reference internal" href="../../../../_images/image240.png"><img alt="A diagram of a data flow Description automatically generated" src="../../../../_images/image240.png" style="width: 4.72441in; height: 2.21222in;" /></a></p>
<p>Figure 8: Talaria TWO reset sequence block diagram</p>
<section id="code-walkthrough">
<h2>Code Walkthrough<a class="headerlink" href="#code-walkthrough" title="Permalink to this heading"></a></h2>
<p>The application first mounts the filesystem to access the certificates
and network configuration files.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>rval = utils_mount_rootfs();</p>
<p>if(0 != rval) {</p>
<p>os_printf(“Muonting rootfs failed.!\n”);</p>
<p>while(1);</p>
<p>}</p>
<p>os_printf(”\n[APP]root fs mounted, rval = %d”, rval);</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The application enables the API groups depending on the flag value set
in the make file (i.e., HAVE_&lt;GROUP&gt;_HIO). The HIO transport driver
initialization also occurs when the first message group is initialized.</p>
<p>The following block initializes the WCM, socket and MDNS groups if the
HAVE_&lt;GROUP&gt;_HIO value of the corresponding group is set to 1. Since
the WCM group is the first HIO group which is being initialized, the HIO
transport driver initialization occurs and the corresponding interface
i.e., UART/SPI/SDIO is configured on Talaria TWO.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>#if HAVE_WCM_HIO==1</p>
<p>strcat(banner, “, wcm”);</p>
<p>wcm_hio_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_SOCK_HIO==1</p>
<p>strcat(banner, “, sock”);</p>
<p>sock_hio_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_MDNS_HIO==1</p>
<p>strcat(banner, “, mdns”);</p>
<p>mdns_hio_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The following block initializes the MQTT, TLS, BT, HTTP, FOTA, FOS,
unassoc, provisioning and GPIO groups:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>#if HAVE_MQTT_HIO==1</p>
<p>strcat(banner, “, mqtt”);</p>
<p>mqtt_hio_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_TLS_HIO==1</p>
<p>strcat(banner, “, tls”);</p>
<p>tls_hio_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_BT_HIO==1</p>
<p>strcat(banner, “, bt”);</p>
<p>register_bt_host_hio();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_HTTP_HIO==1</p>
<p>strcat(banner, “, http”);</p>
<p>hio_http_client_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_HTTPS_HIO==1</p>
<p>strcat(banner, “, https”);</p>
<p>tls_hio_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_FOTA_APP==1</p>
<p>strcat(banner, “, FOTA”);</p>
<p>hio_fota_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_FOS_APP==1</p>
<p>strcat(banner, “, FOS”);</p>
<p>hio_fos_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_UNASSOC_SUPPORT==1</p>
<p>strcat(banner, “, UNASSOC”);</p>
<p>unassoc_api_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_PROV_APP==1</p>
<p>strcat(banner, “, PROV”);</p>
<p>hio_prov_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_FILE_HIO==1</p>
<p>strcat(banner, “, file”);</p>
<p>hio_file_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
<p>#if HAVE_AWS_HIO==1</p>
<p>strcat(banner, “, aws”);</p>
<p>aws_app_init();</p>
<p>num_groups_registered ++;</p>
<p>#endif</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>register_hio_packet_hook() function displays the group_id and msg_id of
every packet being sent and received on Talaria TWO.</p>
<p>First, the hook functions to display the packet data being received by
Talaria TWO (input hook) and the packet data being sent by Talaria TWO
(output hook) are defined.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void hio_input_packet_info(struct packet *pkt)</p>
<p>{</p>
<p>os_printf(“input-hook\n”);</p>
<p>show_packet_info(pkt);</p>
<p>}</p>
<p>void hio_output_packet_info(struct packet *pkt)</p>
<p>{</p>
<p>os_printf(“output-hook\n”);</p>
<p>show_packet_info(pkt);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The show_packet_info() function extracts the GROUP ID and the MSGID and
displays it.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void show_packet_info(struct packet *pkt)</p>
<p>{</p>
<p>const struct hio_msghdr *hdr;</p>
<p>hdr = packet_data(pkt);</p>
<p>uint32_t group = hdr-&gt;group, msgid = hdr-&gt;msgid;</p>
<p>os_printf(“hio: group=%d.msgid=%d\n”, group, msgid);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Now, the register_hio_packet_hook() function registers the input packet
hook and the output packet hook callback functions.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>void register_hio_packet_hook()</p>
<p>{</p>
<p>int ret;</p>
<p>ret = hio_packet_hook_register(hio_input_packet_info,</p>
<p>hio_output_packet_info);</p>
<p>os_printf(“Packet hook register status = %d\n”, ret);</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The application will register the HIO packet hook by calling the
register_hio_packet_hook () function when the bootarg displ_pkt_info=1
is issued.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>if(os_get_boot_arg_int(“disp_pkt_info”, 0) != 0) {</p>
<p>/* Register packet hook.</p>
<p>* Hook will print the msg_id and group_id of every packets sent and
received</p>
<p>*/</p>
<p>register_hio_packet_hook();</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Finally, if LWIP is running, the iPerf3 server is started and SNTP is
initialized.</p>
</section>
<section id="adding-custom-groups-to-smp-application">
<h2>Adding Custom Groups to SMP Application<a class="headerlink" href="#adding-custom-groups-to-smp-application" title="Permalink to this heading"></a></h2>
<p>When in hosted mode, there might be a requirement to add additional
features to the existing SMP application depending on the end user’s
requirements.</p>
<p>This section describes the procedure to add support for a custom group
to the SMP application with an example. The example application
demonstrates a message exchange between the host application and the SMP
application. The host sends a request message to Talaria TWO and waits
for a response message.</p>
<p>The enhancements need to be performed on both the HAPI-based host
application and the SMP application.</p>
<p>Subsequent sections describe the procedure to add support to custom
groups of the host application and then the procedure to add the support
for custom group.</p>
</section>
<section id="procedure-to-add-custom-group-to-the-host-application">
<h2>Procedure to Add Custom Group to the Host Application<a class="headerlink" href="#procedure-to-add-custom-group-to-the-host-application" title="Permalink to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Define a group number greater than 150 as GROUP ID. The group numbers
from 0 to 149 will be used by the existing groups.</p></li>
<li><p>Define a structure for the request message to be sent.</p></li>
<li><p>Define a structure for the response message to be received.</p></li>
<li><p>Create a HAPI packet to be sent.</p></li>
<li><p>Update/copy the data to be sent to the HAPI packet created.</p></li>
<li><p>Send the HAPI packet to Talaria TWO and wait for the response.</p></li>
<li><p>If the response is received, read the contents of the response
packet.</p></li>
<li><p>Release the memory allocated for the packet.</p></li>
</ol>
<p>From the above-described procedure, the following are defined in
api/custom.h in the example application:</p>
<ol class="arabic simple">
<li><p>Custom GROUP ID -158</p></li>
<li><p>MSGIDs for the custom request message-0x03</p></li>
<li><p>Custom response message-0x83</p></li>
<li><p>Structures for the custom request message</p></li>
<li><p>Custom response message</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>#define HIO_GROUP_CUSTOM 158</p>
<p>#define HAPI_CUSTOM_MSG_REQ 0x03</p>
<p>#define HAPI_CUSTOM_MSG_RSP 0x83</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Following is the structure defined for a custom request message:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct hapi_custom_msg_req {</p>
<p>char echo_req[MAX_MSG_SIZE]; /*Request message from host*/</p>
<p>};</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>Corresponding structure for a custom response message also needs to be
defined:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct hapi_custom_msg_rsp {</p>
<p>uint32_t status; /**&lt; result status, zero is success */</p>
<p>char echo_rsp[MAX_MSG_SIZE]; /**&lt; response from T2 */</p>
<p>};</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>A function to send and receive a packet to/from Talaria TWO (i.e.,
api_send_custom_msg()) is defined in <em>hapi\lib\src\hapi_custom.c.</em></p>
<p>First, a packet has to be created by allocating the required amount of
message buffer by calling hapi_pkt_msg_alloc()API.This API will allocate
the required memory and return a pointer of type struct hapi_packet. The
definitions of struct hapi_packet, struct hapi_msg_frame and struct
hapi_msg_hdr are as follows:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>/* Headers for all device communication —– */</p>
<p>struct hapi_msg_hdr {</p>
<p>uint8_t group;</p>
<p>uint8_t msgid;</p>
<p>uint16_t trxid;</p>
<p>};</p>
<p>struct hapi_msg_frame {</p>
<p>uint16_t size; // sizeof data + msghdr</p>
<p>struct hapi_msg_hdr msg_hdr;</p>
<p>};</p>
<p>/* Packet definition ———————– */</p>
<p>#define HAPI_PACKET_MAGIC 0x600D</p>
<p>struct hapi_packet {</p>
<p>uint16_t magic;</p>
<p>struct hapi_msg_frame frame;</p>
<p>void * msg;</p>
<p>struct hapi_packet * next;</p>
<p>};</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The pkt_out variable contains the pointer to the struct hapi_packet type
created. The hapi_pkt_msg(pkt_out) API returns a pointer to the message
buffer in the packet created.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct hapi_custom_msg_req *req;</p>
<p>struct hapi_packet *pkt_out =</p>
<p>hapi_pkt_msg_alloc(hapi, HIO_GROUP_CUSTOM, HAPI_CUSTOM_MSG_REQ,
sizeof(struct hapi_custom_msg_req), 0);</p>
<p>req = hapi_pkt_msg(pkt_out);</p>
<p>/* update req fields */</p>
<p>memcpy(req-&gt;echo_req, msg, sizeof(req-&gt;echo_req));</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The data to be sent by the host (in the msg buffer in this example) is
copied to the request message buffer. Now, the packet to be sent to
Talaria TWO is ready. The packet contains the following fields:</p>
<p><a class="reference internal" href="../../../../_images/image323.png"><img alt="A picture containing histogram Description automatically generated" src="../../../../_images/image323.png" style="width: 5.90551in; height: 1.21448in;" /></a></p>
<p>Figure 9: Packet contents</p>
<p>The host sends a message: “Hello from host”.</p>
<p>The length of the packet is: sum of size of Payload+TRX ID+MSG ID+GROUP
ID.</p>
<p>This packet will be sent to Talaria TWO by the HIO transport layer. The
application calls the hapi_send_recv_validate() API to send the packet
(i.e., pkt_out) and blocks until a response is received from Talaria
TWO.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct hapi_packet *pkt_in =</p>
<p>hapi_send_recv_validate(hapi, pkt_out, HIO_GROUP_CUSTOM,
HAPI_CUSTOM_MSG_RSP);</p>
<p>if (pkt_in == NULL) {</p>
<p>/* Unexpected behaviour */</p>
<p>printf(“%s failed.\n”, __FUNCTION__);</p>
<p>goto end;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>On receiving the response packet from Talaria TWO,
hapi_send_recv_validate()will return the pointer to the received
response packet.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct hapi_custom_msg_rsp *rsp = hapi_pkt_msg(pkt_in);</p>
<p>if (rsp-&gt;status != 0) {</p>
<p>/* Unexpected behaviour */</p>
<p>printf(“%s status failed.\n”, __FUNCTION__);</p>
<p>goto end;</p>
<p>}</p>
<p>ok = true;</p>
<p>printf(“recieved :%s-%d\r\n”,rsp-&gt;echo_rsp,test);</p>
<p>memcpy(rsp-&gt;echo_rsp,resp_msg , sizeof(req-&gt;echo_req));</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<p>The contents of the message buffer of the received packet are copied
into a buffer for the application to process it.</p>
</section>
<section id="procedure-to-add-custom-group-to-host-application">
<h2>Procedure to Add Custom Group to Host Application.<a class="headerlink" href="#procedure-to-add-custom-group-to-host-application" title="Permalink to this heading"></a></h2>
<p>The SMP application includes the same GROUP ID, MSG ID and the
structures of request and response message used by the HAPI-based host
application.</p>
<ol class="arabic simple">
<li><p>Create a header file – custom_group.h and include the same custom
GROUP ID -158, MSGIDs for the custom request message-0x03, custom
response message-0x83 and the structures for the custom request
message and custom response message.</p></li>
<li><p>Define a handler to receive a request packet from the host and send a
response packet.</p></li>
<li><p>Define a HIO interface API of type struct hio_api and provide the
GROUP ID, number of the handlers to be registered and the pointer to
the handler to be called when a request message with the
corresponding GROUP ID and MSGID is received. Following is the
definition of struct hio_api:</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>struct hio_api {</p>
<p>uint16_t group;</p>
<p>uint16_t num_handlers;</p>
<p>struct packet *(*const handler[])(void *ctx, struct packet *pkt);</p>
<p>};</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<blockquote>
<div><p>Refer document: Talaria_TWO_Host_API_Reference_Guide.pdf (path:
<em>sdk_x.y\doc\reference_guides\api_reference_guide</em>) for more
information on struct hio_api.</p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Register the custom group by calling the hio_api_init(const struct
hio_api *api, void *ctx) API.</p></li>
<li><p>Following the procedure described above, the custom_group.h header
file contains the GROUP ID, MSG ID, and the structure definitions of
the request and response messages. These definitions are same as the
ones defined in api/custom_group.h file in HAPI-based host
application.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>#define HIO_GROUP_CUSTOM 158</p>
<p>#define HAPI_CUSTOM_MSG_REQ 0x03</p>
<p>#define HAPI_CUSTOM_MSG_RSP 0x83</p>
<p>struct hapi_custom_msg_req {</p>
<p>char echo_req[MAX_MSG_SIZE]; /*Request message from host*/</p>
<p>};</p>
<p>struct hapi_custom_msg_rsp {</p>
<p>uint32_t status; /**&lt; result status, zero is success */</p>
<p>char echo_rsp[MAX_MSG_SIZE]; /**&lt; response from T2 */</p>
<p>};</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="6">
<li><p>The required functions to register the custom group and the handlers
are defined in custom_group.c.</p></li>
</ol>
<blockquote>
<div><p>custom_data_send_recieve handler receives request packet, extracts
the content of the packet, and sends a response packet.</p>
</div></blockquote>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static struct packet *custom_data_send_recieve(void *ctx, struct
packet *msg)</p>
<p>{</p>
<p>struct hapi_custom_msg_req *req = packet_data(msg);</p>
<p>os_printf(“host sent:%s\r\n”,req-&gt;echo_req);</p>
<p>return custom_send_resp();</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="7">
<li><p>custom_send resp() function creates a response packet, copies the
payload to be included in the response packet and returns a pointer
of type struct packet.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static struct packet* custom_send_resp(void)</p>
<p>{</p>
<p>char t2_rsp[64] = “Resp from T2”;</p>
<p>struct packet *pkt;</p>
<p>struct hapi_custom_msg_rsp *rsp;</p>
<p>pkt = OS_ERROR_ON_NULL(alloc_custom_data_rsp(&amp;rsp));</p>
<p>rsp-&gt;status = 0;</p>
<p>memcpy(rsp-&gt;echo_rsp, t2_rsp,sizeof(t2_rsp));</p>
<p>return pkt;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="8">
<li><p>alloc_custom_data_rsp() function creates a packet by allocating
memory for the response packet to be sent. The payload – “Resp from
Talaria TWO” is copied to the message buffer of the packet created
and the pointer to the created packet is returned by this function.</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>static inline struct packet * alloc_custom_data_rsp(struct
hapi_custom_msg_rsp **rsp)</p>
<p>{</p>
<p>struct packet *pkt = packet_alloc(sizeof(struct hio_msghdr) + sizeof
**rsp);</p>
<p>if (pkt) {</p>
<p>pfrag_reserve(packet_first_frag(pkt), sizeof(struct hio_msghdr));</p>
<p>*rsp = packet_insert_tail(pkt, sizeof **rsp);</p>
<p>}</p>
<p>return pkt;</p>
<p>}</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="9">
<li><p>pfrag_reserve() API returns the data and the address of head of the
linked list in which the packet is included. packet_insert_tail
returns the data and address of the tail node in the list. The
address of the packet created is returned. custom_send_resp()
function copies the response message payload and returns the packet.</p></li>
</ol>
<blockquote>
<div><p>This packet is sent to the host by the custom_data_send_recieve()
handler. The host now receives the response packet from Talaria TWO.</p>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../4.%20Host%20Application/Host%20Application.html" class="btn btn-neutral float-left" title="Host Application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../3.%20Dual-Stack/Dual-Stack%20-%20Landing%20Page.html" class="btn btn-neutral float-right" title="Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023 InnoPhase IoT, Inc. | All Rights Reserved | Proprietary &amp; Confidential.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>